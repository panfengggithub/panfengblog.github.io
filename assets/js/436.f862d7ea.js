(window.webpackJsonp=window.webpackJsonp||[]).push([[436],{852:function(e,_,t){"use strict";t.r(_);var r=t(1),v=Object(r.a)({},(function(){var e=this,_=e._self._c;return _("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[_("h1",{attrs:{id:"秒杀系统减库存以及防刷限流实战"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#秒杀系统减库存以及防刷限流实战"}},[e._v("#")]),e._v(" "),_("strong",[e._v("秒杀系统减库存以及防刷限流实战")])]),e._v(" "),_("h1",{attrs:{id:"_1-同步下单"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_1-同步下单"}},[e._v("#")]),e._v(" 1.同步下单")]),e._v(" "),_("p",[e._v("优点： 方案简单，在连接不多的情况响应迅速")]),e._v(" "),_("p",[e._v("缺点： 随着请求连接增多，DB性能急剧下降，导致大量请求阻塞，整个服务集群无法正常提供服务。")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442069-2a6e76f1-0a02-4e71-a54d-cdd5c2ed9468.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_36%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_2-rocketmq异步下单"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-rocketmq异步下单"}},[e._v("#")]),e._v(" 2.RocketMQ异步下单")]),e._v(" "),_("p",[e._v("RocketMQ架构图")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442036-097ad1fd-fa14-48ef-a81c-e2fd6a3e977f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_38%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[e._v("MQ消息队列处理订单：")]),e._v(" "),_("p",[e._v("异步：可以处理更多订单")]),e._v(" "),_("p",[e._v("削峰：更高吞吐能力和消息堆积能力")]),e._v(" "),_("p",[e._v("=》在处理高并发请求时性能和吞吐量更高")]),e._v(" "),_("p",[e._v("异步下单流程：")]),e._v(" "),_("ul",[_("li",[_("p",[e._v("业务类构建订单DTO")])]),e._v(" "),_("li",[_("p",[e._v("消息生产者发送消息返回创建订单中")])]),e._v(" "),_("li",[_("p",[e._v("客户端轮训订单状态")])]),e._v(" "),_("li",[_("p",[e._v("消费消费者 消费订单消息，生成订单，修改订单状态")])]),e._v(" "),_("li",[_("p",[e._v("下单完成")])])]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225443018-ae79c8e3-7174-43d3-b8e3-34ac124ee062.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_42%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_2-1-mq生产者"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-mq生产者"}},[e._v("#")]),e._v(" 2.1 MQ生产者")]),e._v(" "),_("p",[_("strong",[e._v("生产者发送消息")])]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v("@Component")]),e._v(" "),_("p",[e._v("public class OrderMessageSender {")]),e._v(" "),_("p",[e._v(".......")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* 发送订单消息")]),e._v(" "),_("p",[e._v("* @return")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("public boolean sendCreateOrderMsg(OrderMessage message){")]),e._v(" "),_("p",[e._v('SendResult result = rocketMQTemplate.syncSend(asyncOrderTopic+":"+ORDERTAG,message);')]),e._v(" "),_("p",[e._v("return SendStatus.SEND_OK == result.getSendStatus();")]),e._v(" "),_("p",[_("strong",[e._v("业务发送订单处理")])]),e._v(" "),_("ul",[_("li",[_("strong",[e._v("发送消息")])]),e._v(" "),_("li",[_("strong",[e._v("发送成功=》设置 订单状态 ： 1-》下单中   -1-》失败   大于1->订 单号")])]),e._v(" "),_("li",[_("strong",[e._v("发送失败 =》还原预减库存，删除本地 售罄标识，发送消息同步标****识")])])]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v("@Service")]),e._v(" "),_("p",[e._v("public class SecKillOrderServiceImpl implements SecKillOrderService {")]),e._v(" "),_("p",[e._v("..............")]),e._v(" "),_("p",[e._v("OrderMessage orderMessage = new OrderMessage();")]),e._v(" "),_("p",[e._v("orderMessage.setOrder(order);")]),e._v(" "),_("p",[e._v("orderMessage.setOrderItem(orderItem);")]),e._v(" "),_("p",[e._v("orderMessage.setFlashPromotionRelationId(product.getFlashPromotionRelationId());")]),e._v(" "),_("p",[e._v("orderMessage.setFlashPromotionLimit(product.getFlashPromotionLimit());")]),e._v(" "),_("p",[e._v("orderMessage.setFlashPromotionEndDate(product.getFlashPromotionEndDate());")]),e._v(" "),_("p",[e._v("Map<String,Object> result = new HashMap<>();")]),e._v(" "),_("p",[e._v("List"),_("OmsOrderItem",[e._v(" itemList = new ArrayList<>();")])],1),e._v(" "),_("p",[e._v("itemList.add(orderItem);")]),e._v(" "),_("p",[e._v('result.put("order",order);')]),e._v(" "),_("p",[e._v('result.put("orderItemList",itemList);')]),e._v(" "),_("p",[e._v("try {")]),e._v(" "),_("p",[e._v("boolean sendStatus = orderMessageSender.sendCreateOrderMsg(orderMessage);")]),e._v(" "),_("p",[e._v("if(sendStatus){")]),e._v(" "),_("p",[e._v("​    /*")]),e._v(" "),_("p",[e._v("​     * 打上排队的标记")]),e._v(" "),_("p",[e._v("​     */")]),e._v(" "),_("p",[e._v('​    redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_ASYNC_WAITING_PREFIX + memberId + ":" + productId')]),e._v(" "),_("p",[e._v("​        ,Integer.toString(1),60, TimeUnit.SECONDS);")]),e._v(" "),_("p",[e._v("​    /*")]),e._v(" "),_("p",[e._v("​     * 下单方式0->同步下单,1->异步下单排队中,-1->秒杀失败")]),e._v(" "),_("p",[e._v("​     */")]),e._v(" "),_("p",[e._v('​    result.put("orderStatus",1);')]),e._v(" "),_("p",[e._v("}else{")]),e._v(" "),_("p",[e._v("​    /*")]),e._v(" "),_("p",[e._v("​     * 还原预减库存")]),e._v(" "),_("p",[e._v("​     */")]),e._v(" "),_("p",[e._v("​    incrRedisStock(productId);")]),e._v(" "),_("p",[e._v("​    /*")]),e._v(" "),_("p",[e._v("​     * 清除掉本地guavacache已经售完的标记")]),e._v(" "),_("p",[e._v("​     */")]),e._v(" "),_("p",[e._v("​    cache.remove(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),e._v(" "),_("p",[e._v("​    //通知服务群,清除本地售罄标记缓存")]),e._v(" "),_("p",[e._v("​    if(shouldPublishCleanMsg(productId)){")]),e._v(" "),_("p",[e._v('​      redisOpsUtil.publish("cleanNoStockCache",productId);')]),e._v(" "),_("p",[e._v("​    }")]),e._v(" "),_("p",[e._v('​    result.put("orderStatus",-1);')]),e._v(" "),_("p",[e._v('​    return CommonResult.failed(result,"下单失败");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("} catch (Exception e) {")]),e._v(" "),_("p",[e._v('log.error("消息发送失败:error msg:{}",e.getMessage(),e.getCause());')]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* 还原预减库存")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("incrRedisStock(productId);")]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* 清除掉本地guavacache已经售完的标记")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("cache.remove(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),e._v(" "),_("p",[e._v("//通知服务群,清除本地售罄标记缓存")]),e._v(" "),_("p",[e._v("if(shouldPublishCleanMsg(productId)) {")]),e._v(" "),_("p",[e._v('​    redisOpsUtil.publish("cleanNoStockCache", productId);')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v('result.put("orderStatus",-1);')]),e._v(" "),_("p",[e._v('return CommonResult.failed(result,"下单失败");')]),e._v(" "),_("h2",{attrs:{id:"_2-1-消息消费创建订单"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-消息消费创建订单"}},[e._v("#")]),e._v(" 2.1  消息消费创建订单")]),e._v(" "),_("p",[e._v("创建消息消费者")]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v("@Component")]),e._v(" "),_("p",[e._v('@RocketMQMessageListener(topic = "${rocketmq.luban.asyncOrderTopic}",consumerGroup = "${rocketmq.luban.asyncOrderGroup}")')]),e._v(" "),_("p",[e._v("public class AscynCreateOrderReciever implements RocketMQListener"),_("OrderMessage",[e._v(" {")])],1),e._v(" "),_("p",[e._v("消费消息")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* 异步下单消费消息")]),e._v(" "),_("p",[e._v("* @param orderMessage")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("@Override")]),e._v(" "),_("p",[e._v("public void onMessage(OrderMessage orderMessage) {")]),e._v(" "),_("p",[e._v('log.info("listen the rocketmq message");')]),e._v(" "),_("p",[e._v("Long memberId = orderMessage.getOrder().getMemberId();")]),e._v(" "),_("p",[e._v("Long productId = orderMessage.getOrderItem().getProductId();")]),e._v(" "),_("p",[e._v("//订单编号,分库分表不用该编号做订单结果标记")]),e._v(" "),_("p",[e._v("String orderSn = orderMessage.getOrder().getOrderSn();")]),e._v(" "),_("p",[e._v("Integer limit = orderMessage.getFlashPromotionLimit();")]),e._v(" "),_("p",[e._v("Date endDate = orderMessage.getFlashPromotionEndDate();")]),e._v(" "),_("p",[e._v("try {")]),e._v(" "),_("p",[e._v("​    Long orderId = secKillOrderService.asyncCreateOrder(orderMessage.getOrder(),orderMessage.getOrderItem(),orderMessage.getFlashPromotionRelationId());")]),e._v(" "),_("p",[e._v("​    //更改排队标记状态,代表已经下单成功,ID设置为snowflake后,用ID作为状态标记")]),e._v(" "),_("p",[e._v("​    redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_ASYNC_WAITING_PREFIX + memberId")]),e._v(" "),_("p",[e._v('​        + ":" + productId,orderId.toString(),60L, TimeUnit.SECONDS);')]),e._v(" "),_("p",[e._v("​    /*")]),e._v(" "),_("p",[e._v("​     * 设置用户购买次数,(不限制购买次数了,需要可自行放开此处,")]),e._v(" "),_("p",[e._v("​     * 并在secKillOrderService.checkConfirm中加入验证)")]),e._v(" "),_("p",[e._v("​     */")]),e._v(" "),_("p",[e._v('​    /*Integer rebuy = redisOpsUtil.get(RedisKeyPrefixConst.MEMBER_BUYED_MIAOSHA_PREFIX + memberId + ":" + productId,Integer.class);')]),e._v(" "),_("p",[e._v("​    if(rebuy != null){")]),e._v(" "),_("p",[e._v('​      redisOpsUtil.decr(RedisKeyPrefixConst.MEMBER_BUYED_MIAOSHA_PREFIX + memberId + ":" + productId);')]),e._v(" "),_("p",[e._v("​    }else{")]),e._v(" "),_("p",[e._v("​      //剩余时间")]),e._v(" "),_("p",[e._v("​      Date now = new Date();")]),e._v(" "),_("p",[e._v("​      Long expired = endDate.getTime()-now.getTime();")]),e._v(" "),_("p",[e._v("​      //打上购买次数标记")]),e._v(" "),_("p",[e._v('​      redisOpsUtil.set(RedisKeyPrefixConst.MEMBER_BUYED_MIAOSHA_PREFIX + memberId + ":" + productId,limit-1')]),e._v(" "),_("p",[e._v("​          ,expired,TimeUnit.MILLISECONDS);")]),e._v(" "),_("p",[e._v("​    }*/")]),e._v(" "),_("p",[e._v("} catch (Exception e) {")]),e._v(" "),_("p",[e._v("​    log.error(e.getMessage(),e.getCause());")]),e._v(" "),_("p",[e._v("​    /*")]),e._v(" "),_("p",[e._v("​     * 下单失败")]),e._v(" "),_("p",[e._v("​     */")]),e._v(" "),_("p",[e._v("​    redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_ASYNC_WAITING_PREFIX + memberId")]),e._v(" "),_("p",[e._v('​        + ":" + productId,Integer.toString(-1),60L, TimeUnit.SECONDS);')]),e._v(" "),_("p",[e._v("​    //还原预减库存")]),e._v(" "),_("p",[e._v("​    secKillOrderService.incrRedisStock(productId);")]),e._v(" "),_("p",[e._v("​    //清除掉本地guava-cache已经售完的标记")]),e._v(" "),_("p",[e._v("​    cache.remove(RedisKeyPrefixConst.MIAOSHA_STOCK_CACHE_PREFIX + productId);")]),e._v(" "),_("p",[e._v("​    //通知服务群,清除本地售罄标记缓存")]),e._v(" "),_("p",[e._v("​    if(secKillOrderService.shouldPublishCleanMsg(productId)) {")]),e._v(" "),_("p",[e._v('​      redisOpsUtil.publish("cleanNoStockCache", productId);')]),e._v(" "),_("p",[e._v("​    }")]),e._v(" "),_("p",[e._v("关于消费消息异常：")]),e._v(" "),_("ol",[_("li",[e._v("消费者在未提交订单到db之前异常，需要回补库存。")]),e._v(" "),_("li",[e._v("消费者在消费消息并且未提交订单到db之前，JVM崩溃。 服务器未收到消费者ACK，继续投递。")]),e._v(" "),_("li",[e._v("消费者提交订单之后JVM崩溃，服务器未收到消费者ACK。消息会继续投递，此时需要校验消息的幂等性。")])]),e._v(" "),_("p",[e._v("​       消息ID的全局唯一性")]),e._v(" "),_("p",[e._v("​       消息在消费消息时首先判断消息ID是否已经存在DB，存在的时候直接返回成功，否则继续创建订单操作。")]),e._v(" "),_("h2",{attrs:{id:"_2-2-订单成功发送延迟消息等待支付"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-订单成功发送延迟消息等待支付"}},[e._v("#")]),e._v(" 2.2  订单成功发送延迟消息等待支付")]),e._v(" "),_("p",[e._v("延迟消息 ： messageDelayLevel=1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h")]),e._v(" "),_("p",[e._v("@Transactional")]),e._v(" "),_("p",[e._v("public Long asyncCreateOrder(OmsOrder order,OmsOrderItem orderItem,Long flashPromotionRelationId) {")]),e._v(" "),_("p",[e._v("//减库存")]),e._v(" "),_("p",[e._v("Integer result = miaoShaStockDao.descStock(flashPromotionRelationId, 1);")]),e._v(" "),_("p",[e._v('log.info("异步下单减库存成功");')]),e._v(" "),_("p",[e._v("if (result <= 0) {")]),e._v(" "),_("p",[e._v('​    throw new RuntimeException("没抢到！");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v('log.info("异步下单减库存成功");')]),e._v(" "),_("p",[e._v("//查询订单")]),e._v(" "),_("p",[e._v("//插入订单记录")]),e._v(" "),_("p",[e._v("orderMapper.insertSelective(order);")]),e._v(" "),_("p",[e._v("//OrderItem关联")]),e._v(" "),_("p",[e._v("orderItem.setOrderId(order.getId());")]),e._v(" "),_("p",[e._v("orderItem.setOrderSn(order.getOrderSn());")]),e._v(" "),_("p",[e._v("//插入orderItem")]),e._v(" "),_("p",[e._v("orderItemMapper.insertSelective(orderItem);")]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* 如果订单创建成功,需要发送定时消息,20min后如果没有支付,则取消当前订单,释放库存")]),e._v(" "),_("p",[e._v("* 0")]),e._v(" "),_("p",[e._v("* */")]),e._v(" "),_("p",[e._v("try {")]),e._v(" "),_("p",[e._v('​    boolean sendStatus = orderMessageSender.sendTimeOutOrderMessage(order.getId() + ":" + flashPromotionRelationId + ":" + orderItem.getProductId());')]),e._v(" "),_("p",[e._v("​    if (!sendStatus) {")]),e._v(" "),_("p",[e._v('​      throw new RuntimeException("订单超时取消消息发送失败！");')]),e._v(" "),_("p",[e._v("​    }")]),e._v(" "),_("p",[e._v("} catch (Exception e) {")]),e._v(" "),_("p",[e._v('​    throw new RuntimeException("订单超时取消消息发送失败！");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("return order.getId();")]),e._v(" "),_("h2",{attrs:{id:"_2-3-超时取消订单"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-超时取消订单"}},[e._v("#")]),e._v(" 2.3 超时取消订单")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* 消费监听rocketmq-订单超时消息")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v("@Component")]),e._v(" "),_("p",[e._v('@RocketMQMessageListener(consumerGroup = "${rocketmq.luban.cancelGroup}", topic = "${rocketmq.luban.scheduleTopic}")')]),e._v(" "),_("p",[e._v("public class RocketMqCancelOrderReciever implements RocketMQListener"),_("String",[e._v(" {")])],1),e._v(" "),_("p",[e._v("@Autowired")]),e._v(" "),_("p",[e._v("private OmsPortalOrderService omsPortalOrderService;")]),e._v(" "),_("p",[e._v("@Autowired")]),e._v(" "),_("p",[e._v("private SecKillOrderService secKillOrderService;")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* 延时消息,取消超时订单")]),e._v(" "),_("p",[e._v("* @param cancelId")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("@Override")]),e._v(" "),_("p",[e._v("public void onMessage(String cancelId) {")]),e._v(" "),_("p",[e._v('​    log.info("监听超时订单："+cancelId);')]),e._v(" "),_("p",[e._v("​    if(StringUtils.isEmpty(cancelId)){")]),e._v(" "),_("p",[e._v("​      return;")]),e._v(" "),_("p",[e._v("​    }")]),e._v(" "),_("p",[e._v('​    Long orderId = Long.parseLong(cancelId.split("😊[0]);')]),e._v(" "),_("p",[e._v('​    Long promotionId = Long.parseLong(cancelId.split("😊[1]);')]),e._v(" "),_("p",[e._v('​    Long productId = Long.parseLong(cancelId.split("😊[2]);')]),e._v(" "),_("p",[e._v("​    try {")]),e._v(" "),_("p",[e._v("​      //取消的订单,释放DB库存")]),e._v(" "),_("p",[e._v("​      omsPortalOrderService.cancelOrder(orderId,promotionId);")]),e._v(" "),_("p",[e._v("​      //取消的订单-还原缓存库存")]),e._v(" "),_("p",[e._v("​      secKillOrderService.incrRedisStock(productId);")]),e._v(" "),_("p",[e._v('​      log.info("订单取消，orderId:{},productId:{}",orderId,productId);')]),e._v(" "),_("p",[e._v("​    } catch (Exception e) {")]),e._v(" "),_("p",[e._v('​      log.error("订单取消异常 : 还原库存失败，please check:{}",e.getMessage(),e.getCause());')]),e._v(" "),_("p",[e._v("​      throw new RuntimeException();//抛异常出去,rocketmq会重新投递")]),e._v(" "),_("p",[e._v("​    }")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("ol",[_("li",[e._v("MQ事务消息")])]),e._v(" "),_("p",[e._v("RocketMQ事务消息架构：")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442002-57060036-ee99-4a09-b972-b4b72ba300b7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_38%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("strong",[e._v("业务场景： 一般适用下单成功后删除购物车 ，计算积分")])]),e._v(" "),_("p",[e._v("@Slf4j")]),e._v(" "),_("p",[e._v('@RocketMQTransactionListener(txProducerGroup = "${rocketmq.luban.transGroup}")')]),e._v(" "),_("p",[e._v("public class TransactionListenerImpl implements RocketMQLocalTransactionListener {")]),e._v(" "),_("p",[e._v("private ConcurrentHashMap<String, Integer> localTrans = new ConcurrentHashMap<String, Integer>();")]),e._v(" "),_("p",[e._v("private static int maxTryMums = 3;")]),e._v(" "),_("p",[e._v("@Override")]),e._v(" "),_("p",[e._v("public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object orderDto) {")]),e._v(" "),_("p",[e._v('​    log.info("------------RocketMQ执行本地订单创建-------------");')]),e._v(" "),_("p",[e._v("​    String transId = (String)msg.getHeaders().get(RocketMQHeaders.PREFIX + RocketMQHeaders.TRANSACTION_ID);")]),e._v(" "),_("p",[e._v("​    /**")]),e._v(" "),_("p",[e._v("​     *")]),e._v(" "),_("p",[e._v("​     * 写你的本地事务执行逻辑")]),e._v(" "),_("p",[e._v("​     *")]),e._v(" "),_("p",[e._v("​     * */")]),e._v(" "),_("p",[e._v("​    //删除购物车  计算订单积分")]),e._v(" "),_("p",[e._v("​    localTrans.put(transId, 0);")]),e._v(" "),_("p",[e._v("​    return RocketMQLocalTransactionState.UNKNOWN;")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("@Override")]),e._v(" "),_("p",[e._v("public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {")]),e._v(" "),_("p",[e._v('​    log.info("执行事务消息checkLocalTransaction()方法");')]),e._v(" "),_("p",[e._v("​    RocketMQLocalTransactionState retState;")]),e._v(" "),_("p",[e._v("​    String transId = (String)msg.getHeaders().get(RocketMQHeaders.PREFIX + RocketMQHeaders.TRANSACTION_ID);")]),e._v(" "),_("p",[e._v("​     //查询 购物车是否删除成功")]),e._v(" "),_("p",[e._v("​    //查询积分计算是否成功")]),e._v(" "),_("p",[e._v("​    int retryTimes = localTrans.get(transId);//事务recheck次数")]),e._v(" "),_("p",[e._v("​    int isExists = 0;//订单是否已经生成")]),e._v(" "),_("p",[e._v("​    if(retryTimes < maxTryMums && isExists > 0){")]),e._v(" "),_("p",[e._v("​      retState = RocketMQLocalTransactionState.COMMIT;")]),e._v(" "),_("p",[e._v("​      localTrans.remove(transId);")]),e._v(" "),_("p",[e._v("​    }else if(retryTimes < maxTryMums && isExists == 0){")]),e._v(" "),_("p",[e._v("​      localTrans.put(transId,retryTimes+1);")]),e._v(" "),_("p",[e._v("​      retState = RocketMQLocalTransactionState.UNKNOWN;")]),e._v(" "),_("p",[e._v("​    }else{")]),e._v(" "),_("p",[e._v("​      retState = RocketMQLocalTransactionState.ROLLBACK;")]),e._v(" "),_("p",[e._v("​      localTrans.remove(transId);")]),e._v(" "),_("p",[e._v("​    }")]),e._v(" "),_("p",[e._v('​    log.info("------ !!!回查订单是否成功提交,msgTransactionId={}, TransactionState={} status={}", transId, retState, retryTimes);')]),e._v(" "),_("p",[e._v("​    return retState;")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("static class MessageConvertHelper extends MappingJackson2MessageConverter {")]),e._v(" "),_("p",[e._v("​    private final static MessageConvertHelper converter;")]),e._v(" "),_("p",[e._v("​    static{")]),e._v(" "),_("p",[e._v("​      converter = new MessageConvertHelper();")]),e._v(" "),_("p",[e._v("​    }")]),e._v(" "),_("p",[e._v("​    public static Object convert(Message<?> message, Class<?> targetClass){")]),e._v(" "),_("p",[e._v("​      return converter.convertFromInternal(message,targetClass,null);")]),e._v(" "),_("p",[e._v("​    }")]),e._v(" "),_("ol",[_("li",[e._v("秒杀系统的压测")])]),e._v(" "),_("h2",{attrs:{id:"_4-1-批量生成用户账户信息"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-批量生成用户账户信息"}},[e._v("#")]),e._v(" 4.1 批量生成用户账户信息")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442036-14539484-8ce2-49dd-9b77-e1d74ad5113a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442078-08f1809b-0011-4564-b9b0-2db12da43f21.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_51%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-2-批量生成jwt-token"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-批量生成jwt-token"}},[e._v("#")]),e._v(" 4.2 批量生成JWT token")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442030-7c9f2e53-5976-418b-93a0-6c1d1ff03f49.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_52%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442074-c3760f41-d53b-4e4a-82e9-f2d747e852c3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442210-81862fa7-551b-4ec9-a020-602e9061ce7c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_35%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442040-49c32116-4e8b-4387-994e-e0f65d0ef922.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_53%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-3-jmeter设置config-data"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-jmeter设置config-data"}},[e._v("#")]),e._v(" 4.3 Jmeter设置config Data")]),e._v(" "),_("p",[e._v("设置jwt token变量名：Authorization")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442140-4e784215-02c4-45d8-8661-6b890c7ba197.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_50%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-4-设置请求head"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-设置请求head"}},[e._v("#")]),e._v(" 4.4 设置请求head")]),e._v(" "),_("p",[e._v("设置请求头")]),e._v(" "),_("p",[e._v("Authorization： ${Authorization}")]),e._v(" "),_("p",[e._v("Content-Type：application/json")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442172-d20b9d41-1b3d-42e7-8aee-5b4a5b826cbb.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_49%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-5-设置并发请求数"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-设置并发请求数"}},[e._v("#")]),e._v(" 4.5 设置并发请求数")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442066-d28b7cc2-af59-4a71-9587-0c62e18d36d5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_39%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:""}},[_("a",{staticClass:"header-anchor",attrs:{href:"#"}},[e._v("#")])]),e._v(" "),_("h2",{attrs:{id:"_4-6-设置请求报文体"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-设置请求报文体"}},[e._v("#")]),e._v(" 4.6 设置请求报文体")]),e._v(" "),_("p",[e._v("请求URL : http://localhost:8888/order/secKill/generateOrder")]),e._v(" "),_("p",[e._v("方法类型： post")]),e._v(" "),_("p",[e._v("报文体： {")]),e._v(" "),_("p",[e._v('"itemIds": [')]),e._v(" "),_("p",[e._v("27")]),e._v(" "),_("p",[e._v("],")]),e._v(" "),_("p",[e._v('"memberReceiveAddressId": 1,')]),e._v(" "),_("p",[e._v('"payType": 1,')]),e._v(" "),_("p",[e._v('"couponId":2,')]),e._v(" "),_("p",[e._v('"useIntegration": 100')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442063-19359122-01c4-4195-8fdc-c22758d41f64.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_40%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h1",{attrs:{id:"-2"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#-2"}},[e._v("#")])]),e._v(" "),_("h2",{attrs:{id:"_4-7-清理redis缓存"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-7-清理redis缓存"}},[e._v("#")]),e._v(" 4.7 清理redis缓存")]),e._v(" "),_("p",[e._v("> flushdb")]),e._v(" "),_("h1",{attrs:{id:"-3"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#-3"}},[e._v("#")])]),e._v(" "),_("h2",{attrs:{id:"_4-8-服务启动"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-服务启动"}},[e._v("#")]),e._v(" 4.8  服务启动")]),e._v(" "),_("p",[e._v("先后启动 luban-auth  ,luban-gateway,luban-member,luban-product,luban-order.")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442210-9eb257e8-1cd2-42b7-96b3-68c2b3ec7397.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_51%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_4-9-开启压测"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_4-9-开启压测"}},[e._v("#")]),e._v(" 4.9 开启压测")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442073-e360750c-c5bd-495a-ae68-86fa0f93bad7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_53%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("ol",[_("li",[e._v("秒杀验证码流程")])]),e._v(" "),_("h2",{attrs:{id:"_5-1-生成验证码"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-生成验证码"}},[e._v("#")]),e._v(" 5.1 生成验证码")]),e._v(" "),_("h3",{attrs:{id:"_5-1-1-创建验证码"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-1-创建验证码"}},[e._v("#")]),e._v(" 5.1.1 创建验证码")]),e._v(" "),_("p",[e._v("/**")]),e._v(" "),_("p",[e._v("* 创建验证码")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("public static VerifyCodeInfo createVerifyCode() {")]),e._v(" "),_("p",[e._v("int width = 80;")]),e._v(" "),_("p",[e._v("int height = 32;")]),e._v(" "),_("p",[e._v("//create the image")]),e._v(" "),_("p",[e._v("BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);")]),e._v(" "),_("p",[e._v("Graphics g = image.getGraphics();")]),e._v(" "),_("p",[e._v("// set the background color")]),e._v(" "),_("p",[e._v("g.setColor(new Color(0xDCDCDC));")]),e._v(" "),_("p",[e._v("g.fillRect(0, 0, width, height);")]),e._v(" "),_("p",[e._v("// draw the border")]),e._v(" "),_("p",[e._v("g.setColor(Color.black);")]),e._v(" "),_("p",[e._v("g.drawRect(0, 0, width - 1, height - 1);")]),e._v(" "),_("p",[e._v("// create a random instance to generate the codes")]),e._v(" "),_("p",[e._v("Random rdm = new Random();")]),e._v(" "),_("p",[e._v("// make some confusion")]),e._v(" "),_("p",[e._v("for (int i = 0; i < 50; i++) {")]),e._v(" "),_("p",[e._v("​    int x = rdm.nextInt(width);")]),e._v(" "),_("p",[e._v("​    int y = rdm.nextInt(height);")]),e._v(" "),_("p",[e._v("​    g.drawOval(x, y, 0, 0);")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("// generate a random code")]),e._v(" "),_("p",[e._v("String verifyCode = generateVerifyCode(rdm);")]),e._v(" "),_("p",[e._v("g.setColor(new Color(0, 100, 0));")]),e._v(" "),_("p",[e._v('g.setFont(new Font("Candara", Font.BOLD, 24));')]),e._v(" "),_("p",[e._v("g.drawString(verifyCode, 8, 24);")]),e._v(" "),_("p",[e._v("g.dispose();")]),e._v(" "),_("p",[e._v("//把验证码存到redis中")]),e._v(" "),_("p",[e._v("Integer result = calc(verifyCode);")]),e._v(" "),_("p",[e._v("if (result == null) {")]),e._v(" "),_("p",[e._v("​    return null;")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("//输出结果")]),e._v(" "),_("p",[e._v("return new VerifyCodeInfo(image,result);")]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("h3",{attrs:{id:"_5-1-2-验证码答案存储在redis"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-2-验证码答案存储在redis"}},[e._v("#")]),e._v(" 5.1.2 验证码答案存储在redis")]),e._v(" "),_("p",[e._v('@RequestMapping(value="/verifyCode", method=RequestMethod.GET)')]),e._v(" "),_("p",[e._v("@ResponseBody")]),e._v(" "),_("p",[e._v("public CommonResult getVerifyCode(HttpServletRequest request,")]),e._v(" "),_("p",[e._v("​                 HttpServletResponse response,")]),e._v(" "),_("p",[e._v('​                 @RequestParam("productId") Long productId,')]),e._v(" "),_("p",[e._v('​                 @RequestHeader("memberId") Long memberId){')]),e._v(" "),_("p",[e._v("try {")]),e._v(" "),_("p",[e._v("​    VerifyCodeImgUtil.VerifyCodeInfo imageInfo = VerifyCodeImgUtil.createVerifyCode();")]),e._v(" "),_("p",[e._v('​    log.info("验证码答案:{}",imageInfo.getResult());')]),e._v(" "),_("p",[e._v("​    //todo 验证码答案写入到redis")]),e._v(" "),_("p",[e._v('​    redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_VERIFY_CODE_PREFIX + memberId + ":" + productId //全局唯一ID')]),e._v(" "),_("p",[e._v("​        ,imageInfo.getResult()")]),e._v(" "),_("p",[e._v("​        ,300")]),e._v(" "),_("p",[e._v("​        ,TimeUnit.SECONDS);")]),e._v(" "),_("p",[e._v('​    response.setHeader("Content-Type", "image/jpeg");')]),e._v(" "),_("p",[e._v("​    OutputStream out = response.getOutputStream();")]),e._v(" "),_("p",[e._v('​    ImageIO.write(imageInfo.getBufferedImage(), "JPEG", out);')]),e._v(" "),_("p",[e._v("​    out.flush();")]),e._v(" "),_("p",[e._v("​    out.close();")]),e._v(" "),_("p",[e._v("​    return null;")]),e._v(" "),_("p",[e._v("​    /**")]),e._v(" "),_("p",[e._v("​     * 返回图片的base64编码,js解码成图片")]),e._v(" "),_("p",[e._v("​     */")]),e._v(" "),_("p",[e._v("​    /*ByteArrayOutputStream baos = new ByteArrayOutputStream();//io流")]),e._v(" "),_("p",[e._v('​    ImageIO.write(imageInfo.getBufferedImage(), "png", baos);//写入流中')]),e._v(" "),_("p",[e._v("​    byte[] bytes = baos.toByteArray();//转换成字节")]),e._v(" "),_("p",[e._v("​    BASE64Encoder encoder = new BASE64Encoder();")]),e._v(" "),_("p",[e._v("​    String png_base64 =  encoder.encodeBuffer(bytes).trim();//转换成base64串")]),e._v(" "),_("p",[e._v('​    png_base64 = png_base64.replaceAll("\\n", "").replaceAll("\\r", "");//删除 \\r\\n')]),e._v(" "),_("p",[e._v("​    return CommonResult.success(png_base64);*/")]),e._v(" "),_("p",[e._v("}catch(Exception e) {")]),e._v(" "),_("p",[e._v("​    e.printStackTrace();")]),e._v(" "),_("p",[e._v('​    return CommonResult.failed("秒杀失败");')]),e._v(" "),_("h3",{attrs:{id:"_5-1-3-测试验证码生成"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-3-测试验证码生成"}},[e._v("#")]),e._v(" 5.1.3 测试验证码生成")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442074-9ba36259-9b96-443a-b0af-986aea369e62.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_53%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),e._v(" "),_("h2",{attrs:{id:"_5-2-校验验证码"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-校验验证码"}},[e._v("#")]),e._v(" 5.2 校验验证码")]),e._v(" "),_("h3",{attrs:{id:"_5-2-1-提交验证码"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-1-提交验证码"}},[e._v("#")]),e._v(" 5.2.1 提交验证码")]),e._v(" "),_("p",[e._v('@RequestMapping(value="/token", method=RequestMethod.GET)')]),e._v(" "),_("p",[e._v("@ResponseBody")]),e._v(" "),_("p",[e._v("public CommonResult getMiaoshaToken(HttpServletRequest request")]),e._v(" "),_("p",[e._v('​    , @RequestParam("productId") Long productId')]),e._v(" "),_("p",[e._v('​    , @RequestHeader("memberId") Long memberId')]),e._v(" "),_("p",[e._v("​    , @RequestParam Integer verifyCode) {")]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* 用redis限流，限制接口1分钟最多访问10000次")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("String requestURI = request.getRequestURI().toString();")]),e._v(" "),_("p",[e._v("Long requestNum = redisOpsUtil.incr(requestURI);")]),e._v(" "),_("p",[e._v("if (requestNum == 1) {")]),e._v(" "),_("p",[e._v("​    redisOpsUtil.expire(requestURI,60, TimeUnit.SECONDS);")]),e._v(" "),_("p",[e._v("} else if (requestNum > 10000) {")]),e._v(" "),_("p",[e._v('​    return CommonResult.failed("访问超载，请稍后再试");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v('String verifyCodeKey = RedisKeyPrefixConst.MIAOSHA_VERIFY_CODE_PREFIX + memberId + ":" + productId;')]),e._v(" "),_("p",[e._v("/*")]),e._v(" "),_("p",[e._v("* 校验验证码，防止接口被刷")]),e._v(" "),_("p",[e._v("*/")]),e._v(" "),_("p",[e._v("Integer redisCode = redisOpsUtil.get(verifyCodeKey,Integer.class);")]),e._v(" "),_("p",[e._v("if(StringUtils.isEmpty(redisCode) || !redisCode.equals(verifyCode)) {")]),e._v(" "),_("p",[e._v('​    return CommonResult.failed("验证码错误");')]),e._v(" "),_("p",[e._v("}")]),e._v(" "),_("p",[e._v("//验证成功,删除该验证码")]),e._v(" "),_("p",[e._v("redisOpsUtil.delete(verifyCodeKey);")]),e._v(" "),_("p",[e._v("//todo 创建token")]),e._v(" "),_("p",[e._v("String token = MD5.md5(UUID.randomUUID().toString());")]),e._v(" "),_("p",[e._v('log.info("miaosha token:{}",token);')]),e._v(" "),_("p",[e._v('redisOpsUtil.set(RedisKeyPrefixConst.MIAOSHA_TOKEN_PREFIX + memberId + ":" + productId')]),e._v(" "),_("p",[e._v("​      ,token")]),e._v(" "),_("p",[e._v("​      ,300")]),e._v(" "),_("p",[e._v("​      ,TimeUnit.SECONDS);")]),e._v(" "),_("p",[e._v("return CommonResult.success(toke")]),e._v(" "),_("h3",{attrs:{id:"_5-2-2-校验验证码答案"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-2-校验验证码答案"}},[e._v("#")]),e._v(" 5.2.2  校验验证码答案")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/1300531/1595225442340-f08f6c1c-7a8c-4de3-a603-ad61eb2e4ea5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_53%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})])])}),[],!1,null,null,null);_.default=v.exports}}]);