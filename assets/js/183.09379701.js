(window.webpackJsonp=window.webpackJsonp||[]).push([[183],{598:function(n,t,s){"use strict";s.r(t);var a=s(1),e=Object(a.a)({},(function(){var n=this,t=n._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[t("h1",{attrs:{id:"spring与dubbo整合原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#spring与dubbo整合原理"}},[n._v("#")]),n._v(" "),t("strong",[n._v("Spring与Dubbo整合原理")])]),n._v(" "),t("p",[n._v("应用启动类与配置")]),n._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Application")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("static")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("void")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),n._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("throws")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Exception")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("AnnotationConfigApplicationContext")]),n._v(" context "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("new")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("AnnotationConfigApplicationContext")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ProviderConfiguration")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n        context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("start")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("in"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Configuration")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubbo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("scanBasePackages "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"org.apache.dubbo.demo.provider"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@PropertySource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"classpath:/spring/dubbo-provider.properties"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("static")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ProviderConfiguration")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n       \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br")])]),t("p",[n._v("应用配置类为ProviderConfiguration, 在配置上有两个比较重要的注解")]),n._v(" "),t("ol",[t("li",[n._v("@PropertySource表示将dubbo-provider.properties中的配置项添加到Spring容器中，可以通过@Value的方式获取到配置项中的值")]),n._v(" "),t("li",[n._v('@EnableDubbo(scanBasePackages = "org.apache.dubbo.demo.provider")表示对指定包下的类进行扫描，扫描@Service与@Reference注解，并且进行处理')])]),n._v(" "),t("h3",{attrs:{id:"enabledubbo"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#enabledubbo"}},[n._v("#")]),n._v(" @EnableDubbo")]),n._v(" "),t("p",[n._v("在EnableDubbo注解上，有另外两个注解，也是研究Dubbo最重要的两个注解")]),n._v(" "),t("ol",[t("li",[n._v("@EnableDubboConfig")]),n._v(" "),t("li",[n._v("@DubboComponentScan")])]),n._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Target")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ElementType")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[n._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Retention")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("RetentionPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[n._v("RUNTIME")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Inherited")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Documented")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Import")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("DubboConfigConfigurationRegistrar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@interface")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("EnableDubboConfig")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("boolean")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("multiple")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("default")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[n._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br")])]),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Target")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ElementType")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[n._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Retention")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("RetentionPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[n._v("RUNTIME")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Documented")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@Import")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("DubboComponentScanRegistrar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@interface")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("DubboComponentScan")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("value")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("default")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("basePackages")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("default")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Class")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("?")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("]")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[n._v("basePackageClasses")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("default")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(";")]),n._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br")])]),t("p",[n._v("注意两个注解中对应的@Import注解所导入的类：")]),n._v(" "),t("ol",[t("li",[n._v("DubboConfigConfigurationRegistrar")]),n._v(" "),t("li",[n._v("DubboComponentScanRegistrar")])]),n._v(" "),t("p",[n._v("Spring在启动时会解析这两个注解，并且执行对应的Registrar类中的registerBeanDefinitions方法（这是Spring中提供的扩展功能。）")]),n._v(" "),t("h3",{attrs:{id:"dubboconfigconfigurationregistrar"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dubboconfigconfigurationregistrar"}},[n._v("#")]),n._v(" DubboConfigConfigurationRegistrar")]),n._v(" "),t("p",[n._v("Spring启动时，会调用DubboConfigConfigurationRegistrar的registerBeanDefinitions方法，会对Properties文件进行解析，主要完成的事情是根据Properties文件的每个配置项的前缀、参数名、参数值生成对应的Bean。")]),n._v(" "),t("p",[n._v('比如前缀为"dubbo.application"的配置项，会生成一个ApplicationConfig类型的BeanDefinition。')]),n._v(" "),t("p",[n._v('比如前缀为"dubbo.protocol"的配置项，会生成一个ProtocolConfig类型的BeanDefinition。')]),n._v(" "),t("p",[n._v("其他前缀对应关系如下：")]),n._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBindings")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.application"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ApplicationConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.module"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ModuleConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.registry"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("RegistryConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.protocol"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ProtocolConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.monitor"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("MonitorConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.provider"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ProviderConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.consumer"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ConsumerConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.config-center"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("ConfigCenterBean")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.metadata-report"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("MetadataReportConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[n._v("@EnableDubboConfigBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("(")]),n._v("prefix "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[n._v('"dubbo.metrics"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(",")]),n._v(" type "),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("MetricsConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(")")]),n._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("public")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("static")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[n._v("class")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[n._v("Single")]),n._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("{")]),n._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("}")]),n._v("\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br"),t("span",{staticClass:"line-number"},[n._v("15")]),t("br")])]),t("p",[n._v("默认情况下开启了multiple模式，multiple模式表示开启多配置模式，意思是这样的：")]),n._v(" "),t("p",[n._v("如果没有开启multiple模式，那么只支持配置一个dubbo.protocol，比如：")]),n._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[n._v("dubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocol"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("dubbo\ndubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocol"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("port"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("20880")]),n._v("\ndubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocol"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("0.0")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v(".0")]),n._v("\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br")])]),t("p",[n._v("如果开启了multiple模式，那么可以支持多个dubbo.protocol，比如：")]),n._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[n._v("dubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocols"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("p1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("dubbo\ndubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocols"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("p1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("port"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("20880")]),n._v("\ndubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocols"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("p1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("0.0")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v(".0")]),n._v("\n\ndubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocols"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("p2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),n._v("http\ndubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocols"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("p2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("port"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("8082")]),n._v("\ndubbo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("protocols"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("p2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(".")]),n._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[n._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v("0.0")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[n._v(".0")]),n._v("\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br")])]),t("p",[n._v("DubboConfigConfigurationRegistrar的registerBeanDefinitions方法源码流程：")]),n._v(" "),t("ol",[t("li",[n._v("根据"),t("strong",[n._v("DubboConfigConfiguration.Single.class")]),n._v("的定义来注册BeanDefinition，如果开启了multiple模式，则根据"),t("strong",[n._v("DubboConfigConfiguration.Multiple.class")]),n._v("的定义来注册BeanDefinition")]),n._v(" "),t("li",[n._v("两者都是调用的registerBeans(BeanDefinitionRegistry registry, Class<?>... annotatedClasses)方法")]),n._v(" "),t("li",[n._v("在registerBeans方法内，会利用Spring中的AnnotatedBeanDefinitionReader类来加载annotatedClasses参数所指定的类（上面所Single或Multiple类），Spring的AnnotatedBeanDefinitionReader类会识别annotatedClasses上的注解，然后开启解析annotatedClasses类上的注解")]),n._v(" "),t("li",[n._v("可以发现，不管是Single类，还是Multiple类，类上面定义的注解都是@EnableDubboConfigBindings，所以Spring会解析这个注解，在这个注解的定义上Import了一个DubboConfigBindingsRegistrar类，所以这是Spring会去调用DubboConfigBindingsRegistrar类的registerBeanDefinitions方法")]),n._v(" "),t("li",[n._v("在DubboConfigBindingsRegistrar类的registerBeanDefinitions方法中，会去取EnableDubboConfigBindings注解的value属性的值，该值是一个数组，数组中存的内容为@EnableDubboConfigBinding注解。此时DubboConfigBindingsRegistrar会去处理各个@EnableDubboConfigBinding注解，使用DubboConfigBindingRegistrar类的registerBeanDefinitions(AnnotationAttributes attributes, BeanDefinitionRegistry registry)去处理各个@EnableDubboConfigBinding注解")]),n._v(" "),t("li",[n._v("attributes表示@EnableDubboConfigBinding注解中的参数对，比如"),t("strong",[n._v('prefix = "dubbo.application", type = ApplicationConfig.class')]),n._v("。")]),n._v(" "),t("li",[n._v("获取出对应当前@EnableDubboConfigBinding注解的prefix和AbstractConfig类，ApplicationConfig、RegistryConfig、ProtocolConfig等等都是AbstractConfig类的子类")]),n._v(" "),t("li",[n._v("从"),t("strong",[n._v("environment")]),n._v(".getPropertySources()中获取对应的prefix的properties，相当于从Properties文件中获取对应prefix的属性，后面在生成了AplicationConfig类型的BeanDefinition之后，会把这些属性值赋值给对应的BeanDefinition，但是这里获取属性只是为了获取beanName")]),n._v(" "),t("li",[n._v("在生成Bean之前，需要确定Bean的名字，可以通过在Properties文件中配置相关的id属性，那么则对应的值就为beanName，否则自动生成一个beanName")]),n._v(" "),t("li",[n._v("对于Multiple模式的配置，会存在多个bean以及多个beanName")]),n._v(" "),t("li",[n._v("得到beanName之后，向Spring中注册一个空的BeanDefinition对象，并且向Spring中添加一个DubboConfigBindingBeanPostProcessor(Bean后置处理器)，在DubboConfigBindingBeanPostProcessor中有一个构造方法，需要传入prefix和beanName。")]),n._v(" "),t("li",[t("strong",[n._v("总结一下："),t("strong",[t("strong",[n._v("一个")])]),n._v("AbstractConfig的子类会对应一个bean（Multiple模式下会有多个），每个bean对应一个****DubboConfigBindingBeanPostProcessor后置处理器。")])]),n._v(" "),t("li",[n._v("至此，Spring扫描逻辑走完了。")]),n._v(" "),t("li",[n._v("接下来，Spring会根据生成的BeanDefinition生成一个对象，然后会经过"),t("strong",[n._v("DubboConfigBindingBeanPostProcessor后置处理器")]),n._v("的处理。")]),n._v(" "),t("li",[n._v("DubboConfigBindingBeanPostProcessor主要用来对其对应的bean进行属性赋值")]),n._v(" "),t("li",[n._v("首先通过DubboConfigBinder的默认实现类DefaultDubboConfigBinder，来从Properties文件中获取prefix对应的属性值，然后把这些属性值赋值给AbstractConfig对象中的属性")]),n._v(" "),t("li",[n._v("然后看AbstractConfig类中是否存在setName()方法，如果存在则把beanName设置进去")]),n._v(" "),t("li",[n._v("这样一个AbstractConfig类的bean就生成好了")]),n._v(" "),t("li",[t("strong",[n._v("总结一下：Spring在启动时，会去生成"),t("strong",[t("strong",[n._v("ApplicationConfig、RegistryConfig、ProtocolConfig等等")])]),n._v("AbstractConfig子类的bean对象，然后从Properties文件中获取属性值并赋值到bean对象中去。")])])]),n._v(" "),t("p",[n._v("DubboConfigConfigurationRegistrar的逻辑整理完后，就开始整理DubboComponentScanRegistrar的逻辑。")]),n._v(" "),t("h3",{attrs:{id:"dubbocomponentscanregistrar"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dubbocomponentscanregistrar"}},[n._v("#")]),n._v(" DubboComponentScanRegistrar")]),n._v(" "),t("p",[n._v("DubboConfigConfigurationRegistrar的registerBeanDefinitions方法中：")]),n._v(" "),t("ol",[t("li",[n._v("首先获得用户指定的扫描包路径")]),n._v(" "),t("li",[n._v("然后分别生成ServiceAnnotationBeanPostProcessor和ReferenceAnnotationBeanPostProcessor类的BeanDefinition，并注册到Spring中，注意这两个类看上去像，但完全不是一个层面的东西。")]),n._v(" "),t("li",[n._v("ServiceAnnotationBeanPostProcessor是一个BeanDefinitionRegistryPostProcessor，是在Spring扫描过程中执行的。")]),n._v(" "),t("li",[n._v("ReferenceAnnotationBeanPostProcessor的父类是AnnotationInjectedBeanPostProcessor，是一个InstantiationAwareBeanPostProcessorAdapter，是在Spring对容器中的bean进行依赖注入时使用的。")])]),n._v(" "),t("h4",{attrs:{id:"serviceannotationbeanpostprocessor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#serviceannotationbeanpostprocessor"}},[n._v("#")]),n._v(" ServiceAnnotationBeanPostProcessor")]),n._v(" "),t("p",[n._v("在执行postProcessBeanDefinitionRegistry()方法时，会先生成一个DubboClassPathBeanDefinitionScanner，它负责扫描。接下来的流程：")]),n._v(" "),t("ol",[t("li",[n._v("从指定的包路径下扫描@Service注解，扫描得到BeanDefinition")]),n._v(" "),t("li",[n._v("遍历每个BeanDefinition")]),n._v(" "),t("li",[n._v("得到服务实现类、@Service注解信息、服务实现类实现的接口、服务实现类的beanName")]),n._v(" "),t("li",[n._v("生成一个ServiceBean对应的BeanDefinition，下面称为serviceBeanBeanDefinition")]),n._v(" "),t("li",[n._v("根据@Service注解上的信息对serviceBeanBeanDefinition中的属性进行赋值")]),n._v(" "),t("li",[n._v("对ref属性进行赋值（PropertyReference），赋值为服务实现类的beanName")]),n._v(" "),t("li",[n._v("对interface属性进行赋值（PropertyValue），赋值为接口名")]),n._v(" "),t("li",[n._v("对parameters属性进行赋值，把注解中的parameters属性值转化为map进行赋值")]),n._v(" "),t("li",[n._v("对methods属性进行赋值，把注解中的methods属性值转化为List"),t("MethodConfig",[n._v("进行赋值")])],1),n._v(" "),t("li",[n._v("如果@Service注解中配置了provider属性，则对provider属性进行赋值（PropertyReference，表示一个beanName）")]),n._v(" "),t("li",[n._v("monitor、application、module和provider类似")]),n._v(" "),t("li",[n._v("如果@Service注解中配置了registry属性，会对registries属性进行赋值（RuntimeBeanReference）")]),n._v(" "),t("li",[n._v("如果@Service注解中配置了protocol属性，会对protocols属性进行赋值（RuntimeBeanReference）")]),n._v(" "),t("li",[n._v("到此生成了一个ServiceBean的BeanDefinition")]),n._v(" "),t("li",[n._v("然后生成一个ServiceBeanName，并把对应的BeanDefinition注册到Spring中去")]),n._v(" "),t("li",[t("strong",[n._v("总结一下："),t("strong",[t("strong",[n._v("ServiceAnnotationBeanPostProcessor主要用来扫描指定包下面的@Service注解，把扫描到的@Service注解所标注的类都生成一个对应的BeanDefinition(会随着Spring的生命周期生成一个对应的Bean)，然后遍历扫")])]),n._v("描出来的BeanDefinition，根据@Service注解中的参数配置，会生成一个ServiceBean类型的BeanDefinition，并添加到Spring容器中去，所以相当于一个@Service注解会生成两个Bean，一个当前类的Bean，一个ServiceBean类型的Bean。"),t("strong",[t("strong",[n._v("需要注意的是ServiceBean实现了")])]),n._v("ApplicationListener接口，当Spring启动完后，会发布ContextRefreshedEvent事件，ServiceBean会处理该事件，调用ServiceBean中的export()，该方法就是服务导出的入口")]),n._v("**。**")])]),n._v(" "),t("p",[n._v("注意：关于RuntimeBeanReference参考https://www.yuque.com/renyong-jmovm/ufz328/gbwvk7。")]),n._v(" "),t("h4",{attrs:{id:"referenceannotationbeanpostprocessor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#referenceannotationbeanpostprocessor"}},[n._v("#")]),n._v(" ReferenceAnnotationBeanPostProcessor")]),n._v(" "),t("p",[n._v("ReferenceAnnotationBeanPostProcessor的父类是AnnotationInjectedBeanPostProcessor，是一个InstantiationAwareBeanPostProcessorAdapter，是在Spring对容器中的bean进行依赖注入时使用的。")]),n._v(" "),t("p",[n._v("当Spring根据BeanDefinition生成了实例对象后，就需要对对象中的属性进行赋值，此时会：")]),n._v(" "),t("ol",[t("li",[n._v("调用AnnotationInjectedBeanPostProcessor类中的postProcessPropertyValues方法，查找注入点，查找到注入点后就会进行属性注入，"),t("strong",[n._v("注入点分为被@Reference注解了的属性字段，被@Reference注解了的方法")])]),n._v(" "),t("li",[n._v("调用AnnotationInjectedBeanPostProcessor类中的findFieldAnnotationMetadata方法查找属性注入点，返回类型为List<AnnotationInjectedBeanPostProcessor.AnnotatedFieldElement>")]),n._v(" "),t("li",[n._v("调用AnnotationInjectedBeanPostProcessor类中的findAnnotatedMethodMetadata方法查找方法注入点，返回类型为List<AnnotationInjectedBeanPostProcessor.AnnotatedMethodElement>")]),n._v(" "),t("li",[n._v("注解掉找到后，就调用InjectionMetadata的inject方法进行注入。")]),n._v(" "),t("li",[n._v("针对AnnotatedFieldElement，调用getInjectedObject方法得到注入对象injectedObject，然后通过反射"),t("strong",[n._v("field")]),n._v(".set(bean, injectedObject);")]),n._v(" "),t("li",[n._v("针对AnnotatedMethodElement，调用getInjectedObject方法得到注入对象injectedObject，然后通过反射"),t("strong",[n._v("method")]),n._v(".invoke(bean, injectedObject);")]),n._v(" "),t("li",[n._v("在getInjectedObject方法中，调用doGetInjectedBean方法得到注入对象，doGetInjectedBean方法在ReferenceAnnotationBeanPostProcessor类中提供了实现")]),n._v(" "),t("li",[n._v("根据@Reference注解中的参数信息与待注入的属性类型，生成一个serviceBeanName，查看在本应用的Spring容器中是否存在这个名字的bean，如果存在，则表示现在引入的服务就在本地Spring容器中")]),n._v(" "),t("li",[n._v("根据@Reference注解中的参数信息与待注入的属性类型，生成一个referenceBeanName")]),n._v(" "),t("li",[n._v("根据referenceBeanName、@Reference注解中的参数信息与待注入的属性类型生成一个ReferenceBean对象（"),t("strong",[n._v("注意，这里直接就是对象了，最终返回的就是这个对象的get方法的返回值")]),n._v("）")]),n._v(" "),t("li",[n._v("把ReferenceBean对象通过beanFactory注册到Spring中")]),n._v(" "),t("li",[n._v("那么ReferenceBean对象是怎么产生的呢？")]),n._v(" "),t("li",[n._v("AnnotatedInterfaceConfigBeanBuilder类的build方法来生成这个ReferenceBean对象")]),n._v(" "),t("li",[n._v("先"),t("strong",[n._v("new")]),n._v(" ReferenceBean"),t("Object",[n._v("();得到一个ReferenceBean实例")])],1),n._v(" "),t("li",[n._v("然后调用configureBean(ReferenceBean实例);给ReferenceBean实例的属性进行赋值")]),n._v(" "),t("li",[n._v("调用preConfigureBean("),t("strong",[n._v("attributes")]),n._v(', ReferenceBean实例);，把Reference注解的参数值赋值给ReferenceBean实例，除开"application", "module", "consumer", "monitor", "registry"这几个参数')]),n._v(" "),t("li",[n._v("调用configureRegistryConfigs对ReferenceBean实例的registries属性进行赋值，通过@Reference注解中所配置的registry属性获得到值，然后根据该值从Spring容器中获得到bean")]),n._v(" "),t("li",[n._v("同样的，通过调用configureMonitorConfig、configureApplicationConfig、configureModuleConfig方法分别进行赋值")]),n._v(" "),t("li",[n._v("调用postConfigureBean方法对applicationContext、interfaceName、consumer、methods属性进行赋值")]),n._v(" "),t("li",[n._v("最后调用ReferenceBean实例的afterPropertiesSet方法")]),n._v(" "),t("li",[n._v("ReferenceBean生成后了之后，就会调用ReferenceBean的get方法得到一个接口的代理对象，最终会把这个代理对象注入到属性中去")]),n._v(" "),t("li",[n._v("**总结一下：****ReferenceAnnotationBeanPostProcessor主要在Spring对容器中的Bean进行属性注入时进行操作，当Spring对一个Bean进行属性注入时，先查找@Reference的注入点，然后对注入点进行调用，在调用过程中，会根据属性类型，@Reference注解信息生成一个ReferenceBean，然后对ReferenceBean对象的属性进行赋值，最后调用ReferenceBean的get方法得到一个代理对象，最终把这个代理对象注入给属性。**"),t("strong",[n._v("需要注意的是ReferenceBean的get()方法就是服务引入流程的入口。")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);