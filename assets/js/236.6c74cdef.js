(window.webpackJsonp=window.webpackJsonp||[]).push([[236],{655:function(s,a,n){"use strict";n.r(a);var t=n(1),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"课程笔记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#课程笔记"}},[s._v("#")]),s._v(" "),a("strong",[s._v("课程笔记")])]),s._v(" "),a("h1",{attrs:{id:"引言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#引言"}},[s._v("#")]),s._v(" 引言")]),s._v(" "),a("p",[a("strong",[s._v("什么是elasticsearch？")])]),s._v(" "),a("p",[s._v("ElasticSearch是一个分布式，高性能、高可用、可伸缩的搜索和分析系统")]),s._v(" "),a("p",[a("strong",[s._v("什么是Elastic Stack？")])]),s._v(" "),a("p",[s._v("Elastic Stack,前身缩写是ELK，就是ElasticSearch + LogStash + Kibana")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/jpeg/571262/1576820453490-6952638e-6684-416c-9815-2b3c83e23d66.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("p",[s._v("ES的使用场景:")]),s._v(" "),a("ul",[a("li",[s._v("网上商场,搜索商品.")]),s._v(" "),a("li",[s._v("ES配合logstash,kibana,日志分析.")])]),s._v(" "),a("p",[a("strong",[s._v("为什么要使用elasticsearch？")])]),s._v(" "),a("p",[s._v("假设用数据库做搜索，当用户在搜索框输入“四川火锅”时，数据库通常只能把这四个字去进行全部匹配。可是在文本中，可能会出现“推荐四川好吃的火锅”，这时候就没有结果了。")]),s._v(" "),a("h1",{attrs:{id:"_1-elasticsearch基本概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-elasticsearch基本概念"}},[s._v("#")]),s._v(" 1.elasticsearch基本概念")]),s._v(" "),a("h4",{attrs:{id:"近实时-nrt"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#近实时-nrt"}},[s._v("#")]),s._v(" 近实时（NRT）")]),s._v(" "),a("p",[s._v("ES是一个近实时的搜索引擎（平台），代表着从添加数据到能被搜索到只有很少的延迟。（大约是1s）")]),s._v(" "),a("h4",{attrs:{id:"文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文档"}},[s._v("#")]),s._v(" 文档")]),s._v(" "),a("p",[s._v("Elasticsearch是面向文档的，文档是所有可搜索数据的最小单元。可以把文档理解为关系型数据库中的一条记录。文档会被序列化成json格式，保存在Elasticsearch中。同样json对象由字段组成，给个字段都有自己的类型（字符串，数值，布尔，二进制，日期范围类型）。当我们创建文档时，如果不指定类型，Elasticsearch会帮我们自动匹配类型。每个文档都一个ID，你可以自己指定，也可以让Elasticsearch自动生成。json格式，支持数组/嵌套,在一个index/type里面，你可以存储任意多的文档。注意，尽管一个文档，物理上存在于一个索引之中，文档必须被索引/赋予一个索引的type。")]),s._v(" "),a("h4",{attrs:{id:"索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#索引"}},[s._v("#")]),s._v(" 索引")]),s._v(" "),a("p",[s._v("索引是具有某种相似特性的文档集合。例如，您可以拥有客户数据的索引、产品目录的另一个索引以及订单数据的另一个索引。索引由一个名称（必须全部是小写）标识。在单个集群中，您可以定义任意多个索引。Index体现了逻辑空间的概念，每个索引都有自己的mapping定义，用于定义包含文档的字段名和字段类型。Index体现了物理空间的概念，索引中的数据分散在shard上。可以将其暂时理解为 MySql中的 database。")]),s._v(" "),a("p",[s._v("索引的mapping和setting")]),s._v(" "),a("ol",[a("li",[s._v("mapping：定义文档字段的类型")]),s._v(" "),a("li",[s._v("setting：定义不同数据的分布")])]),s._v(" "),a("h4",{attrs:{id:"类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#类型"}},[s._v("#")]),s._v(" 类型")]),s._v(" "),a("p",[s._v("一个索引可以有多个类型。例如一个索引下可以有文章类型，也可以有用户类型，也可以有评论类型。在一个索引中不能再创建多个类型，在以后的版本中将删除类型的整个概念。")]),s._v(" "),a("p",[s._v("从6.0开始，type已经被逐渐废弃。在7.0之前，一个index可以设置多个types。7.0开始一个索引只能创建一个type（_doc）")]),s._v(" "),a("h4",{attrs:{id:"节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点"}},[s._v("#")]),s._v(" 节点")]),s._v(" "),a("p",[s._v("节点是一个Elasticsearch实例，本质上就是一个java进程，节点也有一个名称（默认是随机分配的），当然也可以通过配置文件配置，或者在启动的时候，-E  node.name=node1指定。此名称对于管理目的很重要，因为您希望确定网络中的哪些服务器对应于ElasticSearch集群中的哪些节点。")]),s._v(" "),a("p",[s._v("在Elasticsearch中，节点的类型主要分为如下几种：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("master eligible节点：")]),s._v("\n每个节点启动后，默认就是master eligible节点，可以通过node.master: false  禁止\nmaster eligible可以参加选主流程，成为master节点\n当第一个节点启动后，它会将自己选为master节点\n每个节点都保存了集群的状态，只有master节点才能修改集群的状态信息")]),s._v(" "),a("li",[a("strong",[s._v("data节点")]),s._v("\n可以保存数据的节点。负责保存分片数据，在数据扩展上起到了至关重要的作用")]),s._v(" "),a("li",[a("strong",[s._v("Coordinating 节点")]),s._v("\n负责接收客户端请求，将请求发送到合适的节点，最终把结果汇集到一起\n每个节点默认都起到了Coordinating node的职责")])]),s._v(" "),a("p",[s._v("开发环境中一个节点可以承担多个角色，生产环境中，建议设置单一的角色，可以提高性能等")]),s._v(" "),a("h4",{attrs:{id:"分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分片"}},[s._v("#")]),s._v(" 分片")]),s._v(" "),a("p",[s._v("索引可能存储大量数据，这些数据可能会超出单个节点的硬件限制。例如，占用1TB磁盘空间的10亿个文档的单个索引可能不适合单个节点的磁盘，或者速度太慢，无法单独满足单个节点的搜索请求。")]),s._v(" "),a("p",[s._v("为了解决这个问题，ElasticSearch提供了将索引细分为多个片段（称为碎片）的能力。创建索引时，只需定义所需的碎片数量。每个分片（shard）本身就是一个完全功能性和独立的“索引”，可以托管在集群中的任何节点上。")]),s._v(" "),a("p",[s._v("为什么要分片?")]),s._v(" "),a("ul",[a("li",[s._v("它允许您水平拆分/缩放内容量")]),s._v(" "),a("li",[s._v("它允许您跨碎片（可能在多个节点上）分布和并行操作，从而提高性能/吞吐量")])]),s._v(" "),a("p",[s._v("如何分配分片以及如何将其文档聚合回搜索请求的机制完全由ElasticSearch管理，并且对作为用户的您是透明的。主分片数在索引创建时指定，后续不允许修改，除非Reindex")]),s._v(" "),a("h5",{attrs:{id:"分片副本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分片副本"}},[s._v("#")]),s._v(" 分片副本")]),s._v(" "),a("p",[s._v("在随时可能发生故障的网络/云环境中，非常有用，强烈建议在碎片/节点以某种方式脱机或因任何原因消失时使用故障转移机制。为此，ElasticSearch允许您将索引分片的一个或多个副本复制成所谓的副本分片，简称为副本分片。")]),s._v(" "),a("p",[s._v("为什么要有副本？")]),s._v(" "),a("ul",[a("li",[s._v("当分片/节点发生故障时提供高可用性。因此，需要注意的是，副本分片永远不会分配到复制它的原始/主分片所在的节点上。")]),s._v(" "),a("li",[s._v("允许您扩展搜索量/吞吐量，因为可以在所有副本上并行执行搜索。")])]),s._v(" "),a("p",[s._v("总而言之，每个索引可以分割成多个分片。索引也可以零次（意味着没有副本）或多次复制。复制后，每个索引将具有主分片（从中复制的原始分片）和副本分片（主分片的副本）。")]),s._v(" "),a("p",[s._v("可以在创建索引时为每个索引定义分片和副本的数量。创建索引后，您还可以随时动态更改副本的数量。您可以使用收缩和拆分API更改现有索引的分片数量，建议在创建索引时就考虑好分片和副本的数量。")]),s._v(" "),a("p",[s._v("默认情况下，ElasticSearch中的每个索引都分配一个主分片和一个副本，这意味着如果集群中至少有两个节点，则索引将有一个主分片和另一个副本分片（一个完整副本），每个索引总共有两个分片。")]),s._v(" "),a("h5",{attrs:{id:"倒排索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#倒排索引"}},[s._v("#")]),s._v(" 倒排索引")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/jpeg/571262/1576820488315-909c4204-8237-4a67-ad1a-3d646c221804.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_21%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("ul",[a("li",[s._v("DocID：出现某单词的文档ID")]),s._v(" "),a("li",[s._v("TF(词频)：单词在该文档中出现的次数")]),s._v(" "),a("li",[s._v("POS：单词在文档中的位置")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/jpeg/571262/1576820511199-b9e7bb3a-245c-4a1a-ab33-c635b9948bd3.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_21%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("h1",{attrs:{id:"_2-linux-es的安装-elasticsearch-7-3-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-linux-es的安装-elasticsearch-7-3-2"}},[s._v("#")]),s._v(" 2.linux ES的安装(elasticsearch-7.3.2)")]),s._v(" "),a("p",[s._v("1.下载elasticsearch-7.3.2 tar包  下载地址https://www.elastic.co/cn/downloads/elasticsearch")]),s._v(" "),a("p",[s._v("2.上传到linux，解压  tar -zxvf  elasticsearch-7.3.2-linux-x86_64.tar.gz")]),s._v(" "),a("p",[s._v("3.进入解压后的 elasticsearch-7.3.2文件夹的bin目录下  执行./elasticsearch")]),s._v(" "),a("p",[s._v("执行结果如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/jpeg/571262/1576820557463-2d77544b-9610-4b11-b4a8-6dabec903165.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_48%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("p",[s._v("这个错误，是因为使用root用户启动elasticsearch，elasticsearch是不允许使用root用户启动的")]),s._v(" "),a("p",[s._v("在6.xx之前，可以通过root用户启动。但是发现黑客可以透过elasticsearch获取root用户密码，所以为了安全性，在6版本之后就不能通过root启动elasticsearch")]),s._v(" "),a("p",[s._v("解决方案如下：")]),s._v(" "),a("p",[s._v("groupadd taibai")]),s._v(" "),a("p",[s._v("useradd taibai -g taibai")]),s._v(" "),a("p",[s._v("cd /opt   [elasticsearch-7.3.2所在路径]")]),s._v(" "),a("p",[s._v("chown -R taibai:taibai elasticsearch-7.3.2")]),s._v(" "),a("h5",{attrs:{id:"修改配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改配置"}},[s._v("#")]),s._v(" 修改配置")]),s._v(" "),a("p",[s._v("1、调整jvm内存大小(机器内存够也可不调整)")]),s._v(" "),a("p",[a("strong",[s._v("vim config/jvm.options")])]),s._v(" "),a("p",[s._v("-Xms512m")]),s._v(" "),a("p",[s._v("-Xmx512m")]),s._v(" "),a("p",[s._v("2、修改network配置，支持通过ip访问")]),s._v(" "),a("p",[a("strong",[s._v("vim config/elasticsearch.yml")])]),s._v(" "),a("p",[s._v("cluster.name=luban")]),s._v(" "),a("p",[s._v("node.name=node-1")]),s._v(" "),a("p",[s._v("network.host: 0.0.0.0")]),s._v(" "),a("p",[s._v("http.port: 9200")]),s._v(" "),a("p",[s._v('cluster.initial_master_nodes: ["node-1"]')]),s._v(" "),a("p",[s._v("max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]")]),s._v(" "),a("p",[s._v("vm最大虚拟内存,max_map_count[65530]太低，至少增加到[262144]")]),s._v(" "),a("p",[a("strong",[s._v("vim /etc/sysctl.conf")])]),s._v(" "),a("p",[s._v("vm.max_map_count=655360")]),s._v(" "),a("p",[s._v("sysctl -p  使配置生效")]),s._v(" "),a("p",[s._v("descriptors [4096] for elasticsearch process likely too low, increase to at least [65536]")]),s._v(" "),a("p",[s._v("最大文件描述符[4096]对于elasticsearch进程可能太低，至少增加到[65536]")]),s._v(" "),a("p",[a("strong",[s._v("vim /etc/security/limits.conf")])]),s._v(" "),a("div",{staticClass:"language-latex line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-latex"}},[a("code",[s._v("* soft nofile 65536\n* hard nofile 131072\n* soft nproc 2048\n* hard nproc 4096\n\n* 所有用户\nnofile - 打开文件的最大数目\nnoproc - 进程的最大数目\nsoft 指的是当前系统生效的设置值\nhard 表明系统中所能设定的最大值\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("max number of threads [2048] for user [tongtech] is too low, increase to at least [4096]")]),s._v(" "),a("p",[s._v("用户的最大线程数[2048]过低，增加到至少[4096]")]),s._v(" "),a("p",[a("strong",[s._v("vim /etc/security/limits.d/90-nproc.conf")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("* soft nproc 4096\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("启动：")])]),s._v(" "),a("p",[s._v("su taibai")]),s._v(" "),a("p",[s._v("cd /opt/elasticsearch-7.3.2/bin")]),s._v(" "),a("p",[s._v("./elasticsearch 或  ./elasticsearch -d  (以后台方式运行)")]),s._v(" "),a("p",[s._v("注意：注意开放端口或者关闭防火墙（centos7）")]),s._v(" "),a("ol",[a("li",[s._v("查询防火墙状态：firewall-cmd --state")]),s._v(" "),a("li",[s._v("关闭防火墙：systemctl stop firewalld.service")]),s._v(" "),a("li",[s._v("开启防火墙： systemctl start firewalld.service")]),s._v(" "),a("li",[s._v("禁止firewall开机启动：systemctl disable firewalld.service")])]),s._v(" "),a("p",[s._v("安装成功：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/571262/1576820589313-876cd958-fde0-4ff1-80f7-b9871e4d0a73.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_19%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("h1",{attrs:{id:"_3-elasticsearch-head-的安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-elasticsearch-head-的安装"}},[s._v("#")]),s._v(" 3.elasticsearch-head 的安装")]),s._v(" "),a("p",[s._v("google应用商店下载插件安装（需翻墙）：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/571262/1576820612441-e25dfbad-b383-4bd7-9b99-abad451782ce.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_44%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("h1",{attrs:{id:"_4-kibana的安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-kibana的安装"}},[s._v("#")]),s._v(" 4.kibana的安装")]),s._v(" "),a("p",[s._v("1.下载kibana-7.3.2-linux-x86_64.tar.gz  https://www.elastic.co/cn/downloads/kibana")]),s._v(" "),a("p",[s._v("2.上传至linux系统中并解压   tar -zxvf kibana-7.3.2-linux-x86_64.tar.gz")]),s._v(" "),a("p",[s._v("3.vim  kibana-7.3.2-linux-x86_64/config/kibana.yml")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('server.port: 5601\nserver.host: "0.0.0.0"\ni18n.locale: "zh-CN"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("4.cd  kibana-7.3.2-linux-x86_64/bin")]),s._v(" "),a("p",[s._v("5,  ./kibana --allow-root")]),s._v(" "),a("p",[s._v("6.访问kibana")]),s._v(" "),a("h1",{attrs:{id:"写请求原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#写请求原理"}},[s._v("#")]),s._v(" 写请求原理")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/571262/1576820639918-02f68885-0905-4838-bf00-f0098259c461.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_33%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("p",[s._v("以下是写单个文档所需的步骤：")]),s._v(" "),a("p",[s._v("(1 ）客户端向 NODE I 发送写请求。")]),s._v(" "),a("p",[s._v("(2)检查Active的Shard数。")]),s._v(" "),a("p",[s._v("(3) NODEI 使用文档 ID 来确定文档属于分片 0，通过集群状态中的内容路由表信息获知分片 0 的主分片位于 NODE3 ，因此请求被转发到 NODE3 上。")]),s._v(" "),a("p",[s._v("( 4 ) NODE3 上的主分片执行写操作 。 如果写入成功，则它将请求并行转发到 NODE I 和")]),s._v(" "),a("p",[s._v("NODE2 的副分片上，等待返回结果 。当所有的副分片都报告成功， NODE3 将向协调节点报告")]),s._v(" "),a("p",[s._v("成功，协调节点再向客户端报告成功 。")]),s._v(" "),a("p",[s._v("在客户端收到成功响应时 ，意味着写操作已经在主分片和所有副分片都执行完成。")]),s._v(" "),a("p",[a("strong",[s._v("1. 为什么要检查Active的Shard数？")])]),s._v(" "),a("p",[s._v("ES中有一个参数，叫做wait"),a("em",[s._v("for")]),s._v("activeshards，这个参数是Index的一个setting，也可以在请求中带上这个参数。这个参数的含义是，在每次写入前，该shard至少具有的active副本数。假设我们有一个Index，其每个Shard有3个Replica，加上Primary则总共有4个副本。如果配置wait"),a("em",[s._v("for")]),s._v("activeshards为3，那么允许最多有一个Replica挂掉，如果有两个Replica挂掉，则Active的副本数不足3，此时不允许写入。")]),s._v(" "),a("p",[s._v("这个参数默认是1，即只要Primary在就可以写入，起不到什么作用。如果配置大于1，可以起到一种保护的作用，保证写入的数据具有更高的可靠性。但是这个参数只在写入前检查，并不保证数据一定在至少这些个副本上写入成功，所以并不是严格保证了最少写入了多少个副本。")]),s._v(" "),a("p",[a("strong",[s._v("在以前的版本中，是写一致性机制，现被替换为wait")]),a("em",[a("strong",[s._v("for")])]),a("strong",[s._v("activeshards")])]),s._v(" "),a("p",[s._v("one：要求我们这个写操作，只要有一个primary shard是active活跃可用的，就可以执行")]),s._v(" "),a("p",[s._v("all：要求我们这个写操作，必须所有的primary shard和replica shard都是活跃的，才可以执行这个写操作")]),s._v(" "),a("p",[s._v("quorum：要求所有的shard中，必须是大部分的shard都是活跃的，可用的，才可以执行这个写操作")]),s._v(" "),a("p",[s._v("写一致性的默认策略是 quorum，即多数的分片（其中分片副本可以是主分片或副分片）在")]),s._v(" "),a("p",[s._v("写入操作时处于可用状态。")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("put /index/type/id?consistency=quorum\nquroum = int( (primary + number_of_replicas) / 2 ) + 1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("table",[a("thead",[a("tr",[a("th",[s._v("参数")]),s._v(" "),a("th",[s._v("简 介")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("version")]),s._v(" "),a("td",[s._v("设置文档版本号。主要用于实现乐观锁")])]),s._v(" "),a("tr",[a("td",[s._v("version_type")]),s._v(" "),a("td",[s._v("详见版本类型")])]),s._v(" "),a("tr",[a("td",[s._v("op_type")]),s._v(" "),a("td",[s._v("可设置为 create 。 代表仅在文档不存在时才写入 。 如果文档己存在，则写请求将失败")])]),s._v(" "),a("tr",[a("td",[s._v("routing")]),s._v(" "),a("td",[s._v("ES 默认使用文档 ID 进行路由，指定 routing 可使用 routing 值进行路由")])]),s._v(" "),a("tr",[a("td",[s._v("wait_for_active_shards")]),s._v(" "),a("td",[s._v("用于控制写一致性，当指定数量的分片副本可用时才执行写入，否则重试直至超时 。默认为 l ， 主分片可用 即执行写入")])]),s._v(" "),a("tr",[a("td",[s._v("refresh")]),s._v(" "),a("td",[s._v("写入完毕后执行 refresh ，使其对搜索可见")])]),s._v(" "),a("tr",[a("td",[s._v("timeout")]),s._v(" "),a("td",[s._v("请求超时时间 ， 默认为 l 分钟")])]),s._v(" "),a("tr",[a("td",[s._v("pipeline")]),s._v(" "),a("td",[s._v("指定事先创建好的 pipeline 名称")])])])]),s._v(" "),a("p",[a("strong",[s._v("写入Primary完成后，为何要等待所有Replica响应(或连接失败)后返回")])]),s._v(" "),a("p",[s._v("在更早的ES版本，Primary和Replica之间是允许异步复制的，即写入Primary成功即可返回。但是这种模式下，如果Primary挂掉，就有丢数据的风险，而且从Replica读数据也很难保证能读到最新的数据。所以后来ES就取消异步模式了，改成Primary等Replica返回后再返回给客户端。")]),s._v(" "),a("p",[s._v("因为Primary要等所有Replica返回才能返回给客户端，那么延迟就会受到最慢的Replica的影响，这确实是目前ES架构的一个弊端。之前曾误认为这里是等wait"),a("em",[s._v("for")]),s._v("active_shards个副本写入成功即可返回，但是后来读源码发现是等所有Replica返回的。")]),s._v(" "),a("p",[s._v("如果Replica写入失败，ES会执行一些重试逻辑等，但最终并不强求一定要在多少个节点写入成功。在返回的结果中，会包含数据在多少个shard中写入成功了，多少个失败了")]),s._v(" "),a("h1",{attrs:{id:"_5-restful-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-restful-api"}},[s._v("#")]),s._v(" 5.RESTful API")]),s._v(" "),a("h4",{attrs:{id:"_1-创建空索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建空索引"}},[s._v("#")]),s._v(" 1.创建空索引")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('PUT /taibai \n{\n\t"settings": {\n\t\t"number_of_shards": "2",   //分片数\n\t\t"number_of_replicas": "0",  //副本数\n\t\t"write.wait_for_active_shards": 1\n\t}\n}\n\n\n修改副本数\nPUT taibai/_settings\n{\n    "number_of_replicas" : "2"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h4",{attrs:{id:"_2-删除索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-删除索引"}},[s._v("#")]),s._v(" 2.删除索引")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("DELETE /taibai\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_3-插入数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-插入数据"}},[s._v("#")]),s._v(" 3.插入数据")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('//指定id\nPOST /taibai/_doc/1001\n{\n  "id":1001,\n  "name":"张三",\n  "age":20,\n  "sex":"男"\n}\n\n//不指定id  es帮我们自动生成\nPOST /taibai/_doc\n{\n  "id":1002,\n  "name":"三哥",\n  "age":20,\n  "sex":"男"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h4",{attrs:{id:"_4-更新数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-更新数据"}},[s._v("#")]),s._v(" 4.更新数据")]),s._v(" "),a("p",[s._v("在Elasticsearch中，文档数据是不为修改的，但是可以通过覆盖的方式进行更新")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('PUT /taibai/_doc/1001\n{\n  "id":1009,\n  "name":"太白",\n  "age":21,\n  "sex":"哈哈"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h4",{attrs:{id:"_4-1局部更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1局部更新"}},[s._v("#")]),s._v(" 4.1局部更新：")]),s._v(" "),a("p",[s._v("其实es内部对partial update的实际执行和传统的全量替换方式是几乎一样的，其步骤如下")]),s._v(" "),a("ol",[a("li",[s._v("内部先获取到对应的document；")]),s._v(" "),a("li",[s._v("将传递过来的field更新到document的json中(这一步实质上也是一样的);")]),s._v(" "),a("li",[s._v("将老的document标记为deleted（到一定时候才会物理删除）;")]),s._v(" "),a("li",[s._v("将修改后的新的document创建出来")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_update/1001\n{\n  "doc":{\n     "age":23\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("替换和更新的不同：替换是每次都会去替换，更新是有新的东西就更新，没有新的修改就不更新，更新比替换的性能好")]),s._v(" "),a("h4",{attrs:{id:"_5-删除数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-删除数据"}},[s._v("#")]),s._v(" 5.删除数据")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("DELETE /taibai/_doc/1001\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_6-0根据id搜索数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-0根据id搜索数据"}},[s._v("#")]),s._v(" 6.0根据id搜索数据")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("GET /taibai/_doc/6_h43W0BdTjVHQ-cgnv2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_6-1搜索全部数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1搜索全部数据"}},[s._v("#")]),s._v(" 6.1搜索全部数据")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('GET /taibai/_search    默认最多返回10条数据\n\n\nPOST /bank/_search\n{\n  "query": { "match_all": {} },\n  "sort": [\n    {\n      "属性名": {\n        "order": "asc"\n      }\n    }\n  ]\n}\n\n\n\n\n\ntook      \t Elasticsearch运行查询需要多长时间(以毫秒为单位)\ntimed_out  \t 搜索请求是否超时\n_shards      搜索了多少碎片，并对多少碎片成功、失败或跳过进行了细分。\nmax_score    找到最相关的文档的得分\nhits.total.value  找到了多少匹配的文档\nhits.sort    文档的排序位置(当不根据相关性得分排序时)\nhits._score  文档的相关性评分(在使用match_all时不适用)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("h4",{attrs:{id:"_6-2关键字搜索数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2关键字搜索数据"}},[s._v("#")]),s._v(" 6.2关键字搜索数据")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("GET /taibai/_search?q=age:23    查询年龄等于23的\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_6-3dsl搜索"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3dsl搜索"}},[s._v("#")]),s._v(" 6.3DSL搜索")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search\n{\n  "query" : {\n    "match" : {       //查询年龄等于23的\n      "age" : 23\n    }\n  }\n}\n\n\n//查询地址等于mill或者lane\nGET /bank/_search\n{\n  "query": { "match": { "address": "mill lane" } }\n}\n\n//查询地址等于（mill lane）的\nGET /bank/_search\n{\n  "query": { "match_phrase": { "address": "mill lane" } }\n}\n\n//注意：match 中如果加空格，那么会被认为两个单词，包含任意一个单词将被查询到\n//match_parase 将忽略空格，将该字符认为一个整体，会在索引中匹配包含这个整体的文档。\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search    //查询年龄大于20  并且性别是男的\n{\n  "query": {\n    "bool": {\n      "filter": {\n        "range": {\n            "age": {\n              "gt": 20\n            }\n          }\n        },\n      "must": {\n        "match": {\n          "sex": "男"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h4",{attrs:{id:"_6-4高亮显示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4高亮显示"}},[s._v("#")]),s._v(" 6.4高亮显示")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search   \t\t\t//这里会分词搜索\n{\n  "query": {\n    "match": {\n      "name": "张三"\n    }\n  },\n  "highlight": {\n    "fields": {\n      "name": {}\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h4",{attrs:{id:"_6-5聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-5聚合"}},[s._v("#")]),s._v(" 6.5聚合")]),s._v(" "),a("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations.html")]),s._v(" "),a("h5",{attrs:{id:"avg-平均值"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#avg-平均值"}},[s._v("#")]),s._v(" avg ：平均值")]),s._v(" "),a("h5",{attrs:{id:"max-最大值"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#max-最大值"}},[s._v("#")]),s._v(" max：最大值")]),s._v(" "),a("h5",{attrs:{id:"min-最小值"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#min-最小值"}},[s._v("#")]),s._v(" min：最小值")]),s._v(" "),a("h5",{attrs:{id:"sum-求和"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sum-求和"}},[s._v("#")]),s._v(" sum：求和")]),s._v(" "),a("p",[s._v("例如：查询平均年龄 （如果不指定size等于0，则还会返回10条数据）")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /bank/_search\n{\n  "aggs": {\n    "taibai": {   //自定义名字\n      "avg": {    //什么类型\n        "field": "age"    //那个字段\n      }\n    }\n  },\n  "size": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("使用脚本")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /bank/_search\n{\n  "aggs": {\n    "taibai": {\n      "avg": {\n        "script": {\n          "source": "doc.age.value"\n        }\n      }\n    }\n  },\n  "size": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h5",{attrs:{id:"cardinality-去重统计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cardinality-去重统计"}},[s._v("#")]),s._v(" cardinality : 去重统计")]),s._v(" "),a("p",[s._v("例如：")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /bank/_search\n{\n  "aggs": {\n    "taibai": {\n      "cardinality": {\n        "field": "age"\n      }\n    }\n  },\n  "size": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h5",{attrs:{id:"extended-stats扩展统计聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#extended-stats扩展统计聚合"}},[s._v("#")]),s._v(" extended_stats扩展统计聚合")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /bank/_search\n{\n  "aggs": {\n    "taibai": {\n      "extended_stats": {\n        "field": "age"\n      }\n    }\n  },\n  "size": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h5",{attrs:{id:"value-count值计数统计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#value-count值计数统计"}},[s._v("#")]),s._v(" value_count值计数统计")]),s._v(" "),a("p",[s._v("可以理解为统计个数")]),s._v(" "),a("h5",{attrs:{id:"terms词聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#terms词聚合"}},[s._v("#")]),s._v(" terms词聚合")]),s._v(" "),a("p",[s._v("基于某个field，该 field 内的每一个【唯一词元】为一个桶，并计算每个桶内文档个数。默认返回顺序是按照文档个数多少排序。")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /bank/_search\n{\n  "aggs": {\n    "taibai": {\n      "terms": {\n        "field": "age"\n      }\n    }\n  },\n  "size": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h5",{attrs:{id:"top-hits最高匹配权值聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#top-hits最高匹配权值聚合"}},[s._v("#")]),s._v(" top_hits最高匹配权值聚合")]),s._v(" "),a("p",[s._v("获取到每组前n条数据，相当于sql 中Top（group by 后取出前n条）。它跟踪聚合中相关性最高的文档")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /bank/_search\n{\n  "aggs": {\n    "taibai": {\n      "terms": {\n        "field": "age"\n      },\n      "aggs": {\n        "count": {\n          "top_hits": {\n            "size": 3\n          }\n        }\n      }\n    }\n  },\n  "size": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h5",{attrs:{id:"range范围"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#range范围"}},[s._v("#")]),s._v(" range范围")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST bank/_search\n{\n  "aggs": {\n    "group_by_age": {\n      "range": {\n        "field": "age",\n        "ranges": [\n          {\n            "from": 20,\n            "to": 30\n          },\n          {\n            "from": 30,\n            "to": 40\n          },\n          {\n            "from": 40,\n            "to": 50\n          }\n        ]\n      }\n    }\n  },\n  "size": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("h4",{attrs:{id:"_6-6查询响应"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-6查询响应"}},[s._v("#")]),s._v(" 6.6查询响应")]),s._v(" "),a("p",[s._v("如果使用浏览器工具去查询，返回的json没有格式化，可在后面加参数pretty，返回格式化后的数据")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("http://192.168.204.209:9200/taibai/_doc/_fiK3W0BdTjVHQ-c0HvY?pretty\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_6-7指定响应字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-7指定响应字段"}},[s._v("#")]),s._v(" 6.7指定响应字段")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("GET /taibai/_doc/9_iK3W0BdTjVHQ-czHuE?_source=id,name    //只返回id和name字段\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_6-8去掉元数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-8去掉元数据"}},[s._v("#")]),s._v(" 6.8去掉元数据")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("GET /taibai/_source/9_iK3W0BdTjVHQ-czHuE\n\n\n\n还可以去掉元数据并且返回指定字段\nGET /taibai/_source/9_iK3W0BdTjVHQ-czHuE?_source=id,name\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"_6-9判断文档是否存在"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-9判断文档是否存在"}},[s._v("#")]),s._v(" 6.9判断文档是否存在")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("HEAD /taibai/_doc/9_iK3W0BdTjVHQ-czHuE\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_7-批量操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-批量操作"}},[s._v("#")]),s._v(" 7.批量操作")]),s._v(" "),a("p",[s._v("语法实例")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST _bulk\n{ "index" : { "_index" : "test", "_id" : "1" } }\n{ "field1" : "value1" }\n{ "delete" : { "_index" : "test", "_id" : "2" } }\n{ "create" : { "_index" : "test", "_id" : "3" } }\n{ "field1" : "value3" }\n{ "update" : {"_id" : "1", "_index" : "test"} }\n{ "doc" : {"field2" : "value2"} }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h4",{attrs:{id:"_7-1批量查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1批量查询"}},[s._v("#")]),s._v(" 7.1批量查询")]),s._v(" "),a("p",[s._v("如果，某一条数据不存在，不影响整体响应，需要通过found的值进行判断是否查询到数据。")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_mget\n{\n"ids" : [ "8fiK3W0BdTjVHQ-cxntK", "9fiK3W0BdTjVHQ-cy3sI" ]\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"_7-2批量插入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2批量插入"}},[s._v("#")]),s._v(" 7.2批量插入")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST _bulk\n{ "create" : { "_index" : "taibai", "_id" : "3" } }\n{"id":2002,"name":"name1","age": 20,"sex": "男"}\n{ "create" : { "_index" : "taibai", "_id" : "4" } }\n{"id":2003,"name":"name1","age": 20,"sex": "男"}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_7-3批量删除"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-3批量删除"}},[s._v("#")]),s._v(" 7.3批量删除")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST _bulk\n{ "delete" : { "_index" : "taibai", "_id" : "8PiK3W0BdTjVHQ-cxHs1" } }\n{ "delete" : { "_index" : "taibai", "_id" : "6vh43W0BdTjVHQ-cHXv8" } }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"_7-4批量修改"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-4批量修改"}},[s._v("#")]),s._v(" 7.4批量修改")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST _bulk\n{ "update" : {"_id" : "4", "_index" : "taibai"} }\n{ "doc" : {"name" : "太白"} }\n{ "update" : {"_id" : "3", "_index" : "taibai"} }\n{ "doc" : {"name" : "太白"} }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_8-分页查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-分页查询"}},[s._v("#")]),s._v(" 8.分页查询")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("GET /taibai/_search?size=1&from=2     size: 结果数，默认10      from: 跳过开始的结果数，默认0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"分页一"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分页一"}},[s._v("#")]),s._v(" 分页一")]),s._v(" "),a("p",[s._v("浅分页，它的原理很简单，就是查询前20条数据，然后截断前10条，只返回10-20的数据。这样其实白白浪费了前10条的查询")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('GET /bank/_search\n{\n  "sort": [\n    {\n      "age": {\n        "order": "desc"\n      }\n    }\n  ],\n  "size": 1000,\n  "from": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h5",{attrs:{id:"分页二"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分页二"}},[s._v("#")]),s._v(" 分页二")]),s._v(" "),a("p",[s._v("scroll 深分页，使用scroll，每次只能获取一页的内容，然后会返回一个scroll_id。根据返回的这个scroll_id可以不断地获取下一页的内容，所以scroll并不适用于有跳页的情景")]),s._v(" "),a("ol",[a("li",[s._v("scroll=5m表示设置scroll_id保留5分钟可用。")]),s._v(" "),a("li",[s._v("使用scroll必须要将from设置为0。")]),s._v(" "),a("li",[s._v("size决定后面每次调用_search搜索返回的数量")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('GET /bank/_search?scroll=5m\n{\n  "size": 20,\n  "from": 0,\n  "sort": [\n    {\n      "_id": {\n        "order": "desc"\n      }\n    }\n  ]\n}\n\n\n会返回一个：\n "_scroll_id" : "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAB9AWTVIyY1pKcmhUT0dBT1FXLU5ueHdDQQ=="\n \n 以后调用：\nGET _search/scroll\n{\n  "scroll_id": "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAABMIWTVIyY1pKcmhUT0dBT1FXLU5ueHdDQQ==",\n  "scroll": "5m"\n}\n\n删除scroll_id\nDELETE _search/scroll/DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAABMIWTVIyY1pKcmhUT0dBT1FXLU5ueHdDQQ==\n\n删除所有scroll_id\nDELETE _search/scroll/_all\n\n\n注意:根据官方文档的说法，scroll是非常消耗资源的，所以一个建议就是当不需要了scroll数据的时候，尽可能快的把scroll_id显式删除掉。scroll 的方式，官方的建议不用于实时的请求（一般用于数据导出），因为每一个 scroll_id 不仅会占用大量的资源，而且会生成历史快照，对于数据的变更不会反映到快照上。\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("h5",{attrs:{id:"分页三"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分页三"}},[s._v("#")]),s._v(" 分页三")]),s._v(" "),a("p",[s._v("search_after 深分页，是根据上一页的最后一条数据来确定下一页的位置，同时在分页请求的过程中，如果有索引数据的增删改查，这些变更也会实时的反映到游标上。但是需要注意，因为每一页的数据依赖于上一页最后一条数据，所以无法跳页请求。为了找到每一页最后一条数据，每个文档必须有一个全局唯一值，官方推荐使用 _uid 作为全局唯一值，其实使用业务层的 id 也可以。使用search_after必须要设置from=0。")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('GET /bank/_search\n{\n  "size": 20,\n  "from": 0,\n  "sort": [\n    {\n      "_id": {\n        "order": "desc"\n      }\n    }\n  ]\n}\n\n拿到返回最后一条数据的_id\nGET /bank/_search\n{\n  "size": 20,\n  "from": 0,\n  "sort": [\n    {\n      "_id": {\n        "order": "desc"\n      }\n    }\n  ],\n  "search_after": [\n    980\n  ]\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("h4",{attrs:{id:"_9-映射"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-映射"}},[s._v("#")]),s._v(" 9.映射")]),s._v(" "),a("p",[s._v("前面我们创建的索引以及插入数据，都是由Elasticsearch进行自动判断类型，有些时候我们是需要进行明确字段类型的，否则，自动判断的类型和实际需求是不相符的。")]),s._v(" "),a("p",[s._v("自动判断的规则如下：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("JSON type")]),s._v(" "),a("th",[s._v("Field type")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("Boolean: true or false")]),s._v(" "),a("td",[s._v('"boolean"')])]),s._v(" "),a("tr",[a("td",[s._v("Whole number: 123")]),s._v(" "),a("td",[s._v('"long"')])]),s._v(" "),a("tr",[a("td",[s._v("Floating point: 123.45")]),s._v(" "),a("td",[s._v('"double"')])]),s._v(" "),a("tr",[a("td",[s._v('String, valid date: "2014-09-15"')]),s._v(" "),a("td",[s._v('"date"')])]),s._v(" "),a("tr",[a("td",[s._v('String: "foo bar"')]),s._v(" "),a("td",[s._v('"string"')])])])]),s._v(" "),a("p",[s._v("创建明确类型的索引：")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('PUT /goods\n{\n  "settings": {\n    "number_of_replicas": 0,\n    "number_of_shards": 1\n  },\n  "mappings": {\n    "properties": {\n      "id": {\n        "type": "long"\n      },\n      "sn": {\n        "type": "keyword"\n      },\n      "name": {\n        "type": "text",\n        "analyzer": "ik_max_word"\n      },\n      "price": {\n        "type": "double"\n      },\n      "num": {\n        "type": "integer"\n      },\n      "alert_num": {\n        "type": "integer"\n      },\n      "image": {\n        "type": "keyword"\n      },\n      "images": {\n        "type": "keyword"\n      },\n      "weight": {\n        "type": "double"\n      },\n      "create_time": {\n        "type": "date",\n        "format": "yyyy-MM-dd HH:mm:ss"\n      },\n      "update_time": {\n        "type": "date",\n        "format": "yyyy-MM-dd HH:mm:ss"\n      },\n      "spu_id": {\n        "type": "keyword"\n      },\n      "category_id": {\n        "type": "integer"\n      },\n      "category_name": {\n        "type": "text",\n        "analyzer": "ik_smart"\n      },\n      "brand_name": {\n        "type": "keyword"\n      },\n      "spec": {\n        "type": "text",\n        "analyzer": "ik_max_word"\n      },\n      "sale_num": {\n        "type": "integer"\n      },\n      "comment_num": {\n        "type": "integer"\n      },\n      "status": {\n        "type": "integer"\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br")])]),a("p",[s._v("添加一个字段到现有的映射")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('PUT /luban/_mapping\n{\n  "properties": {\n    "isold": {      //字段名\n      "type": "keyword",  //类型\n      "index": false\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("更新字段的映射")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("除了支持的映射参数外，您不能更改现有字段的映射或字段类型。更改现有字段可能会使已经建立索引的数据无效。\n\n如果您需要更改字段映射，创建具有正确映射一个新的索引和重新索引的数据转换成指数。\n\n重命名字段会使在旧字段名称下已建立索引的数据无效。而是添加一个alias字段以创建备用字段名称。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("查看索引的映射")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("GET /luban/_mapping\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看指定字段的映射信息")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("GET /luban/_mapping/field/name\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_10-结构化查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-结构化查询"}},[s._v("#")]),s._v(" 10.结构化查询")]),s._v(" "),a("h5",{attrs:{id:"_10-1term查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-1term查询"}},[s._v("#")]),s._v(" 10.1term查询")]),s._v(" "),a("p",[s._v("term 主要用于精确匹配哪些值，比如数字，日期，布尔值或 not_analyzed 的字符串(未经分析的文本数据类型)：")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search\n{\n  "query" : {\n    "term" : {\n      "age" : 20\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h5",{attrs:{id:"_10-2terms查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-2terms查询"}},[s._v("#")]),s._v(" 10.2terms查询")]),s._v(" "),a("p",[s._v("terms 跟 term 有点类似，但 terms 允许指定多个匹配条件。 如果某个字段指定了多个值，那么文档需要一起去")]),s._v(" "),a("p",[s._v("做匹配：")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search\n{\n  "query" : {\n    "terms" : {\n      "age" : [20,27]\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h5",{attrs:{id:"_10-3range查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-3range查询"}},[s._v("#")]),s._v(" 10.3range查询")]),s._v(" "),a("p",[s._v("range 过滤允许我们按照指定范围查找一批数据：")]),s._v(" "),a("p",[s._v("gt :: 大于")]),s._v(" "),a("p",[s._v("gte :: 大于等于")]),s._v(" "),a("p",[s._v("lt :: 小于")]),s._v(" "),a("p",[s._v("lte :: 小于等于")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search\n{\n  "query": {\n    "range": {\n      "age": {\n        "gte": 20,\n        "lte": 22\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h5",{attrs:{id:"_10-4exists查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-4exists查询"}},[s._v("#")]),s._v(" 10.4exists查询")]),s._v(" "),a("p",[s._v("exists 查询可以用于查找文档中是否包含指定字段或没有某个字段，类似于SQL语句中的 IS_NULL 条件")]),s._v(" "),a("p",[s._v("包含这个字段就返回返回这条数据")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search\n{\n  "query": {\n    "exists": {\n      "field": "name"\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h5",{attrs:{id:"_10-5-match查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-5-match查询"}},[s._v("#")]),s._v(" 10.5 match查询")]),s._v(" "),a("p",[s._v("match 查询是一个标准查询，不管你需要全文本查询还是精确查询基本上都要用到它。")]),s._v(" "),a("p",[s._v("如果你使用 match 查询一个全文本字段，它会在真正查询之前用分析器先分析 match 一下查询字符；如果用 match 下指定了一个确切值，在遇到数字，日期，布尔值或者 not_analyzed 的字符串时，它将为你搜索你")]),s._v(" "),a("p",[s._v("给定的值：")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search\n{\n  "query" : {\n    "match" : {     \n      "name" : "三个小矮人"\n    }\n  }\n}\nmatch查询会先对搜索词进行分词,分词完毕后再逐个对分词结果进行匹配，因此相比于term的精确搜索，match是分词匹配搜索\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h5",{attrs:{id:"_10-6-bool查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-6-bool查询"}},[s._v("#")]),s._v(" 10.6  bool查询")]),s._v(" "),a("p",[s._v("bool 查询可以用来合并多个条件查询结果的布尔逻辑，它包含一下操作符：")]),s._v(" "),a("p",[s._v("must :: 多个查询条件的完全匹配,相当于 and 。")]),s._v(" "),a("p",[s._v("must_not :: 多个查询条件的相反匹配，相当于 not 。")]),s._v(" "),a("p",[s._v("should :: 至少有一个查询条件匹配, 相当于 or 。")]),s._v(" "),a("p",[s._v("这些参数可以分别继承一个查询条件或者一个查询条件的数组：")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"must": {\n\t\t\t\t"term": {\n\t\t\t\t\t"sex": "男"\n\t\t\t\t}\n\t\t\t},\n\t\t\t"must_not": {\n\t\t\t\t"term": {\n\t\t\t\t\t"age": "29"\n\t\t\t\t}\n\t\t\t},\n\t\t\t"should": [\n\t\t\t  {\n\t\t\t\t\t"term": {\n\t\t\t\t\t\t"sex": "男"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t"term": {\n\t\t\t\t\t\t"id": 1003\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t}\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("h5",{attrs:{id:"_10-7过滤查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-7过滤查询"}},[s._v("#")]),s._v(" 10.7过滤查询")]),s._v(" "),a("p",[s._v("查询年龄为20岁的用户。")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /taibai/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"filter": {\n\t\t\t\t"term": {\n\t\t\t\t\t"age": 20\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h4",{attrs:{id:"批量导入测试数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#批量导入测试数据"}},[s._v("#")]),s._v(" 批量导入测试数据")]),s._v(" "),a("p",[s._v("该数据是使用www.json- "),a("a",{attrs:{href:"https://link.zhihu.com/?target=http%3A//generator.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://generator.com/"),a("OutboundLink")],1),s._v("生成的，因此请忽略数据的实际值和语义，因为它们都是随机生成的。您可以从这里下载示例数据集（accounts.json）。将其提取到当前目录，然后按如下方式将其加载到集群中：")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('curl -H "Content-Type: application/json" -XPOST "localhost:9200/bank/_bulk?pretty&refresh" --data-binary "@accounts.json"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("官方文档练习案例：")]),s._v(" "),a("p",[s._v("1.给指定id加点年龄(age)")]),s._v(" "),a("p",[s._v("2.执行"),a("code",[s._v("match_all")]),s._v("操作，并按帐户余额降序对结果进行排序，并返回前10个")]),s._v(" "),a("p",[s._v("3.如何从搜索中返回两个字段，即帐号和余额")]),s._v(" "),a("p",[s._v("4.返回帐户为20的")]),s._v(" "),a("p",[s._v("5.返回地址中包含“mill”的所有帐户")]),s._v(" "),a("p",[s._v("6.返回地址中包含“mill”或“lane”的所有帐户")]),s._v(" "),a("p",[s._v("7.返回地址中包含“mill”和“lane”的所有帐户")]),s._v(" "),a("p",[s._v("8.地址中既不包含“mill”也不包含“lane”的所有帐户")]),s._v(" "),a("p",[s._v("9.返回所有40岁但不居住在ID的人(state不等于ID)的账户")]),s._v(" "),a("p",[s._v("10.使用bool查询返回余额在20000到30000之间的所有帐户，包括余额。换句话说，我们希望找到余额大于或等于20000，小于或等于30000的账户")]),s._v(" "),a("p",[s._v("11.按状态(state)对所有帐户进行分组，然后返回按count降序排列的前10个")]),s._v(" "),a("p",[s._v("12.按状态计算平均帐户余额(同样只针对按count降序排列的前10个状态)")]),s._v(" "),a("p",[s._v("13.基于之前(12)的聚合，我们现在按降序对平均余额排序")]),s._v(" "),a("p",[s._v("14.按照年龄等级(20-29岁，30-39岁，40-49岁)分组，然后按性别分组，最后得到每个年龄等级，每个性别的平均账户余额")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /bank/_update/1\n{\n  "script": "ctx._source.age+=5"\n}\n\n\nGET /bank/_search\n{\n  "query": {\n    "match_all": {}\n  },\n  "sort": [\n    {\n      "balance": {\n        "order": "desc"\n      }\n    }\n  ]\n}\n\n\nGET /bank/_search\n{\n  "query": {\n    "match_all": {}\n  }, \n  "_source": ["account_number","balance"]\n}\n\n\nGET /bank/_search\n{\n  "query": {\n    "match": {\n      "account_number": "20"\n    }\n  }\n}\n\n\nGET /bank/_search\n{\n  "query": {\n    "match": {\n      "address": "mill"\n    }\n  }\n}\n\n\nGET /bank/_search\n{\n  "query": {\n    "match": {\n      "address": "mill lane"\n    }\n  }\n}\n\n\nGET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        {\n          "match": {\n            "address": "mill"\n          }\n        },\n        {\n          "match": {\n            "address": "lane"\n          }\n        }\n      ]\n    }\n  }\n}\n\n\nGET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must_not": [\n        {\n          "match": {\n            "address": "mill"\n          }\n        },\n        {\n          "match": {\n            "address": "lane"\n          }\n        }\n      ]\n    }\n  }\n}\n\n\nGET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        {\n          "term": {\n            "age": {\n              "value": 40\n            }\n          }\n        }\n      ],\n      "must_not": [\n        {\n          "match": {\n            "state": "ID"\n          }\n        }\n      ]\n    }\n  }\n}\n\n\n\nGET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        {\n          "range": {\n            "balance": {\n              "gte": 20000,\n              "lte": 30000\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n\n\nGET /bank/_search\n{\n  "aggs": {\n    "status_group": {\n      "terms": {\n        "field": "state.keyword"\n      }\n    }\n  },\n  "size": 0\n}\n\n\nGET /bank/_search\n{\n  "aggs": {\n    "status_group": {\n      "terms": {\n        "field": "state.keyword"\n      },\n      "aggs": {\n        "balance_avg": {\n          "avg": {\n            "field": "balance"\n          }\n        }\n      }\n    }\n  },\n  "size": 0\n}\n\n\n\n\n\n\nGET /bank/_search\n{\n  "aggs": {\n    "status_group": {\n      "terms": {\n        "field": "state.keyword",\n        "order": {\n          "balance_avg": "asc"\n        }\n      },\n      "aggs": {\n        "balance_avg": {\n          "avg": {\n            "field": "balance"\n          }\n        }\n      }\n    }\n  },\n  "size": 0\n}\n\n\n\nGET /bank/_search\n{\n  "aggs": {\n    "age_range": {\n      "range": {\n        "field": "age",\n        "ranges": [\n          {\n            "from": 20,\n            "to": 30\n          },{\n            "from": 30,\n            "to": 40\n          },{\n            "from": 40,\n            "to": 50\n          }\n        ]\n      },\n      "aggs": {\n        "gender_group": {\n          "terms": {\n            "field": "gender.keyword"\n          },\n          "aggs": {\n            "balance_avg": {\n              "avg": {\n                "field": "balance"\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  "size": 0\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br"),a("span",{staticClass:"line-number"},[s._v("111")]),a("br"),a("span",{staticClass:"line-number"},[s._v("112")]),a("br"),a("span",{staticClass:"line-number"},[s._v("113")]),a("br"),a("span",{staticClass:"line-number"},[s._v("114")]),a("br"),a("span",{staticClass:"line-number"},[s._v("115")]),a("br"),a("span",{staticClass:"line-number"},[s._v("116")]),a("br"),a("span",{staticClass:"line-number"},[s._v("117")]),a("br"),a("span",{staticClass:"line-number"},[s._v("118")]),a("br"),a("span",{staticClass:"line-number"},[s._v("119")]),a("br"),a("span",{staticClass:"line-number"},[s._v("120")]),a("br"),a("span",{staticClass:"line-number"},[s._v("121")]),a("br"),a("span",{staticClass:"line-number"},[s._v("122")]),a("br"),a("span",{staticClass:"line-number"},[s._v("123")]),a("br"),a("span",{staticClass:"line-number"},[s._v("124")]),a("br"),a("span",{staticClass:"line-number"},[s._v("125")]),a("br"),a("span",{staticClass:"line-number"},[s._v("126")]),a("br"),a("span",{staticClass:"line-number"},[s._v("127")]),a("br"),a("span",{staticClass:"line-number"},[s._v("128")]),a("br"),a("span",{staticClass:"line-number"},[s._v("129")]),a("br"),a("span",{staticClass:"line-number"},[s._v("130")]),a("br"),a("span",{staticClass:"line-number"},[s._v("131")]),a("br"),a("span",{staticClass:"line-number"},[s._v("132")]),a("br"),a("span",{staticClass:"line-number"},[s._v("133")]),a("br"),a("span",{staticClass:"line-number"},[s._v("134")]),a("br"),a("span",{staticClass:"line-number"},[s._v("135")]),a("br"),a("span",{staticClass:"line-number"},[s._v("136")]),a("br"),a("span",{staticClass:"line-number"},[s._v("137")]),a("br"),a("span",{staticClass:"line-number"},[s._v("138")]),a("br"),a("span",{staticClass:"line-number"},[s._v("139")]),a("br"),a("span",{staticClass:"line-number"},[s._v("140")]),a("br"),a("span",{staticClass:"line-number"},[s._v("141")]),a("br"),a("span",{staticClass:"line-number"},[s._v("142")]),a("br"),a("span",{staticClass:"line-number"},[s._v("143")]),a("br"),a("span",{staticClass:"line-number"},[s._v("144")]),a("br"),a("span",{staticClass:"line-number"},[s._v("145")]),a("br"),a("span",{staticClass:"line-number"},[s._v("146")]),a("br"),a("span",{staticClass:"line-number"},[s._v("147")]),a("br"),a("span",{staticClass:"line-number"},[s._v("148")]),a("br"),a("span",{staticClass:"line-number"},[s._v("149")]),a("br"),a("span",{staticClass:"line-number"},[s._v("150")]),a("br"),a("span",{staticClass:"line-number"},[s._v("151")]),a("br"),a("span",{staticClass:"line-number"},[s._v("152")]),a("br"),a("span",{staticClass:"line-number"},[s._v("153")]),a("br"),a("span",{staticClass:"line-number"},[s._v("154")]),a("br"),a("span",{staticClass:"line-number"},[s._v("155")]),a("br"),a("span",{staticClass:"line-number"},[s._v("156")]),a("br"),a("span",{staticClass:"line-number"},[s._v("157")]),a("br"),a("span",{staticClass:"line-number"},[s._v("158")]),a("br"),a("span",{staticClass:"line-number"},[s._v("159")]),a("br"),a("span",{staticClass:"line-number"},[s._v("160")]),a("br"),a("span",{staticClass:"line-number"},[s._v("161")]),a("br"),a("span",{staticClass:"line-number"},[s._v("162")]),a("br"),a("span",{staticClass:"line-number"},[s._v("163")]),a("br"),a("span",{staticClass:"line-number"},[s._v("164")]),a("br"),a("span",{staticClass:"line-number"},[s._v("165")]),a("br"),a("span",{staticClass:"line-number"},[s._v("166")]),a("br"),a("span",{staticClass:"line-number"},[s._v("167")]),a("br"),a("span",{staticClass:"line-number"},[s._v("168")]),a("br"),a("span",{staticClass:"line-number"},[s._v("169")]),a("br"),a("span",{staticClass:"line-number"},[s._v("170")]),a("br"),a("span",{staticClass:"line-number"},[s._v("171")]),a("br"),a("span",{staticClass:"line-number"},[s._v("172")]),a("br"),a("span",{staticClass:"line-number"},[s._v("173")]),a("br"),a("span",{staticClass:"line-number"},[s._v("174")]),a("br"),a("span",{staticClass:"line-number"},[s._v("175")]),a("br"),a("span",{staticClass:"line-number"},[s._v("176")]),a("br"),a("span",{staticClass:"line-number"},[s._v("177")]),a("br"),a("span",{staticClass:"line-number"},[s._v("178")]),a("br"),a("span",{staticClass:"line-number"},[s._v("179")]),a("br"),a("span",{staticClass:"line-number"},[s._v("180")]),a("br"),a("span",{staticClass:"line-number"},[s._v("181")]),a("br"),a("span",{staticClass:"line-number"},[s._v("182")]),a("br"),a("span",{staticClass:"line-number"},[s._v("183")]),a("br"),a("span",{staticClass:"line-number"},[s._v("184")]),a("br"),a("span",{staticClass:"line-number"},[s._v("185")]),a("br"),a("span",{staticClass:"line-number"},[s._v("186")]),a("br"),a("span",{staticClass:"line-number"},[s._v("187")]),a("br"),a("span",{staticClass:"line-number"},[s._v("188")]),a("br"),a("span",{staticClass:"line-number"},[s._v("189")]),a("br"),a("span",{staticClass:"line-number"},[s._v("190")]),a("br"),a("span",{staticClass:"line-number"},[s._v("191")]),a("br"),a("span",{staticClass:"line-number"},[s._v("192")]),a("br"),a("span",{staticClass:"line-number"},[s._v("193")]),a("br"),a("span",{staticClass:"line-number"},[s._v("194")]),a("br"),a("span",{staticClass:"line-number"},[s._v("195")]),a("br"),a("span",{staticClass:"line-number"},[s._v("196")]),a("br"),a("span",{staticClass:"line-number"},[s._v("197")]),a("br"),a("span",{staticClass:"line-number"},[s._v("198")]),a("br"),a("span",{staticClass:"line-number"},[s._v("199")]),a("br"),a("span",{staticClass:"line-number"},[s._v("200")]),a("br"),a("span",{staticClass:"line-number"},[s._v("201")]),a("br"),a("span",{staticClass:"line-number"},[s._v("202")]),a("br"),a("span",{staticClass:"line-number"},[s._v("203")]),a("br"),a("span",{staticClass:"line-number"},[s._v("204")]),a("br"),a("span",{staticClass:"line-number"},[s._v("205")]),a("br"),a("span",{staticClass:"line-number"},[s._v("206")]),a("br"),a("span",{staticClass:"line-number"},[s._v("207")]),a("br"),a("span",{staticClass:"line-number"},[s._v("208")]),a("br"),a("span",{staticClass:"line-number"},[s._v("209")]),a("br"),a("span",{staticClass:"line-number"},[s._v("210")]),a("br"),a("span",{staticClass:"line-number"},[s._v("211")]),a("br"),a("span",{staticClass:"line-number"},[s._v("212")]),a("br"),a("span",{staticClass:"line-number"},[s._v("213")]),a("br"),a("span",{staticClass:"line-number"},[s._v("214")]),a("br"),a("span",{staticClass:"line-number"},[s._v("215")]),a("br"),a("span",{staticClass:"line-number"},[s._v("216")]),a("br"),a("span",{staticClass:"line-number"},[s._v("217")]),a("br"),a("span",{staticClass:"line-number"},[s._v("218")]),a("br"),a("span",{staticClass:"line-number"},[s._v("219")]),a("br"),a("span",{staticClass:"line-number"},[s._v("220")]),a("br"),a("span",{staticClass:"line-number"},[s._v("221")]),a("br"),a("span",{staticClass:"line-number"},[s._v("222")]),a("br"),a("span",{staticClass:"line-number"},[s._v("223")]),a("br"),a("span",{staticClass:"line-number"},[s._v("224")]),a("br"),a("span",{staticClass:"line-number"},[s._v("225")]),a("br"),a("span",{staticClass:"line-number"},[s._v("226")]),a("br"),a("span",{staticClass:"line-number"},[s._v("227")]),a("br"),a("span",{staticClass:"line-number"},[s._v("228")]),a("br"),a("span",{staticClass:"line-number"},[s._v("229")]),a("br"),a("span",{staticClass:"line-number"},[s._v("230")]),a("br"),a("span",{staticClass:"line-number"},[s._v("231")]),a("br"),a("span",{staticClass:"line-number"},[s._v("232")]),a("br"),a("span",{staticClass:"line-number"},[s._v("233")]),a("br"),a("span",{staticClass:"line-number"},[s._v("234")]),a("br"),a("span",{staticClass:"line-number"},[s._v("235")]),a("br"),a("span",{staticClass:"line-number"},[s._v("236")]),a("br"),a("span",{staticClass:"line-number"},[s._v("237")]),a("br"),a("span",{staticClass:"line-number"},[s._v("238")]),a("br"),a("span",{staticClass:"line-number"},[s._v("239")]),a("br"),a("span",{staticClass:"line-number"},[s._v("240")]),a("br"),a("span",{staticClass:"line-number"},[s._v("241")]),a("br"),a("span",{staticClass:"line-number"},[s._v("242")]),a("br"),a("span",{staticClass:"line-number"},[s._v("243")]),a("br"),a("span",{staticClass:"line-number"},[s._v("244")]),a("br"),a("span",{staticClass:"line-number"},[s._v("245")]),a("br")])]),a("h1",{attrs:{id:"_6-中文分词"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-中文分词"}},[s._v("#")]),s._v(" 6.中文分词")]),s._v(" "),a("h5",{attrs:{id:"_6-0-analyzer-的组成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-0-analyzer-的组成"}},[s._v("#")]),s._v(" 6.0 "),a("strong",[s._v("Analyzer 的组成")])]),s._v(" "),a("ul",[a("li",[s._v("Character Filters (针对原始文本处理，例如，可以使用字符过滤器将印度阿拉伯数字（ ）转换为其等效的阿拉伯语-拉丁语（0123456789）)")]),s._v(" "),a("li",[s._v('Tokenizer（按照规则切分为单词）,将把文本 "Quick brown fox!" 转换成 terms [Quick, brown, fox!],tokenizer 还记录文本单词位置以及偏移量。')]),s._v(" "),a("li",[s._v("Token Filter(将切分的的单词进行加工、小写、刪除 stopwords，增加同义词）")])]),s._v(" "),a("h5",{attrs:{id:"_6-1elasticsearch内置分词器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1elasticsearch内置分词器"}},[s._v("#")]),s._v(" 6.1elasticsearch内置分词器")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[s._v("Standard")])]),s._v(" "),a("th",[s._v("默认分词器  按词分类  小写处理")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[a("strong",[s._v("Simple")])]),s._v(" "),a("td",[s._v("按照非字母切分，非字母则会被去除  小写处理")])]),s._v(" "),a("tr",[a("td",[a("strong",[s._v("Stop")])]),s._v(" "),a("td",[s._v("小写处理  停用词过滤（the，a, is)")])]),s._v(" "),a("tr",[a("td",[a("strong",[s._v("Whitespace")])]),s._v(" "),a("td",[s._v("按空格切分")])]),s._v(" "),a("tr",[a("td",[a("strong",[s._v("Keyword")])]),s._v(" "),a("td",[s._v("不分词，当成一整个 term 输出")])]),s._v(" "),a("tr",[a("td",[a("strong",[s._v("Patter")])]),s._v(" "),a("td",[s._v("通过正则表达式进行分词  默认是 \\W+(非字母进行分隔)")])]),s._v(" "),a("tr",[a("td",[a("strong",[s._v("Language")])]),s._v(" "),a("td",[s._v("提供了 30 多种常见语言的分词器")])])])]),s._v(" "),a("h5",{attrs:{id:"_6-2分词api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2分词api"}},[s._v("#")]),s._v(" "),a("strong",[s._v("6.2分词api")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /_analyze\n{\n  "analyzer":"standard",\n  "text":"tai bai"\n}\n\nPOST /_analyze\n{\n  "analyzer":"standard",\n  "text":"决战到天亮"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("英文分词  一般以空格分隔，中文分词的难点在于，在汉语中没有明显的词汇分界点，如果分隔不正确就会造成歧义。")]),s._v(" "),a("p",[s._v("常用中文分词器，IK、jieba、THULAC等，推荐使用IK分词器。")]),s._v(" "),a("h5",{attrs:{id:"_6-3ik分词器安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3ik分词器安装"}},[s._v("#")]),s._v(" "),a("strong",[s._v("6.3ik分词器安装")])]),s._v(" "),a("p",[s._v("IK分词器 Elasticsearch插件地址：https://github.com/medcl/elasticsearch-analysis-ik")]),s._v(" "),a("p",[a("strong",[s._v("1.下载对应版本的zip包")]),a("a",{attrs:{href:"https://github.com/medcl/elasticsearch-analysis-pinyin/releases",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[s._v("https://github.com/medcl/elasticsearch-analysis-pinyin/releases")]),a("OutboundLink")],1)]),s._v(" "),a("p",[a("strong",[s._v("2.可在Windows解压好，在plugins下创建pinyin文件夹")])]),s._v(" "),a("p",[a("strong",[s._v("3.将解压内容放置在pinyin文件夹，重启")])]),s._v(" "),a("p",[a("strong",[s._v("4.ik插件安装完成")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/jpeg/571262/1576820826134-c66b87fd-4ac8-4876-a844-0b2f25653613.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_52%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("p",[a("strong",[s._v("5.测试中文分词器效果")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /_analyze\n{\n  "analyzer": "ik_max_word",   或者  //ik_smart\n  "text": "决战到天亮"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h5",{attrs:{id:"_6-4拼音分词器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4拼音分词器"}},[s._v("#")]),s._v(" "),a("strong",[s._v("6.4拼音分词器")])]),s._v(" "),a("p",[a("strong",[s._v("1.下载对应版本的zip包")]),a("a",{attrs:{href:"https://github.com/medcl/elasticsearch-analysis-pinyin/releases",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[s._v("https://github.com/medcl/elasticsearch-analysis-pinyin/releases")]),a("OutboundLink")],1)]),s._v(" "),a("p",[a("strong",[s._v("2.可在Windows解压好，在plugins下创建pinyin文件夹")])]),s._v(" "),a("p",[a("strong",[s._v("3.将解压内容放置在pinyin文件夹，重启")])]),s._v(" "),a("h5",{attrs:{id:"_6-5自定义分词器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-5自定义分词器"}},[s._v("#")]),s._v(" 6.5自定义分词器")]),s._v(" "),a("p",[a("strong",[s._v("接受参数")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("tokenizer")]),s._v(" "),a("th",[s._v("一个内置的或定制的tokenizer。(必需)")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[a("strong",[s._v("char_filter")])]),s._v(" "),a("td",[a("strong",[s._v("一个可选的内置或自定义字符过滤器数组。")])])]),s._v(" "),a("tr",[a("td",[a("strong",[s._v("filter")])]),s._v(" "),a("td",[a("strong",[s._v("一个可选的内置或定制token过滤器数组。")])])])])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('PUT my_index\n{\n  "settings": {\n    "analysis": {\n      "analyzer": {\n        "my_custom_analyzer": {\n          "type": "custom", \n          "tokenizer": "standard",\n          "char_filter": [\n            "html_strip"     //过滤HTML标签\n          ],\n          "filter": [\n            "lowercase",    //转小写\n            "asciifolding"  //ASCII-折叠令牌过滤器  例如 à to a\n          ]\n        }\n      }\n    }\n  }\n}\n\n\nPOST my_index/_analyze\n{\n  "analyzer": "my_custom_analyzer",\n  "text": "Is this <b>déjà vu</b>?"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("p",[a("strong",[s._v("创建一个中文+拼音的分词器")]),s._v("（中文分词后拼音分词）")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('PUT my_index\n{\n  "settings": {\n    "analysis": {\n      "analyzer": {\n        "ik_pinyin_analyzer": {\n          "type": "custom",\n          "tokenizer": "ik_smart",\n          "filter": [\n            "pinyin_max_word_filter"\n          ]\n        },\n        "ik_pingying_smark": {\n          "type": "custom",\n          "tokenizer": "ik_smart",\n          "filter": [\n            "pinyin_smark_word_filter"\n          ]\n        }\n      },\n      "filter": {\n        "pinyin_max_word_filter": {\n          "type": "pinyin",\n          "keep_full_pinyin": "true",  #分词全拼如雪花 分词xue,hua\n          "keep_separate_first_letter": "true",#分词简写如雪花 分词xh\n          "keep_joined_full_pinyin": true  #分词会quanpin 连接 比如雪花分词 xuehua\n        },\n        "pinyin_smark_word_filter": {\n          "type": "pinyin",\n          "keep_separate_first_letter": "false", #不分词简写如雪花 分词不分词xh\n          "keep_first_letter": "false"     #不分词单个首字母 如雪花 不分词 x,h\n        }\n      }\n    }\n  }\n}\n\n\nPUT /my_index/_mapping\n  {\n  "properties": {\n      "productName": {\n          "type": "text",\n          "analyzer": "ik_pinyin_analyzer",  #做文档所用的分词器\n          "search_analyzer":"ik_pingying_smark"   #搜索使用的分词器\n      }\n  }\n}\n\nPOST /my_index/_doc\n{\n  "productName": "雪花啤酒100L"\n}\n\n\nGET /my_index/_search\n{\n  "query": {\n    "match": {\n      "productName": "雪Hua"\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br")])]),a("h1",{attrs:{id:"_7-全文搜索"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-全文搜索"}},[s._v("#")]),s._v(" "),a("strong",[s._v("7.全文搜索")])]),s._v(" "),a("h5",{attrs:{id:"_7-1构建数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1构建数据"}},[s._v("#")]),s._v(" "),a("strong",[s._v("7.1构建数据")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('PUT /test\n{\n\t"settings": {\n\t\t"index": {\n\t\t\t"number_of_shards": "1",\n\t\t\t"number_of_replicas": "0"\n\t\t}\n\t},\n\t"mappings": {\n\t\t"properties": {\n\t\t\t"age": {\n\t\t\t\t"type": "integer"\n\t\t\t},\n\t\t\t"email": {\n\t\t\t\t"type": "keyword"\n\t\t\t},\n\t\t\t"name": {\n\t\t\t\t"type": "text"\n\t\t\t},\n\t\t\t"hobby": {\n\t\t\t\t"type": "text",\n\t\t\t\t"analyzer": "ik_max_word"\n\t\t\t}\n\t\t}\n\t}\n}\n\n\n\nPOST _bulk\n{ "create" : { "_index" : "test","_id": "1000"} }\n{"name":"张三","age": 20,"mail": "111@qq.com","hobby":"羽毛球、乒乓球、足球"}\n{ "create" : { "_index" : "test","_id": "1001"} }\n{"name":"李四","age": 21,"mail": "222@qq.com","hobby":"羽毛球、乒乓球、足球、篮球"}\n{ "create" : { "_index" : "test","_id": "1002"} }\n{"name":"王五","age": 22,"mail": "333@qq.com","hobby":"羽毛球、篮球、游泳、听音乐"}\n{ "create" : { "_index" : "test","_id": "1003"} }\n{"name":"赵六","age": 23,"mail": "444@qq.com","hobby":"跑步、游泳、篮球"}\n{ "create" : { "_index" : "test","_id": "1004"} }\n{"name":"孙七","age": 24,"mail": "555@qq.com","hobby":"听音乐、看电影、羽毛球"}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("h5",{attrs:{id:"_7-2单词搜索"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2单词搜索"}},[s._v("#")]),s._v(" "),a("strong",[s._v("7.2单词搜索")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /test/_search\n{\n\t"query": {\n\t\t"match": {\n\t\t\t"hobby": "音乐"\n\t\t}\n\t},\n\t"highlight": {\n\t\t"fields": {\n\t\t\t"hobby": {}\n\t\t}\n\t}\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h5",{attrs:{id:"_7-3多词搜索"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-3多词搜索"}},[s._v("#")]),s._v(" "),a("strong",[s._v("7.3多词搜索")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('//搜索包含音乐和篮球的\nPOST /test/_search\n{\n\t"query": {\n\t\t"match": {\n\t\t\t"hobby": "音乐 篮球"\n\t\t}\n\t},\n\t"highlight": {\n\t\t"fields": {\n\t\t\t"hobby": {}\n\t\t}\n\t}\n}\n\n//搜索包含音乐还有篮球的（and）\nPOST /test/_search\n{\n\t"query": {\n\t\t"match": {\n\t\t\t"hobby": {\n\t\t\t\t"query": "音乐 篮球",\n\t\t\t\t"operator": "and"\n\t\t\t}\n\t\t}\n\t},\n\t"highlight": {\n\t\t"fields": {\n\t\t\t"hobby": {}\n\t\t}\n\t}\n}\n\n\nGET /goods/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        {\n          "range": {\n            "price": {\n              "gte": 1000,\n              "lte": 2000\n            }\n          }\n        },\n        {\n          "match": {\n            "name": "2018女鞋"\n          }\n        },\n        {\n          "match": {\n            "spec": "红色 黑色"\n          }\n        }\n      ],\n      "must_not": [\n        {\n          "match": {\n            "spec": "蓝色"\n          }\n        }\n      ]\n    }\n  }\n}\n\n//在Elasticsearch中也支持这样的查询，通过minimum_should_match来指定匹配度，如：70%；\nPOST /test/_search\n{\n\t"query": {\n\t\t"match": {\n\t\t\t"hobby": {\n\t\t\t\t"query": "游泳 羽毛球",\n\t\t\t\t"minimum_should_match": "70%"\n\t\t\t}\n\t\t}\n\t},\n\t"highlight": {\n\t\t"fields": {\n\t\t\t"hobby": {}\n\t\t}\n\t}\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br")])]),a("h5",{attrs:{id:"_7-4组合搜索"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-4组合搜索"}},[s._v("#")]),s._v(" "),a("strong",[s._v("7.4组合搜索")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('//搜索结果中必须包含篮球，不能包含音乐，如果包含了游泳，那么它的相似度更高。\nPOST /test/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"must": {\n\t\t\t\t"match": {\n\t\t\t\t\t"hobby": "篮球"\n\t\t\t\t}\n\t\t\t},\n\t\t\t"must_not": {\n\t\t\t\t"match": {\n\t\t\t\t\t"hobby": "音乐"\n\t\t\t\t}\n\t\t\t},\n\t\t\t"should": [{\n\t\t\t\t"match": {\n\t\t\t\t\t"hobby": "游泳"\n\t\t\t\t}\n\t\t\t}]\n\t\t}\n\t},\n\t"highlight": {\n\t\t"fields": {\n\t\t\t"hobby": {}\n\t\t}\n\t}\n}\n\n\n//默认情况下，should中的内容不是必须匹配的，如果查询语句中没有must，那么就会至少匹配其中一个。当然了，\n也可以通过minimum_should_match参数进行控制，该值可以是数字也可以的百分比。\n//minimum_should_match为2，意思是should中的三个词，至少要满足2个\n\nPOST /test/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"should": [{\n\t\t\t\t\t"match": {\n\t\t\t\t\t\t"hobby": "游泳"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t"match": {\n\t\t\t\t\t\t"hobby": "篮球"\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t"match": {\n\t\t\t\t\t\t"hobby": "音乐"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\t"minimum_should_match": 2\n\t\t}\n\t},\n\t"highlight": {\n\t\t"fields": {\n\t\t\t"hobby": {}\n\t\t}\n\t}\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br")])]),a("h5",{attrs:{id:"_7-5权重"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-5权重"}},[s._v("#")]),s._v(" "),a("strong",[s._v("7.5权重")])]),s._v(" "),a("p",[s._v("搜索关键字为“游泳篮球”，如果结果中包含了“音乐”权重为10，包含了“跑步”权重为2。")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('POST /test/_search\n{\n\t"query": {\n\t\t"bool": {\n\t\t\t"must": {\n\t\t\t\t"match": {\n\t\t\t\t\t"hobby": {\n\t\t\t\t\t\t"query": "游泳篮球",\n\t\t\t\t\t\t"operator": "and"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t"should": [{\n\t\t\t\t\t"match": {\n\t\t\t\t\t\t"hobby": {\n\t\t\t\t\t\t\t"query": "音乐",\n\t\t\t\t\t\t\t"boost": 10\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t"match": {\n\t\t\t\t\t\t"hobby": {\n\t\t\t\t\t\t\t"query": "跑步",\n\t\t\t\t\t\t\t"boost": 2\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t},\n\t"highlight": {\n\t\t"fields": {\n\t\t\t"hobby": {}\n\t\t}\n\t}\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("h1",{attrs:{id:"_8-elasticsearch集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-elasticsearch集群"}},[s._v("#")]),s._v(" "),a("strong",[s._v("8.Elasticsearch集群")])]),s._v(" "),a("h5",{attrs:{id:"_192-168-204-209-elasticsearch-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_192-168-204-209-elasticsearch-yml"}},[s._v("#")]),s._v(" "),a("strong",[s._v("192.168.204.209  elasticsearch.yml")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('cluster.name: luban\nnode.name: node-1\nnode.master: true\nnode.data: true\nnetwork.host: 0.0.0.0\nhttp.port: 9200\n#参数设置一系列符合主节点条件的节点的主机名或 IP 地址来引导启动集群。\ncluster.initial_master_nodes: ["node-1"]\n# 设置新节点被启动时能够发现的主节点列表（主要用于不同网段机器连接）\ndiscovery.zen.ping.unicast.hosts: ["192.168.204.209","192.168.204.203","192.168.204.108"]\n# 该参数就是为了防止”脑裂”的产生。定义的是为了形成一个集群，有主节点资格并互相连接的节点的最小数目。\ndiscovery.zen.minimum_master_nodes: 2\n# 解决跨域问题配置\nhttp.cors.enabled: true\nhttp.cors.allow-origin: "*"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h5",{attrs:{id:"_192-168-204-203-elasticsearch-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_192-168-204-203-elasticsearch-yml"}},[s._v("#")]),s._v(" "),a("strong",[s._v("192.168.204.203  elasticsearch.yml")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('cluster.name: luban\nnode.name: node-3\nnode.master: true\nnode.data: true\nnetwork.host: 0.0.0.0\nhttp.port: 9200\ncluster.initial_master_nodes: ["node-1"]\ndiscovery.zen.ping.unicast.hosts: ["192.168.204.209","192.168.204.203","192.168.204.108"]\ndiscovery.zen.minimum_master_nodes: 2\nhttp.cors.enabled: true\nhttp.cors.allow-origin: "*"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h5",{attrs:{id:"_192-168-204-108-elasticsearch-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_192-168-204-108-elasticsearch-yml"}},[s._v("#")]),s._v(" "),a("strong",[s._v("192.168.204.108  elasticsearch.yml")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('cluster.name: luban\nnode.name: node-2\nnode.master: true\nnode.data: true\nnetwork.host: 0.0.0.0\nhttp.port: 9200\ncluster.initial_master_nodes: ["node-1"]\ndiscovery.zen.ping.unicast.hosts: ["192.168.204.209","192.168.204.203","192.168.204.108"]\ndiscovery.zen.minimum_master_nodes: 2\nhttp.cors.enabled: true\nhttp.cors.allow-origin: "*"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[a("strong",[s._v("启动后效果")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/571262/1576820901979-015b0c6c-7e6c-4342-9b8b-ecc868cea24c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_49%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("h3",{attrs:{id:"一台机器搭建集群-一"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一台机器搭建集群-一"}},[s._v("#")]),s._v(" "),a("strong",[s._v("一台机器搭建集群(一)")])]),s._v(" "),a("p",[a("strong",[s._v("注意修改jvm.options")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/571262/1576820948015-c0e7c45d-0512-4a4d-bed1-7c18e696e358.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_33%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("h5",{attrs:{id:"elasticsearch-7-3-2-node1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch-7-3-2-node1"}},[s._v("#")]),s._v(" "),a("strong",[s._v("elasticsearch-7.3.2_node1")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('cluster.name: luban\nnode.name: node-1\nnode.master: true\nnode.data: true\nnetwork.host: 0.0.0.0\nhttp.port: 9200\ntransport.port: 9300\ncluster.initial_master_nodes: ["node-1"]\ndiscovery.seed_hosts: ["192.168.204.209:9300", "192.168.204.209:9301","192.168.204.209:9302"]\ndiscovery.zen.minimum_master_nodes: 2\nhttp.cors.enabled: true\nhttp.cors.allow-origin: "*"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h5",{attrs:{id:"elasticsearch-7-3-2-node2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch-7-3-2-node2"}},[s._v("#")]),s._v(" "),a("strong",[s._v("elasticsearch-7.3.2_node2")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('cluster.name: luban\nnode.name: node-2\nnode.master: true\nnode.data: true\nnetwork.host: 0.0.0.0\nhttp.port: 9201\ntransport.port: 9301\ncluster.initial_master_nodes: ["node-1"]\ndiscovery.seed_hosts: ["192.168.204.209:9300", "192.168.204.209:9301","192.168.204.209:9302"]\ndiscovery.zen.minimum_master_nodes: 2\nhttp.cors.enabled: true\nhttp.cors.allow-origin: "*"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h5",{attrs:{id:"elasticsearch-7-3-2-node3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch-7-3-2-node3"}},[s._v("#")]),s._v(" "),a("strong",[s._v("elasticsearch-7.3.2_node3")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('cluster.name: luban\nnode.name: node-3\nnode.master: true\nnode.data: true\nnetwork.host: 0.0.0.0\nhttp.port: 9202\ntransport.port: 9302\ncluster.initial_master_nodes: ["node-1"]\ndiscovery.seed_hosts: ["192.168.204.209:9300", "192.168.204.209:9301","192.168.204.209:9302"]\ndiscovery.zen.minimum_master_nodes: 2\nhttp.cors.enabled: true\nhttp.cors.allow-origin: "*"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[a("strong",[s._v("分别启动：")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("./elasticsearch -p /tmp/elasticsearch_9200_pid -d\n./elasticsearch -p /tmp/elasticsearch_9201_pid -d\n./elasticsearch -p /tmp/elasticsearch_9202_pid -d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"一台机器搭建集群-二"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一台机器搭建集群-二"}},[s._v("#")]),s._v(" "),a("strong",[s._v("一台机器搭建集群(二)")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/571262/1576820965687-64e088a5-a8d8-42b7-90d1-9630f41bc0cd.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_32%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("p",[a("strong",[s._v("新建目录：")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/571262/1576820979069-b366fbdd-e305-4007-8dd0-580d170238c9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_20%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),s._v(" "),a("p",[a("strong",[s._v("注意赋予权限")])]),s._v(" "),a("p",[a("strong",[s._v("chown -R taibai:taibai ES")])]),s._v(" "),a("p",[a("strong",[s._v("分别启动：")])]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("./elasticsearch -d  -E node.name=node-1 -E http.port=9200 -E transport.port=9300 -E path.data=/ES/data/node1 -E path.logs=/ES/logs/node1\n\n./elasticsearch -d  -E node.name=node-2 -E http.port=9201 -E transport.port=9301 -E path.data=/ES/data/node2 -E path.logs=/ES/logs/node2\n\n./elasticsearch -d  -E node.name=node-3 -E http.port=9202 -E transport.port=9302 -E path.data=/ES/data/node3 -E path.logs=/ES/logs/node3\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/jiankunking/article/details/65448030",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[s._v("https://blog.csdn.net/jiankunking/article/details/65448030")]),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/lixiaohai_918/article/details/89569611",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[s._v("https://blog.csdn.net/lixiaohai_918/article/details/89569611")]),a("OutboundLink")],1)]),s._v(" "),a("p",[a("strong",[s._v("查看插件命令：./elasticsearch-plugin list")])]),s._v(" "),a("p",[a("strong",[s._v("下载插件命令：./elasticsearch-plugin install analysis-icu")])]),s._v(" "),a("h1",{attrs:{id:"elasticstack日志收集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticstack日志收集"}},[s._v("#")]),s._v(" ElasticStack日志收集")]),s._v(" "),a("p",[s._v("1.安装filebeat")]),s._v(" "),a("p",[s._v("新建xxx.yml")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('filebeat.inputs:\n- type: log\n  enabled: true\n  paths: \n   - /taibai/logs/*.log\noutput.logstash:\n  hosts: ["192.168.204.209:5044"]\n  \n#output.console:\n#  pretty: true\n#  enable: true\n\n#filebeat.inputs:\n#  tags: ["web"] #添加自定义tag，便于后续的处理\n#  fields: #添加自定义字段\n#     from: taibai\n#  fields_under_root: true #true为添加到根节点，false为添加到子节点中\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("启动 ./filebeat -e -c 配置文件名    -e输出到标准输出，默认输出到syslog和logs下  -c 指定配置文件")]),s._v(" "),a("p",[s._v("2.安装logstash")]),s._v(" "),a("p",[s._v("​\t新建xxx.conf")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('input {\n   beats {\n     port => "5044"\n   }\n}\nfilter {\n    mutate {\n      split => {"message"=>","}\n    }\n    mutate {\n        add_field => {\n         "log" => "%{[message][0]}"\n         "userId" => "%{[message][1]}"\n         "visit" => "%{[message][2]}"\n         "date" => "%{[message][3]}"\n        }\n    }\n    mutate {\n       convert => {\n          "log" => "string"\n          "userId" => "integer"\n          "visit" => "string"\n          "date" => "string"\n        }\n    }\n}\n\noutput {\n   elasticsearch {\n      hosts => [ "192.168.204.209:9200"]\n   }\n}\n\n\n#output {\n#  stdout { codec => rubydebug }\n#}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("p",[s._v("启动： ./logstash -f  配置文件名")]),s._v(" "),a("h1",{attrs:{id:"数据导入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据导入"}},[s._v("#")]),s._v(" 数据导入")]),s._v(" "),a("h2",{attrs:{id:"_1-使用logstash-导入数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-使用logstash-导入数据"}},[s._v("#")]),s._v(" 1.使用logstash 导入数据")]),s._v(" "),a("p",[s._v("1.安装解压logstash")]),s._v(" "),a("p",[s._v("2.在conf目录下新建mysql.conf")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v('input {\n    jdbc {\n        jdbc_driver_library => "/opt/mysql-connector-java-5.1.47.jar"\n        jdbc_driver_class => "com.mysql.jdbc.Driver"\n        jdbc_connection_string => "jdbc:mysql://47.94.158.155:3306/test?serverTimezone=UCT"\n        jdbc_user => "taibai"\n        jdbc_password => "aq1sw2de"\n        schedule => "* * * * *"      #每分钟执行\n        clean_run => true\n        jdbc_default_timezone => "Asia/Shanghai"\n        statement => "select id,sn,`name`,price,num,alert_num,image,images,weight,DATE_FORMAT(update_time,\'%Y-%m-%d %T\') as update_time,DATE_FORMAT(create_time,\'%Y-%m-%d %T\') as create_time,spu_id,category_id,category_name,brand_name,spec,sale_num,comment_num,`status` from goods where update_time>:sql_last_value and update_time<NOW() order by update_time desc\n"\n   }\n}\n\nfilter {\n    ruby {\n        code => "event.set(\'timestamp\', event.get(\'@timestamp\').time.localtime + 8*60*60)"\n    }\n    ruby {\n       code => "event.set(\'@timestamp\',event.get(\'timestamp\'))"\n    }\n    mutate {\n        remove_field => ["timestamp"]\n    }\n#    ruby {\n#        code => "event.set(\'update_time\', event.get(\'update_time\').time.localtime + 8*60*60)"\n#    }\n#    ruby {\n#        code => "event.set(\'create_time\', event.get(\'create_time\').time.localtime + 8*60*60)"\n#    }\n}\n\noutput {\n       elasticsearch{\n          hosts => ["192.168.204.209"]\n               index => "goods"\n               document_id => "%{id}"\n          }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("p",[a("strong",[s._v("schedule")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("em",[a("strong",[s._v("* 5 * 1-3 *")])])]),s._v(" "),a("th",[s._v("从一月到三月每天早上5点的每一分钟都会执行。")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("0 * * * *")]),s._v(" "),a("td",[s._v("会在每天每小时的第0分钟执行。")])]),s._v(" "),a("tr",[a("td",[s._v("0 6 * * * America/Chicago")]),s._v(" "),a("td",[s._v("每天早上6点(UTC/GMT -5)执行。")])])])]),s._v(" "),a("p",[s._v("上课问题解释：上课时演示增加一条数据之后，导入到Elasticsearch数据是有的，但是有几个字段没有数据，可以发现没数据的几个字段是这条数据后面的几个字段，是因老师是在Navicat 直接添加，然而后面那几个字段可以为空，所以数据被添加到了数据库。总结来说就是前面添加了一条数据，没有后面那三个字段，后面我写那三个字段的时候相当于修改，然而修改我又没修改最后修改的时间字段(正常情况修改了数据需要修改最后更新时间字段)，所有我们的sql查询不到我们修改的数据，导致elasticsearch中那条数据有几个字段没有")]),s._v(" "),a("h2",{attrs:{id:"_2-canal"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-canal"}},[s._v("#")]),s._v(" 2.canal")]),s._v(" "),a("h3",{attrs:{id:"_1-mysql开启binlog日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-mysql开启binlog日志"}},[s._v("#")]),s._v(" 1.mysql开启binlog日志")]),s._v(" "),a("p",[s._v("重启：service mysqld restart")]),s._v(" "),a("h3",{attrs:{id:"_2-安装启动canal-deployer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装启动canal-deployer"}},[s._v("#")]),s._v(" 2.安装启动canal_deployer")]),s._v(" "),a("p",[s._v("1.上传到linux，解压")]),s._v(" "),a("p",[s._v("2.修改canal_deployer/conf/example/instance.properties")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("## mysql serverId\ncanal.instance.mysql.slaveId = 1234\n#position info，需要改成自己的数据库信息\ncanal.instance.master.address = 127.0.0.1:3306 \ncanal.instance.master.journal.name = \ncanal.instance.master.position = \ncanal.instance.master.timestamp = \n#canal.instance.standby.address = \n#canal.instance.standby.journal.name =\n#canal.instance.standby.position = \n#canal.instance.standby.timestamp = \n#username/password，需要改成自己的数据库信息\ncanal.instance.dbUsername = canal  \ncanal.instance.dbPassword = canal\ncanal.instance.defaultDatabaseName =\ncanal.instance.connectionCharset = UTF-8\n#table regex\ncanal.instance.filter.regex = .\\*\\\\\\\\..\\*\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("启动：bin/startup.sh")]),s._v(" "),a("p",[s._v("关闭：bin/stop.sh")]),s._v(" "),a("h3",{attrs:{id:"_3-安装canal-adapter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-安装canal-adapter"}},[s._v("#")]),s._v(" 3.安装canal_adapter")]),s._v(" "),a("p",[s._v("1.上传解压")]),s._v(" "),a("p",[s._v("2.修改canal_adapter/conf/application.yml")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("canal.conf:\n  canalServerHost: 127.0.0.1:11111\n  batchSize: 500\n  syncBatchSize: 1000\n  retries: 0\n  timeout:\n  mode: tcp \n  srcDataSources:\n    defaultDS:\n      url: jdbc:mysql://127.0.0.1:3306/mytest?useUnicode=true\n      username: root\n      password: 121212\n  canalAdapters:\n  - instance: example \n    groups:\n    - groupId: g1\n      outerAdapters:\n      - \n        key: exampleKey\n        name: es6                           # or es7\n        hosts: 127.0.0.1:9300               # es 集群地址, 逗号分隔\n        properties:\n          mode: transport # or rest         # 可指定transport模式或者rest模式\n          # security.auth: test:123456      # only used for rest mode\n          cluster.name: elasticsearch       # es cluster name\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("adapter将会自动加载 conf/es 下的所有.yml结尾的配置文件")]),s._v(" "),a("p",[s._v("3.修改适配器表映射文件")]),s._v(" "),a("div",{staticClass:"language-plain line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-plain"}},[a("code",[s._v("dataSourceKey: defaultDS        # 源数据源的key, 对应上面配置的srcDataSources中的值\nouterAdapterKey: exampleKey     # 对应application.yml中es配置的key \ndestination: example            # cannal的instance或者MQ的topic\ngroupId:                        # 对应MQ模式下的groupId, 只会同步对应groupId的数据\nesMapping:\n  _index: mytest_user           # es 的索引名称\n  _type: _doc                   # es 的type名称, es7下无需配置此项\n  _id: _id                      # es 的_id, 如果不配置该项必须配置下面的pk项_id则会由es自动分配\n#  pk: id                       # 如果不需要_id, 则需要指定一个属性为主键属性\n  # sql映射\n  sql: \"select a.id as _id, a.name as _name, a.role_id as _role_id, b.role_name as _role_name,\n        a.c_time as _c_time, c.labels as _labels from user a\n        left join role b on b.id=a.role_id\n        left join (select user_id, group_concat(label order by id desc separator ';') as labels from label\n        group by user_id) c on c.user_id=a.id\"\n#  objFields:\n#    _labels: array:;           # 数组或者对象属性, array:; 代表以;字段里面是以;分隔的\n#    _obj: object               # json对象\n  etlCondition: \"where a.c_time>='{0}'\"     # etl 的条件参数\n  commitBatch: 3000                         # 提交批大小\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("sql支持多表关联自由组合, 但是有一定的限制:")]),s._v(" "),a("ol",[a("li",[s._v("主表不能为子查询语句")]),s._v(" "),a("li",[s._v("只能使用left outer join即最左表一定要是主表")]),s._v(" "),a("li",[s._v("关联从表如果是子查询不能有多张表")]),s._v(" "),a("li",[s._v("主sql中不能有where查询条件(从表子查询中可以有where条件但是不推荐, 可能会造成数据同步的不一致, 比如修改了where条件中的字段内容)")]),s._v(" "),a("li",[s._v("关联条件只允许主外键的'='操作不能出现其他常量判断比如: on a.role_id=b.id and b.statues=1")]),s._v(" "),a("li",[s._v("关联条件必须要有一个字段出现在主查询语句中比如: on a.role_id=b.id 其中的 a.role_id 或者 b.id 必须出现在主select语句中")])]),s._v(" "),a("p",[s._v("Elastic Search的mapping 属性与sql的查询值将一一对应(不支持 select "),a("em",[s._v("), 比如: select a.id as _id, a.name, a.email as "),a("em",[s._v("email from user, 其中name将映射到es mapping的name field,")]),s._v(" email将 映射到mapping的")]),s._v("email field, 这里以别名(如果有别名)作为最终的映射字段. 这里的*id可以填写到配置文件的 "),a("em",[s._v("id:")]),s._v(" id映射.")]),s._v(" "),a("p",[s._v("4.bin目录下启动")])])}),[],!1,null,null,null);a.default=e.exports}}]);