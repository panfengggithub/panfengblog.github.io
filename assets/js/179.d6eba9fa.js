(window.webpackJsonp=window.webpackJsonp||[]).push([[179],{596:function(n,s,a){"use strict";a.r(s);var e=a(1),t=Object(e.a)({},(function(){var n=this,s=n._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("h1",{attrs:{id:"mongodb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mongodb"}},[n._v("#")]),n._v(" "),s("strong",[n._v("MongoDB")])]),n._v(" "),s("h1",{attrs:{id:"什么是mongodb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是mongodb"}},[n._v("#")]),n._v(" 什么是MongoDB")]),n._v(" "),s("p",[n._v("MongoDB是一个文档数据库，提供好的性能，领先的非关系型数据库。采用BSON存储文档数据。2007年10月，MongoDB由"),s("a",{attrs:{href:"https://link.zhihu.com/?target=https%3A//zh.wikipedia.org/w/index.php%3Ftitle%3D10gen%26action%3Dedit%26redlink%3D1",target:"_blank",rel:"noopener noreferrer"}},[n._v("10gen"),s("OutboundLink")],1),n._v("团队所发展。2009年2月首度推出。MongoDB用c++编写的。")]),n._v(" "),s("h5",{attrs:{id:"优势"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#优势"}},[n._v("#")]),n._v(" 优势：")]),n._v(" "),s("ul",[s("li",[n._v("面向文档的存储：以 JSON 格式的文档保存数据。")]),n._v(" "),s("li",[n._v("任何属性都可以建立索引。")]),n._v(" "),s("li",[n._v("复制以及高可扩展性。")]),n._v(" "),s("li",[n._v("自动分片。")]),n._v(" "),s("li",[n._v("丰富的查询功能。")]),n._v(" "),s("li",[n._v("快速的即时更新。")]),n._v(" "),s("li",[n._v("来自 MongoDB 的专业支持。")])]),n._v(" "),s("h5",{attrs:{id:"elasticsearch与mongodb相同点与不同点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch与mongodb相同点与不同点"}},[n._v("#")]),n._v(" elasticsearch与MongoDB相同点与不同点")]),n._v(" "),s("p",[s("strong",[n._v("相同点：")])]),n._v(" "),s("p",[n._v("1、都是以json格式管理数据的nosql数据库。")]),n._v(" "),s("p",[n._v("2、都支持CRUD操作。")]),n._v(" "),s("p",[n._v("3、都支持聚合和全文检索。")]),n._v(" "),s("p",[n._v("4、都支持分片和复制。")]),n._v(" "),s("p",[n._v("5、都支持阉割版的join操作。")]),n._v(" "),s("p",[n._v("6、都支持处理超大规模数据。")]),n._v(" "),s("p",[s("strong",[n._v("不同点：")])]),n._v(" "),s("p",[n._v("1、es是java编写，通过RESTFul接口操作数据。mongodb是C++编写，通过driver操作数据。（es对java开发更有好，利于排查理解）")]),n._v(" "),s("p",[n._v("2、mongodb的分片有hash和range两种方式，es只有hash一种。")]),n._v(" "),s("p",[n._v("3、es是天生分布式，主副分片自动分配和复制，开箱即用。mongodb的分布式是由“前置查询路由+配置服务+shard集合”，需要手动配置集群服务。")]),n._v(" "),s("p",[n._v("4、内部存储ES是到排索引+docvalues+fielddata。mongodb暂时未知。")]),n._v(" "),s("p",[n._v("5、es全文检索有强大的分析器且可以灵活组合，查询时智能匹配。mongodb的全文检索字段个数有限制。")]),n._v(" "),s("p",[n._v("6、es所有字段自动索引，mongodb的字段需要手动索引。")]),n._v(" "),s("p",[n._v("7、MongoDB支持多文档事务")]),n._v(" "),s("p",[n._v("mongorestore -d taibai /opt/stocks：  导入数据命令")]),n._v(" "),s("p",[n._v("MongoDB特性：灵活性，可扩展性，强大的查询语言，优异的性能")]),n._v(" "),s("h1",{attrs:{id:"mongodb安装与启动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mongodb安装与启动"}},[n._v("#")]),n._v(" mongodb安装与启动")]),n._v(" "),s("p",[n._v("mongodb下载网址:   https://www.mongodb.com/download-center/community")]),n._v(" "),s("p",[n._v("选择版本、系统环境、包  。以下将以TGZ 为例")]),n._v(" "),s("p",[n._v("下载完成将得到mongodb-linux-x86_64-rhel70-4.2.3.tgz包，将其上传到linux（sentos7）某个目录")]),n._v(" "),s("p",[n._v("上传完成后解压并移动到/usr/local/mongodb目录")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mv mongodb-linux-x86_64-rhel70-4.2.3 /usr/local/mongodb\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("创建专门的负责的用户并赋予权限")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("cd /usr/local/mongodb \ngroupadd mongodb\nuseradd -s /sbin/nologin -g mongodb -M mongodb\nmkdir data log run\nchown -R mongodb:mongodb data log run\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("p",[n._v("在/usr/local/mongodb 里面创建一个配置文件 mongodb.conf")]),n._v(" "),s("p",[n._v("vim mongodb.conf  并写入下面的信息:")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("bind_ip=0.0.0.0\nport=27017\ndbpath=/usr/local/mongodb/data/\nlogpath=/usr/local/mongodb/log/mongodb.log\npidfilepath =/usr/local/mongodb/run/mongodb.pid\nlogappend=true\nfork=true    \nmaxConns=500\nnoauth = true\n\n\n配置解释：\nfork=true   运行在后台\nlogappend=true  如果为 true，当 mongod/mongos 重启后，将在现有日志的尾部继续添加日志。否则，将会备份当前日志文件，然后创建一个新的日志文件；默认为 false。\nnoauth = true  不需要验证用户密码\nmaxConns=500 最大同时连接数 默认2000\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br")])]),s("p",[n._v("以上是MongoDB的安装与启动的准备工作，可直接启动  启动命令：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("/usr/local/mongodb/bin/mongod -f /usr/local/mongodb/mongodb.conf\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("strong",[n._v("配置环境变量")])]),n._v(" "),s("p",[n._v("vim /etc/profile")]),n._v(" "),s("p",[n._v("在/etc/profile文件末尾添加一行:")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v(" export PATH=/usr/local/mongodb/bin:$PATH\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("让其生效:")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("source /etc/profile\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("查看当前mongodb的版本:")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mongod --version\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("h1",{attrs:{id:"mongodb的crud"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mongodb的crud"}},[n._v("#")]),n._v(" MongoDB的crud")]),n._v(" "),s("p",[n._v("执行mongo命令连接MongoDB")]),n._v(" "),s("h4",{attrs:{id:"数据库的操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据库的操作"}},[n._v("#")]),n._v(" 数据库的操作")]),n._v(" "),s("p",[n._v("MongoDB自带的原始数据库：")]),n._v(" "),s("p",[n._v("admin：从权限角度来看，这是“root”数据库。如果将一个用户添加到这个数据库。这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器")]),n._v(" "),s("p",[n._v("local：这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合")]),n._v(" "),s("p",[n._v("config：当mongo用于分片设置时，config数据库在内部使用。用于保存分片的相关信息")]),n._v(" "),s("p",[s("strong",[n._v("查看")]),n._v("：show dbs")]),n._v(" "),s("p",[s("strong",[n._v("创建")]),n._v("：use 数据库名")]),n._v(" "),s("p",[n._v("使用use时，如果数据库存在则会进入到相应的数 据库，如果不存在则会自动创建 – 一旦进入数据库，则可以使用db来引用当前库 ;如果是第一次创建，那个这个数据库只是存在于内存当中，直到这个数据库中创建了集合后才会持久化到磁盘上")]),n._v(" "),s("p",[s("strong",[n._v("删除")]),n._v("：db.dropDatabase()")]),n._v(" "),s("p",[n._v("用于删除已经持久化的数据库，刚创建在内存中的数据库删除无效")]),n._v(" "),s("h4",{attrs:{id:"集合的操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#集合的操作"}},[n._v("#")]),n._v(" 集合的操作")]),n._v(" "),s("p",[n._v('**创建：**db.createCollection("集合名称")')]),n._v(" "),s("p",[s("strong",[n._v("查看：")]),n._v(" show  tables  或者  show collections")]),n._v(" "),s("p",[n._v("**删除：**db.集合名称.drop()")]),n._v(" "),s("h4",{attrs:{id:"文档的操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文档的操作"}},[n._v("#")]),n._v(" 文档的操作")]),n._v(" "),s("p",[s("strong",[n._v("添加：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.insert({name:"猪八戒",age:28,gender:"男"});   \n\ndb.xyj.insertOne({_id:"workd",name:"猪八戒",age:28,gender:"男"});\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("xyj是集合名称，如果该集合还没有被创建，则会自动创建")]),n._v(" "),s("p",[s("strong",[n._v("批量添加：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.insert([\n     {name:"沙和尚",age:38,gender:"男"},\n     {name:"白骨精",age:16,gender:"女"},\n     {name:"蜘蛛精",age:14,gender:"女"}\n]);\n\ndb.xyj.insertMany([\n     {name:"沙和尚",age:38,gender:"男"},\n     {name:"白骨精",age:16,gender:"女"},\n     {name:"蜘蛛精",age:14,gender:"女"}\n]);\n\n\ndb.collection.insertOne()     插入一个文档对象\ndb.collection.insertMany()    插入多个文档对象\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br")])]),s("p",[n._v("当我们向集合中插入文档时，如果没有给文档指定 "),s("em",[n._v("id属性，则数据库会自动为文档添加")]),n._v(" id该属性用来作为文档的唯一标识  "),s("em",[n._v("id我们可以自己指定，如果我们指定了数据库就不会在添加了，如果自己指定")]),n._v(" id 也必须确保它的唯一性")]),n._v(" "),s("p",[s("strong",[n._v("额外小知识")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('try{\n\tdb.xyj.insert([\n      {name:"沙和尚",age:38,gender:"男"},\n      {name:"白骨精",age:16,gender:"女"},\n      {name:"蜘蛛精",age:14,gender:"女"}\n    ]);\n}catch(e){\n\tprint(e)\n}\n\n可以知道那条插入失败\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br")])]),s("p",[n._v('**覆盖修改：**db.xyj.update({_id:"hello"},{age:NumberInt(30)})')]),n._v(" "),s("p",[n._v("执行效果：_id:hello这条数据只有age一个字段了")]),n._v(" "),s("p",[s("strong",[n._v("局部修改：")]),n._v(' db.xyj.update({_id:"workd"},{$set:{age:NumberInt(30)}})')]),n._v(" "),s("p",[n._v("执行效果：只会修改这条数据的某个字段")]),n._v(" "),s("p",[s("strong",[n._v("批量修改：")]),n._v(' db.xyj.update({name:"蜘蛛精"},{$set:{age:NumberInt(100)}},{multi:true})')]),n._v(" "),s("p",[n._v("在修改条数据时，必须要加上第三个参数，否则只会修改一条数据")]),n._v(" "),s("p",[s("strong",[n._v("字段增加操作：")]),n._v(' db.xyj.update({_id:"workd")},{$inc:{age:NumberInt(1)}})')]),n._v(" "),s("p",[n._v("注意："),s("code",[n._v("$inc")]),n._v("对应的字段必须是数字，而且递增或递减的值也必须是数字。")]),n._v(" "),s("p",[s("strong",[n._v("删除文档：")]),n._v(' db.xyj.remove({_id:"workd"})')]),n._v(" "),s("p",[s("strong",[n._v("删除文档字段：")]),n._v(' db.xyj.update({"_id":123}, {"$unset": {"name":1}})')]),n._v(" "),s("p",[s("code",[n._v("$unset")]),n._v("指定字段的值只需是任意合法值即可。")]),n._v(" "),s("p",[s("strong",[n._v("删除所有：")]),n._v("  db.xyj.remove({})")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('插入测试数据\n\ndb.xyj.insertMany([\n     {name:"沙和尚",age:38,gender:"男",hobby:["打篮球","吃喝"]},\n     {name:"白骨精",age:16,gender:"女",hobby:["吃喝"]},\n     {name:"蜘蛛精",age:14,gender:"女",hobby:["跑步","打乒乓球"]},\n\t {name:"唐生",age:25,gender:"男",hobby:["坐禅","吃喝"]}\n]);\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br")])]),s("p",[n._v("数组添加：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.update({"name": "白骨精"}, {"$push": {"hobby": "念佛"}})\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("删除元素（"),s("code",[n._v("$pop")]),n._v("）：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.update({"_id": ObjectId("5e80950a2b2f5820a1958a43")}, {"$pop": {"hobby": 1}})  // 删除最后一个元素\ndb.xyj.update({"_id": ObjectId("5e80950a2b2f5820a1958a43")}, {"$pop": {"hobby": -1}})  // 删除第一个元素\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[n._v("删除特定元素（"),s("code",[n._v("$pull")]),n._v("）：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.update({"_id": ObjectId("5e80950a2b2f5820a1958a44")}, {"$pull": {"hobby": "跑步" }})\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("更新嵌套数组的值：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.insert({name:"猪八戒",age:28,gender:"男",address: [{place: "nanji", tel: 123}, {place: "dongbei", tel: 321}]});\n\n\ndb.xyj.update({"_id": ObjectId("5e809fc665a1965fdc792fc8")}, {"$set": {"address.0.tel": 213}})\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("p",[n._v("数组查询：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.find({"hobby":"跑步"})\n\n多个元素的查询\ndb.xyj.find({"hobby":{"$all": ["跑步", "打乒乓球"]}})\n只有hobby数组同时存在跑步和打乒乓球才会匹配\n\n限制数组长度查询\ndb.xyj.find({"hobby": {"$size": 2}})\n只有数组的长度是2才会匹配\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br")])]),s("p",[s("strong",[n._v("查看所有：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mongodb:   db.xyj.find()\nsql:   select * from xyj\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[s("strong",[n._v("投影查询：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('mongodb:   db.xyj.find({name:"猪八戒"},{name:1,_id:0})   \nsql:   select name from xyj where name= "猪八戒"\n1表示显示 0表示强制隐藏\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[s("strong",[n._v("按字段条件查询：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('mongodb:   db.xyj.find({name:"猪八戒"})\nsql:   select * from xyj where name= "猪八戒"\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[s("strong",[n._v("按字段条件查询并只返回一条：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.findOne({name:"猪八戒"})\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("strong",[n._v("组合查询：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("语法：db.xyj.find($and:[{},{},{}])\n//查询年级大于20小于50的\ndb.xyj.find({$and:[{age:{$gt:NumberInt(20)}},{age:{$lt:NumberInt(50)}}]})  \n//查询名字里有”精“的或者年纪大于30的\ndb.xyj.find({$or:[{age:{$gt:NumberInt(30)}},{name:/精/}]})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("p",[s("strong",[n._v("比较查询：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v(" db.xyj.find({age:{$gt:NumberInt(20)}})  //查询年级大于20岁的\n \n$gt--》大于     $lt--》小于   $gte--》大于等于     $lte--》小于等于   $ne---》不等于(不等于不一定要用于数字)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[s("strong",[n._v("包含查询：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v(" db.xyj.find({age:{$in:[28,38]}})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("strong",[n._v("不包含：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v(" db.xyj.find({age:{$nin:[28,38]}})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("strong",[n._v("Like：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.find({"name": /精/})\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("strong",[n._v("统计查询:")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.xyj.count()或者db.xyj.count({字段：条件})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("strong",[n._v("取模：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.find({"age": {$mod: [5, 1]}})\n比如我们要匹配 age % 5 == 1\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[s("strong",[n._v("是否存在（$exists)")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.find({"love": {"$exists": true}})  // 如果存在字段love，就返回\ndb.xyj.find({"love": {"$exists": false}}) // 如果不存在字段love，就返回\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("h4",{attrs:{id:"分页查询"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分页查询"}},[n._v("#")]),n._v(" 分页查询")]),n._v(" "),s("p",[n._v("limit：显示几条记录")]),n._v(" "),s("p",[n._v("skip：跳过几条记录")]),n._v(" "),s("p",[n._v("第一次查询：db.xyj.find().limit(2)")]),n._v(" "),s("p",[n._v("第一次查询：db.xyj.find().limit(2).skip(2)")]),n._v(" "),s("p",[n._v("结合排序：db.xyj.find().limit(2).skip(2).sort({age:1})  //  1代表升序，-1代表降序")]),n._v(" "),s("p",[n._v("执行顺序： sort > skip > limit")]),n._v(" "),s("h4",{attrs:{id:"聚合管道"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#聚合管道"}},[n._v("#")]),n._v(" "),s("strong",[n._v("聚合管道")])]),n._v(" "),s("p",[n._v("较常见的管道操作符以及他们的作用：")]),n._v(" "),s("table",[s("thead",[s("tr",[s("th",[n._v("操作符")]),n._v(" "),s("th",[n._v("描述")]),n._v(" "),s("th",[n._v("语法")])])]),n._v(" "),s("tbody",[s("tr",[s("td",[n._v("$project")]),n._v(" "),s("td",[n._v("数据投影，主要用于重命名，增加，删除字段")]),n._v(" "),s("td",[s("code",[n._v("db.article.aggregate({ $project : {title : 1 ,author : 1 ,}});")])])]),n._v(" "),s("tr",[s("td",[n._v("$match")]),n._v(" "),s("td",[n._v("过滤，筛选符合条件的文档，作为下一阶段输入")]),n._v(" "),s("td",[s("code",[n._v("db.articles.aggregate( [{ $match : { score : { $gt : 70, $lte : 90 } } },{ $group: { _id: null, count: { $sum: 1 } } }] );")])])]),n._v(" "),s("tr",[s("td",[n._v("$limit")]),n._v(" "),s("td",[n._v("限制经过管道的文档数量")]),n._v(" "),s("td",[s("code",[n._v("db.article.aggregate({ $limit : 5 });")])])]),n._v(" "),s("tr",[s("td",[n._v("$skip")]),n._v(" "),s("td",[n._v("待操作集合处理前跳过部分文档")]),n._v(" "),s("td",[s("code",[n._v("db.article.aggregate({ $skip : 5 });")])])]),n._v(" "),s("tr",[s("td",[n._v("$unwind")]),n._v(" "),s("td",[n._v("将数组拆分成独立字段")]),n._v(" "),s("td",[s("code",[n._v('db.article.aggregate({$project:{author:1,title:1,tags:1}},{$unwind:"$tags"})')])])]),n._v(" "),s("tr",[s("td",[n._v("$group")]),n._v(" "),s("td",[n._v("对数据进行分组")]),n._v(" "),s("td",[s("code",[n._v('db.article.aggregate({ $group : {_id : "$author",docsPerAuthor : { $sum : 1 },viewsPerAuthor : { $sum : "$pageViews" }}});')])])]),n._v(" "),s("tr",[s("td",[n._v("$sort")]),n._v(" "),s("td",[n._v("对文档按照指定字段排序")]),n._v(" "),s("td",[s("code",[n._v("db.users.aggregate( { $sort : { age : -1, posts: 1 } });")])])]),n._v(" "),s("tr",[s("td",[n._v("$sample")]),n._v(" "),s("td",[n._v("随机选择从其输入指定数量的文档。")]),n._v(" "),s("td",[s("code",[n._v("{ $sample: { size: <positive integer> } }")])])]),n._v(" "),s("tr",[s("td",[n._v("$out")]),n._v(" "),s("td",[n._v("必须为pipeline最后一个阶段管道，因为是将最后计算结果写入到指定的collection中")]),n._v(" "),s("td")]),n._v(" "),s("tr",[s("td",[n._v("$indexStats")]),n._v(" "),s("td",[n._v("返回数据集合的每个索引的使用情况")]),n._v(" "),s("td",[s("code",[n._v("{ $indexStats: { } }")])])])])]),n._v(" "),s("p",[n._v("插入测试数据")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("document1=({name:'dogOne',age:1,tags:['animal','dog'],type:'dog',money:[{min:100},{norm:200},{big:300}]});\n\ndocument2=({name:'catOne',age:3,tags:['animal','cat'],type:'cat',money:[{min:50},{norm:100},{big:200}]});\n\ndocument3=({name:'catTwo',age:2,tags:['animal','cat'],type:'cat',money:[{min:20},{norm:50},{big:100}]});\n\ndocument4=({name:'dogTwo',age:5,tags:['animal','dog'],type:'dog',money:[{min:300},{norm:500},{big:700}]});\n\ndocument5=({name:'appleOne',age:0,tags:['fruit','apple'],type:'apple',money:[{min:10},{norm:12},{big:13}]});\n\ndocument6=({name:'appleTwo',age:0,tags:['fruit','apple'],type:'apple',money:[{min:10},{norm:12},{big:13}]});\n\ndocument7=({name:'pineapple',age:0,tags:['fruit','pineapple'],type:'pineapple',money:[{min:8},{norm:9},{big:10}]});\n\ndb.mycol.insert(document1)\n\ndb.mycol.insert(document2)\n\ndb.mycol.insert(document3)\n\ndb.mycol.insert(document4)\n\ndb.mycol.insert(document5)\n\ndb.mycol.insert(document6)\n\ndb.mycol.insert(document7)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br")])]),s("p",[n._v("假定我们想提取money中min为100的文档，并且只输出名称和money数组中的min那一项")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.mycol.aggregate(\n   {$match:{'money.min':100}},\n   {$project:{_id:0,name:'$name',minprice:'$money.min'}}\n)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("p",[n._v("假定我们想提取money中min小于100的文档，并且限制3个文档，跳过一个文档再显示")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.mycol.aggregate(\n\n    {$match:{'money.min':{$lt:100}}},\n\n    {$limit:3},\n\n    {$skip:1},\n\n    {$project:{_id:0,name:'$name',minprice:'$money.min'}}\n\n    )\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br")])]),s("p",[n._v("通过type类型来对数据进行分类，并且同时统计他们的年龄age总和")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.mycol.aggregate(\n    {$group:{_id:'$type',sumage:{$sum:'$age'}}}\n)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("按照年龄对数据进行排序")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.mycol.aggregate(\n    {$group:{_id:'$type',sumage:{$sum:'$age'}}},\n    {$sort:{sumage:1}}\n)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("h1",{attrs:{id:"文档模式设计的基本策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文档模式设计的基本策略"}},[n._v("#")]),n._v(" 文档模式设计的基本策略")]),n._v(" "),s("ul",[s("li",[n._v("其实很简单，我们一般建议的是先考虑内嵌， 直接按照你的对象模型来设计你的数据模型。如果你的对象模型数量不多，关系不是很复杂，那么恭喜你，可能直接一种对象对应一个集合就可以了。")]),n._v(" "),s("li",[n._v("内嵌是文档模型的特色，可以充分利用MongoDB的富文档功能来享受我们刚才谈到的一些文档模型的性能和扩展性等特性。一般的一对一、一对多关系，比如说一个人多个地址多个电话等等都可以放在一个文档里用内嵌来完成。")]),n._v(" "),s("li",[n._v("但是有一些时候，使用引用则难以避免。比如说， 一个明星的博客可能有几十万或者几百万的回复，这个时候如果把comments放到一个数组里，可能会超出16M的限制。这个时候你可以考虑使用引用的方式，在主表里存储一个id值，指向另一个表中的 id 值。使用引用要注意的就是：从性能上讲，一般我们可能需要两次以上才能把需要的数据取回来。更加重要的是：需要把数据存放到两个集合里，但是目前为止MongoDB并不支持跨表的事务性，所以对于强事务的应用场景要谨慎使用。")])]),n._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/571262/1586941809056-76f0095b-d910-4cac-ab95-46ec81d35f96.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_27%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),n._v(" "),s("p",[s("strong",[n._v("设计原则：")])]),n._v(" "),s("p",[n._v("为应用程序提供服务，而不是为了存储优化")]),n._v(" "),s("p",[n._v("为实现最佳性能而设计")]),n._v(" "),s("p",[s("strong",[n._v("购物车场景设计：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.cart.insert({\n  "userid": 1000,\n  "last_activity": new Date(),\n  "status": "active",\n  "items": [\n    {\n    "itemid": 1000,\n    "title": "mianbao",\n    "price": 5.00,\n    "quantity": 1,\n    "img_rul":["mianbao.jpg"]\n    }\n  ]\n});\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br")])]),s("p",[n._v("在这里我们把商品的一些主要信息放到购物车里了，比如说 name,price, quantity，为什么？ 读一次所有信息都拿到了：价格、数量等等，不需要再去查另一张表。这是一种比较常见的优化手段，用冗余的方式来提供读取性能。")]),n._v(" "),s("p",[n._v("向购物车添加数据：")]),n._v(" "),s("p",[n._v("比如说，如果我们想要往购物车里增加一个价值2元的面包，我们可以用下面的update语句。注意$push的用法。$push 类似于javascript的操作符，意思是往数组尾部增加一个元素。")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.cart.update({"_id": ObjectId("5e96a6e5064b2cd766b2b4de")},{"$push": {"items":{"itemid": 1001,"title": "niupai","price": 2.00,"quantity": 1,"img_url": "bread.jpg"}},$set:{"last_activity": new Date()}});\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("更新数量：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.cart.update({"_id": ObjectId("5e833a5acaea32e75f6f5b5e"),"items.itemid":1001}, {$set:{"items.$.quantity":5,"last_activity": new Date()}})\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("统计所有商品的总价：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.cart.aggregate(\n   [\n   {"$match":{"_id": ObjectId("5e96aa9f3bbe036e72bbc946")}},{"$unwind":"$items"},\n      {\n        $group : {\n           _id : null,\n           totalPrice: { $sum: { $multiply: [ "$items.price", "$items.quantity" ] } },\n           count: { $sum: 1 }\n        }\n      }\n   ]\n)\n\n$sum:1 :如果前面的情况出现一次,就加1, 如果后面$sum:2 那么每次前面条件满足一次就加2\n使用了$group:_id ：强制必须存在。可以为 null。\n _id : null：则意为对所有行进行分组统计，\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br")])]),s("p",[n._v("统计单个商品的总价：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.cart.aggregate(\n   [\n   {"$match":{"_id": ObjectId("5e833a5acaea32e75f6f5b5e")}},{"$unwind":"$items"},\n      { $project: {total_price: { $multiply: [ "$items.price", "$items.quantity" ] } } }\n   ]\n)\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br")])]),s("p",[s("strong",[n._v("社交网络案例：")])]),n._v(" "),s("p",[n._v("对于关系描述，使用文档模型的内嵌数组特性，我们可以很容易地把我关注的用户（following）和关注我的用户表示出来。下例表示TJ我的关注的用户是mandy和bert，而oscar和mandy则在关注我。这种模式是文档模型中最经典的。但是有一个潜在问题就是如果TJ我是一个明星，他们关注我的人可能有千万。一个千万级的数组会有两个问题：1） 有可能超出一个文档最大16M的硬性限制； 2） MongoDB数组太大会严重影响性能。")]),n._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/571262/1586941847893-a0a497d6-731a-4980-9c3b-b9f2c7cc0a06.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_26%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),n._v(" "),s("p",[n._v("怎么办？我们可以建立一个专门的集合来描述关注关系。这里就是一个内嵌和引用的经典选择。我们希望用内嵌，但是如果数组维度太大，就需要考虑用另外一个集合的方式来表示一对多的关系（用户 1–N 关注者）")]),n._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/571262/1586941880467-4a250fbe-6ca2-490b-bf98-3da1338179d9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_26%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),n._v(" "),s("h1",{attrs:{id:"索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引"}},[n._v("#")]),n._v(" 索引")]),n._v(" "),s("h4",{attrs:{id:"索引的类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引的类型"}},[n._v("#")]),n._v(" 索引的类型")]),n._v(" "),s("p",[s("strong",[n._v("单字段索引")])]),n._v(" "),s("p",[s("strong",[n._v("复合索引")])]),n._v(" "),s("p",[s("strong",[n._v("其他类型索引")])]),n._v(" "),s("p",[n._v("​\t哈希索引：是指按照某个字段的hash值来建立索引，目前主要用于MongoDB Sharded Cluster的Hash分片，hash索引只能满足字段完全匹配的查询，不能满足范围查询等。")]),n._v(" "),s("p",[n._v("​\t地理位置索引：能很好的解决O2O的应用场景，比如『查找附近的美食』、『查找某个区域内的车站』等。")]),n._v(" "),s("p",[n._v("​\t文本索引：能解决快速文本查找的需求，比如有一个博客文章集合，需要根据博客的内容来快速查找，则可以针对博客内容建立文本索引。")]),n._v(" "),s("h4",{attrs:{id:"索引的操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引的操作"}},[n._v("#")]),n._v(" 索引的操作")]),n._v(" "),s("h6",{attrs:{id:"创建匿名索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建匿名索引"}},[n._v("#")]),n._v(" 创建匿名索引")]),n._v(" "),s("p",[n._v("准备测试数据：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("for (var i = 1; i<= 100;i++) {\n   db.xyj.insert({name: 'taibai'+i,num: i});\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("查找"),s("code",[n._v("{num: 100}")]),n._v("文档的过程分析")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v(' db.xyj.find({num: 100}).explain(true)\n \n返回信息中：\n "stage" : "COLLSCAN",        意思为全表扫描\n executionTimeMillis" : 144   查询时间\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("p",[n._v("创建匿名索引")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.createIndex({num: 1})\n{\n        "createdCollectionAutomatically" : false,\n        "numIndexesBefore" : 1,  // 添加本次索引之前的索引数\n        "numIndexesAfter" : 2,   // 添加本次索引之后的索引数\n        "ok" : 1\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br")])]),s("p",[n._v("建立索引后再次查找")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v(' db.xyj.find({num: 100}).explain(true)\n \n "stage" : "IXSCAN", // 通过扫描索引进行查找\n "indexName" : "num_1",  // 如果没有指定索引名称的话， 默认格式为 ‘字段_1’ 或者 ‘字段_-1’ , 1 代表正序， -1 代表 倒序\n "executionTimeMillis" : 0,  // 本次执行时间的毫秒数为 0ms !!!\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("p",[n._v("创建命名索引")]),n._v(" "),s("p",[n._v("如果没有指定索引名称的话， 默认格式为 "),s("code",[n._v("fieldName_1")]),n._v(" 或者 "),s("code",[n._v("fieldName_-1")]),n._v("，如果想要自定义索引名称的话，可以在创建的时候指定名称，如下：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.xyj.createIndex({name: 1}, {name:' myIndexName'})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("查询索引：db.xyj.getIndexes()")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('[\n        {\n                "v" : 2,\n                "key" : {\n                        "_id" : 1\n                },\n                "name" : "_id_",\n                "ns" : "test.xyj"\n        },\n        {\n                "v" : 2,\n                "key" : {\n                        "num" : 1\n                },\n                "name" : "num_1",\n                "ns" : "test.xyj"\n        },\n        {\n                "v" : 2,\n                "key" : {\n                        "name" : 1\n                },\n                "name" : " myIndexName",\n                "ns" : "test.xyj"\n        }\n]\n\nv:版本号\nkey： 在那个字段创建了索引，是升序还是降序的\nname: 索引的名字\nns： 那个数据库的集合下\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br")])]),s("p",[n._v("指定需要使用的索引")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.find({num: "100"}).hint({num:1}).explain(true)   //hint指定强制使用哪个索引\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("h6",{attrs:{id:"创建复合索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建复合索引"}},[n._v("#")]),n._v(" 创建复合索引")]),n._v(" "),s("p",[n._v("查询的条件不止一个，需要用复合索引")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.xyj.createIndex({name:1,num:1});\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("h6",{attrs:{id:"创建ttl-过期-索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建ttl-过期-索引"}},[n._v("#")]),n._v(" 创建ttl（过期）索引")]),n._v(" "),s("hr"),n._v(" "),s("p",[n._v("mongodb也可以像redis一样给文档设置过期数据，建立ttl索引，这里设置了10秒钟的过期时间，10秒钟之后过期")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.classTwo.insert({time:new Date()});\ndb.classTwo.createIndex({time:1},{expireAfterSeconds:10});\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("ul",[s("li",[n._v("索引字段的值必须Date对象，不能是其它类型比如时间戳")]),n._v(" "),s("li",[n._v("删除时间不精确，每60秒跑一次。删除也要时间，所以有误差。")])]),n._v(" "),s("h6",{attrs:{id:"创建全文索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建全文索引"}},[n._v("#")]),n._v(" 创建全文索引")]),n._v(" "),s("p",[n._v("准备测试数据：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.xyj.insertMany([\n {"name" : "Lily", "content" : "I am a girl" },\n {"name" : "Tom", "content" : "I am a boy" },\n {"name" : "Carl", "content" : "I do not know boy girl"}\n ])\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("p",[n._v("创建全文索引：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.xyj.createIndex({content: 'text'})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("// 查找包含 ‘girl’ 的文档\n db.xyj.find({$text: {$search: 'girl'}})\n//查找包含 ‘girl’ 或者 ‘boy’ 的文档（多次查找是 与 的关系）\ndb.xyj.find({$text: {$search: 'boy girl'}})\n// 查找仅包含‘girl’ 不包含‘boy’的文档\ndb.xyj.find({$text: {$search: 'girl -boy'}})\n// 就是要查找包含 ‘girl boy’ 字符的文档（需要转义）\ndb.xyj.find({$text: {$search: '\\\"boy girl\\\"'}})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br")])]),s("p",[n._v("最大的问题,全文索引不支持中文。准确的来说，支持中文的能力没有想象中强大。")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.textIndexTest.insert({author:"杜甫",title:"绝句",article:"两个黄鹂鸣翠柳， 　　一行白鹭上青天。窗含西岭千秋雪，门泊东吴万里船。"})\ndb.textIndexTest.insert({author:"李白",title:"静夜思",article:"床前明月光，疑是地上霜。 举头望明月，低头思故乡。"})\ndb.textIndexTest.insert({author:"张 王",title:"你好",article:"测试数据"})\n\n创建索引\ndb.textIndexTest.createIndex( { author: "text" } )\n\ndb.textIndexTest.find({$text:{$search:"李白"}}) \ndb.textIndexTest.find({$text:{$search:"李"}}) \ndb.textIndexTest.find({$text:{$search:"王"}})\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br")])]),s("h6",{attrs:{id:"二维-地理位置-索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二维-地理位置-索引"}},[n._v("#")]),n._v(" 二维（地理位置）索引")]),n._v(" "),s("p",[n._v("准备测试数据：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.dili.insertMany([\n{ "gis" : [ 1, 1 ] },\n{ "gis" : [ 1, 2 ] },\n{ "gis" : [ 1, 3 ] },\n{ "gis" : [ 2, 1 ] },\n{ "gis" : [ 2, 2 ] },\n{ "gis" : [ 2, 3 ] },\n{ "gis" : [ 3, 1 ] },\n{ "gis" : [ 3, 2 ] },\n{ "gis" : [ 3, 3 ] }\n]);\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br")])]),s("p",[n._v("创建二维索引")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.dili.ensureIndex({gis:'2d'})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("查询距离"),s("code",[n._v("[1,1]")]),n._v("最近的四个点")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v(" db.dili.find({gis:{$near: [1,1]}}).limit(4)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("查询以点"),s("code",[n._v("[1,2]")]),n._v("和点"),s("code",[n._v("[3,3]")]),n._v("为对角线的正方形中的所有的点")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.dili.find({gis: {$within:{$box: [[1,2],[3,3]]}}})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("查出以"),s("code",[n._v("[2,2]")]),n._v("为圆心，以"),s("code",[n._v("1")]),n._v(" 为半径为规则下圆心面积中的点")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.dili.find({gis: {$within:{$center: [[2,2],1]}}})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("删除索引： db.集合名称.dropIndex( 索引名称或者 创建时的条件 )   //如果是文本索引，只能通过名字删")]),n._v(" "),s("p",[n._v("db.xyj.dropIndex({age:1})  //条件")]),n._v(" "),s("p",[n._v('db.xyj.dropIndex("age_1")//名称')]),n._v(" "),s("p",[n._v("db.xyj.dropIndexes()  //删除所有索引  自带的这个id的索引是不会删除的")]),n._v(" "),s("h1",{attrs:{id:"副本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#副本"}},[n._v("#")]),n._v(" 副本")]),n._v(" "),s("p",[n._v("讲了多么多nosql数据库，一些概念的东西就不写不讲了")]),n._v(" "),s("h3",{attrs:{id:"搭建-一台机器启动多个实例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建-一台机器启动多个实例"}},[n._v("#")]),n._v(" 搭建： 一台机器启动多个实例")]),n._v(" "),s("p",[n._v("创建三个文件夹做为三个MongoDB实例的工作空间")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /myMongoDb/mongodb1  -p \nmkdir /myMongoDb/mongodb2  -p \nmkdir /myMongoDb/mongodb3  -p\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("在三个工作空间下分别创建数据，日志，进程存放等目录或者文件")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /myMongoDb/mongodb1/data  -p \nmkdir /myMongoDb/mongodb1/log  -p \nmkdir /myMongoDb/mongodb1/pid  -p \n\nmkdir /myMongoDb/mongodb2/data  -p \nmkdir /myMongoDb/mongodb2/log  -p \nmkdir /myMongoDb/mongodb2/pid  -p \n\nmkdir /myMongoDb/mongodb3/data  -p \nmkdir /myMongoDb/mongodb3/log  -p \nmkdir /myMongoDb/mongodb3/pid  -p \n\ntouch /myMongoDb/mongodb1/log/mongodb.log\ntouch /myMongoDb/mongodb2/log/mongodb.log\ntouch /myMongoDb/mongodb3/log/mongodb.log\ntouch /myMongoDb/mongodb1/pid/mongodb.pid\ntouch /myMongoDb/mongodb2/pid/mongodb.pid\ntouch /myMongoDb/mongodb3/pid/mongodb.pid\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br")])]),s("p",[n._v("在每个工作空间下创建配置文件")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /myMongoDb/mongodb1/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /myMongoDb/mongodb1/log/mongodb.log\n\nstorage:\n  dbPath: /myMongoDb/mongodb1/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /myMongoDb/mongodb1/pid/mongodb.pid\n\nnet:\n  port: 7000\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: rs0\n  enableMajorityReadConcern: true\n  \n  \nenableMajorityReadConcern:是否开启 readConcern 的级别为 “majority”，默认为 false；只有开启此选项，才能在 read 操作中使用 “majority”\ndestination:日志输出目的地，可以指定为 “file” 或者“syslog”，表述输出到日志文件，如果不指定，则会输出到标准输出中\njournal:是否开启 journal 日志持久存储，journal 日志用来数据恢复，是 mongod 最基础的特性，通常用于故障恢复。64 位系统默认为 true，32 位默认为 false，建议开启，仅对 mongod 进程有效。\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /myMongoDb/mongodb2/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /myMongoDb/mongodb2/log/mongodb.log\n\nstorage:\n  dbPath: /myMongoDb/mongodb2/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /myMongoDb/mongodb2/pid/mongodb.pid\n\nnet:\n  port: 7001\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: rs0\n  enableMajorityReadConcern: true\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /myMongoDb/mongodb3/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /myMongoDb/mongodb3/log/mongodb.log\n\nstorage:\n  dbPath: /myMongoDb/mongodb3/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /myMongoDb/mongodb3/pid/mongodb.pid\n  \nnet:\n  port: 7002\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: rs0\n  enableMajorityReadConcern: true\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br")])]),s("p",[n._v("注意：如果副本集的任何有投票权的成员使用"),s("a",{attrs:{href:"https://docs.mongodb.com/manual/core/inmemory/#storage-inmemory",target:"_blank",rel:"noopener noreferrer"}},[n._v("内存存储引擎"),s("OutboundLink")],1),n._v("，则必须设置 "),s("code",[n._v("writeConcernMajorityJournalDefault")]),n._v("为"),s("code",[n._v("false")]),n._v("。如果副本集的任何有投票权的成员使用"),s("a",{attrs:{href:"https://docs.mongodb.com/manual/core/inmemory/#storage-inmemory",target:"_blank",rel:"noopener noreferrer"}},[n._v("内存存储引擎"),s("OutboundLink")],1),n._v("且 "),s("code",[n._v("writeConcernMajorityJournalDefault")]),n._v("为"),s("code",[n._v("true")]),n._v("，则 "),s("code",[n._v('"majority"')]),n._v("写操作可能会失败。")]),n._v(" "),s("p",[n._v("启动：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("/usr/local/mongodb/bin/mongod -f /myMongoDb/mongodb1/mongodb.conf\n/usr/local/mongodb/bin/mongod -f /myMongoDb/mongodb2/mongodb.conf\n/usr/local/mongodb/bin/mongod -f /myMongoDb/mongodb3/mongodb.conf\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("客户端连接，初始化副本：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('mongo --host=192.168.204.188 --port=7000\n\n> rs.initiate()\n{\n        "info2" : "no configuration specified. Using a default configuration for the set",\n        "me" : "192.168.204.199:7000",\n        "ok" : 1,\n        "$clusterTime" : {\n                "clusterTime" : Timestamp(1584452776, 1),\n                "signature" : {\n                        "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),\n                        "keyId" : NumberLong(0)\n                }\n        },\n        "operationTime" : Timestamp(1584452776, 1)\n}\nrs0:OTHER> \nrs0:PRIMARY> \n\nOK为1的话 则初始化成功\nrs.conf()  查看副本信息\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br")])]),s("p",[n._v("加入副本和仲裁节点")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('rs.add("192.168.204.199:7001")  加入副本节点\nrs.addArb("192.168.204.199:7002") 加入仲裁节点\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[n._v("测试：")]),n._v(" "),s("p",[n._v("现在连接的是主节点：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('use taibai\ndb.xyj.insert({name:"猪八戒",age:28,gender:"男"});\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[n._v("连接副本节点：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mongo --host=192.168.204.199 --port=7001\nshow dbs-----》  会报错\n\n执行一下：rs.slaveOk() 命令\nshow dbs-----》  OK\n\nrs.slaveOk()  默认  rs.slaveOk(true)   不想复制的时候可以执行rs.slaveOk(false)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br")])]),s("p",[n._v("连接仲裁节点：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mongo --host=192.168.204.199 --port=7002\n执行一下：rs.slaveOk() 命令\nshow dbs\n返回\nlocal  0.000GB\n\n仲裁节点不会复制数据\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br")])]),s("h3",{attrs:{id:"故障测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#故障测试"}},[n._v("#")]),n._v(" 故障测试：")]),n._v(" "),s("p",[n._v("副本挂掉的情况：")]),n._v(" "),s("p",[n._v("​\t主节点和仲裁节点不受影响，如果副本挂掉的时候主节点还写入数据，当副本重启时主会同步数据给副本")]),n._v(" "),s("p",[n._v("主节点挂掉的情况：")]),n._v(" "),s("p",[n._v("​\t执行故障转移，从节点成为主节点，仲裁节点没有选举权（不会主节点），当挂掉的主节点回来了。将成为副本")]),n._v(" "),s("p",[n._v("主节点和仲裁节点挂掉的情况：")]),n._v(" "),s("p",[n._v("​\t副本还是副本，但是此时随便一个成员加入：")]),n._v(" "),s("p",[n._v("​\t仲裁节点加入：  副本成为主节点")]),n._v(" "),s("p",[n._v("​\t主节点加入：看谁的数据新")]),n._v(" "),s("p",[n._v("副本节点和仲裁节点挂掉的情况：")]),n._v(" "),s("p",[n._v("​\t主节点降级为副本")]),n._v(" "),s("h3",{attrs:{id:"数据是如何复制的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据是如何复制的"}},[n._v("#")]),n._v(" 数据是如何复制的？")]),n._v(" "),s("p",[n._v("当一个修改（增删改）操作到达主节点时，它对数据的操作经过特定的转化之后将被记录下来，这些称为oplog，")]),n._v(" "),s("p",[n._v("从节点通过在主节点上打开一个tailable游标不断获取新进入主节点的oplog，并在自己的数据上回放。")]),n._v(" "),s("h3",{attrs:{id:"故障转移"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#故障转移"}},[n._v("#")]),n._v(" 故障转移")]),n._v(" "),s("p",[n._v("具有投票权的节点之间两两互相发送心跳")]),n._v(" "),s("p",[n._v("当5次心跳未收到则判断为节点失联")]),n._v(" "),s("p",[n._v("如果是主节点，从节点会发起选举，选出主节点")]),n._v(" "),s("p",[n._v("如果失联的是从节点则不会发生新的选举")]),n._v(" "),s("p",[n._v("选举基于RAFT一致性算法，选举成功的必要条件是大多数投票节点存活")]),n._v(" "),s("p",[n._v("复制集中最多可以有50个节点，但最多只能有7个投票节点")]),n._v(" "),s("p",[s("strong",[n._v("影响选举的因素：")])]),n._v(" "),s("p",[n._v("被选举为主节点的节点必须：")]),n._v(" "),s("p",[n._v("能与多数节点建立连接")]),n._v(" "),s("p",[n._v("具有较新的oplog")]),n._v(" "),s("p",[n._v("根据配置文件的优先级")]),n._v(" "),s("h1",{attrs:{id:"分片"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分片"}},[n._v("#")]),n._v(" 分片")]),n._v(" "),s("p",[n._v("搭建两套副本")]),n._v(" "),s("p",[n._v("创建shard文件夹，作为分片集群工作空间")]),n._v(" "),s("p",[n._v("在shard创建replication1，作为第一个副本工作空间，然后创建三个文件夹做为三个MongoDB实例的工作空间")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /shard/replication1/mongodb1  -p \nmkdir /shard/replication1/mongodb2  -p \nmkdir /shard/replication1/mongodb3  -p\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("在三个工作空间下分别创建数据，日志，进程存放等目录或者文件")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /shard/replication1/mongodb1/data  -p \nmkdir /shard/replication1/mongodb1/log  -p \nmkdir /shard/replication1/mongodb1/pid  -p \n\nmkdir /shard/replication1/mongodb2/data  -p \nmkdir /shard/replication1/mongodb2/log  -p \nmkdir /shard/replication1/mongodb2/pid  -p \n\nmkdir /shard/replication1/mongodb3/data  -p \nmkdir /shard/replication1/mongodb3/log  -p \nmkdir /shard/replication1/mongodb3/pid  -p \n\ntouch /shard/replication1/mongodb1/log/mongodb.log\ntouch /shard/replication1/mongodb2/log/mongodb.log\ntouch /shard/replication1/mongodb3/log/mongodb.log\n\ntouch /shard/replication1/mongodb1/pid/mongodb.pid\ntouch /shard/replication1/mongodb2/pid/mongodb.pid\ntouch /shard/replication1/mongodb3/pid/mongodb.pid\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br")])]),s("p",[n._v("在每个工作空间下创建配置文件")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/replication1/mongodb1/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/replication1/mongodb1/log/mongodb.log\n\nstorage:\n  dbPath: /shard/replication1/mongodb1/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/replication1/mongodb1/pid/mongodb.pid\n\nnet:\n  port: 7000\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard0\nsharding:\n  clusterRole: shardsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/replication1/mongodb2/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/replication1/mongodb2/log/mongodb.log\n\nstorage:\n  dbPath: /shard/replication1/mongodb2/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/replication1/mongodb2/pid/mongodb.pid\n\nnet:\n  port: 7001\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard0\nsharding:\n  clusterRole: shardsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/replication1/mongodb3/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/replication1/mongodb3/log/mongodb.log\n\nstorage:\n  dbPath: /shard/replication1/mongodb3/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/replication1/mongodb3/pid/mongodb.pid\n\nnet:\n  port: 7002\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard0\nsharding:\n  clusterRole: shardsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("p",[n._v("启动：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("/usr/local/mongodb/bin/mongod -f /shard/replication1/mongodb1/mongodb.conf\n/usr/local/mongodb/bin/mongod -f /shard/replication1/mongodb2/mongodb.conf\n/usr/local/mongodb/bin/mongod -f /shard/replication1/mongodb3/mongodb.conf\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("在shard创建replication2，作为第二个副本工作空间，然后创建三个文件夹做为三个MongoDB实例的工作空间")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /shard/replication2/mongodb1  -p \nmkdir /shard/replication2/mongodb2  -p \nmkdir /shard/replication2/mongodb3  -p\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("在三个工作空间下分别创建数据，日志，进程存放等目录或者文件")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /shard/replication2/mongodb1/data  -p \nmkdir /shard/replication2/mongodb1/log  -p \nmkdir /shard/replication2/mongodb1/pid  -p \n\nmkdir /shard/replication2/mongodb2/data  -p \nmkdir /shard/replication2/mongodb2/log  -p \nmkdir /shard/replication2/mongodb2/pid  -p \n\nmkdir /shard/replication2/mongodb3/data  -p \nmkdir /shard/replication2/mongodb3/log  -p \nmkdir /shard/replication2/mongodb3/pid  -p \n\ntouch /shard/replication2/mongodb1/log/mongodb.log\ntouch /shard/replication2/mongodb2/log/mongodb.log\ntouch /shard/replication2/mongodb3/log/mongodb.log\n\ntouch /shard/replication2/mongodb1/pid/mongodb.pid\ntouch /shard/replication2/mongodb2/pid/mongodb.pid\ntouch /shard/replication2/mongodb3/pid/mongodb.pid\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br")])]),s("p",[n._v("在每个工作空间下创建配置文件")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/replication2/mongodb1/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/replication2/mongodb1/log/mongodb.log\n\nstorage:\n  dbPath: /shard/replication2/mongodb1/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/replication2/mongodb1/pid/mongodb.pid\n\nnet:\n  port: 8000\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard1\nsharding:\n  clusterRole: shardsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/replication2/mongodb2/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/replication2/mongodb2/log/mongodb.log\n\nstorage:\n  dbPath: /shard/replication2/mongodb2/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/replication2/mongodb2/pid/mongodb.pid\n\nnet:\n  port: 8001\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard1\nsharding:\n  clusterRole: shardsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/replication2/mongodb3/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/replication2/mongodb3/log/mongodb.log\n\nstorage:\n  dbPath: /shard/replication2/mongodb3/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/replication2/mongodb3/pid/mongodb.pid\n\nnet:\n  port: 8002\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard1\nsharding:\n  clusterRole: shardsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("p",[n._v("启动：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("/usr/local/mongodb/bin/mongod -f /shard/replication2/mongodb1/mongodb.conf\n/usr/local/mongodb/bin/mongod -f /shard/replication2/mongodb2/mongodb.conf\n/usr/local/mongodb/bin/mongod -f /shard/replication2/mongodb3/mongodb.conf\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("在shard创建configservice，作为配置节点副本工作空间，然后创建三个文件夹做为三个MongoDB实例的工作空间")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /shard/configservice/mongodb1  -p \nmkdir /shard/configservice/mongodb2  -p \nmkdir /shard/configservice/mongodb3  -p\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("在三个工作空间下分别创建数据，日志，进程存放等目录或者文件")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /shard/configservice/mongodb1/data  -p \nmkdir /shard/configservice/mongodb1/log  -p \nmkdir /shard/configservice/mongodb1/pid  -p \n\nmkdir /shard/configservice/mongodb2/data  -p \nmkdir /shard/configservice/mongodb2/log  -p \nmkdir /shard/configservice/mongodb2/pid  -p \n\nmkdir /shard/configservice/mongodb3/data  -p \nmkdir /shard/configservice/mongodb3/log  -p \nmkdir /shard/configservice/mongodb3/pid  -p \n\ntouch /shard/configservice/mongodb1/log/mongodb.log\ntouch /shard/configservice/mongodb2/log/mongodb.log\ntouch /shard/configservice/mongodb3/log/mongodb.log\n\ntouch /shard/configservice/mongodb1/pid/mongodb.pid\ntouch /shard/configservice/mongodb2/pid/mongodb.pid\ntouch /shard/configservice/mongodb3/pid/mongodb.pid\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br")])]),s("p",[n._v("在每个工作空间下创建配置文件")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/configservice/mongodb1/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/configservice/mongodb1/log/mongodb.log\n\nstorage:\n  dbPath: /shard/configservice/mongodb1/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/configservice/mongodb1/pid/mongodb.pid\n\nnet:\n  port: 9000\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard2\nsharding:\n  clusterRole: configsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/configservice/mongodb2/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/configservice/mongodb2/log/mongodb.log\n\nstorage:\n  dbPath: /shard/configservice/mongodb2/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/configservice/mongodb2/pid/mongodb.pid\n\nnet:\n  port: 9001\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard2\nsharding:\n  clusterRole: configsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("vim /shard/configservice/mongodb3/mongodb.conf\n写入\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /shard/configservice/mongodb3/log/mongodb.log\n\nstorage:\n  dbPath: /shard/configservice/mongodb3/data\n  journal:\n    enabled: true\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/configservice/mongodb3/pid/mongodb.pid\n\nnet:\n  port: 9002\n  bindIp: 192.168.204.199\n\nreplication:\n  replSetName: shard2\nsharding:\n  clusterRole: configsvr\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("p",[n._v("1、configsvr：此实例为 config server，此实例默认侦听 27019 端口")]),n._v(" "),s("p",[n._v("2、shardsvr：此实例为 shard（分片），侦听 27018 端口")]),n._v(" "),s("p",[n._v("启动：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("/usr/local/mongodb/bin/mongod -f /shard/configservice/mongodb1/mongodb.conf\n/usr/local/mongodb/bin/mongod -f /shard/configservice/mongodb2/mongodb.conf\n/usr/local/mongodb/bin/mongod -f /shard/configservice/mongodb3/mongodb.conf\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("客户端连接，初始化第一套副本：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mongo --host=192.168.204.188 --port=7000\n\n> rs.initiate()\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("加入副本和仲裁节点")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('rs.add("192.168.204.199:7001")  加入副本节点\nrs.addArb("192.168.204.199:7002")\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[n._v("客户端连接，初始化第二套副本：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mongo --host=192.168.204.199 --port=8000\n\n> rs.initiate()\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("加入副本和仲裁节点")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('rs.add("192.168.204.199:8001")  加入副本节点\nrs.addArb("192.168.204.199:8002")\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[n._v("客户端连接，初始化配置节点副本：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mongo --host=192.168.204.199 --port=9000\n\n> rs.initiate()\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("加入副本和仲裁节点")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('rs.add("192.168.204.199:9001")  加入副本节点\nrs.add("192.168.204.199:9002")\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[n._v("创建仲裁节点")]),n._v(" "),s("p",[n._v("在shard下创建route文件夹，然后创建两个文件夹作为路由节点实例工作空间")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mkdir /shard/route/mongodb1/log -p\nmkdir /shard/route/mongodb1/pid -p\n\ntouch /shard/route/mongodb1/log/mongodb.log\ntouch /shard/route/mongodb1/pid/mongodb.pid\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v(" vim /shard/route/mongodb1/mongos.conf\n 写入\n systemLog:\n  destination: file\n  logAppend: true\n  path: /shard/route/mongodb1/log/mongodb.log\n\nprocessManagement:\n  fork: true\n  pidFilePath: /shard/route/mongodb1/pid/mongodb.pid\n\nnet:\n  port: 6000\n  bindIp: 192.168.204.199\n\nsharding:\n  configDB: shard2/192.168.204.188:9000,192.168.204.188:9001,192.168.204.188:9002   #连接配置节点\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br")])]),s("p",[n._v("启动")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("mongos -f /shard/route/mongodb1/mongos.conf\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("连接路由节点，将副本加入进来")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('mongo --host=192.168.204.188 --port=6000\n\nsh.addShard(ip:port)   单机\nsh.addShard(副本名:/ip:端口,ip:端口....)   副本\n\nsh.addShard("shard0/192.168.204.199:7000,192.168.204.199:7001,192.168.204.199:7002")\nsh.addShard("shard1/192.168.204.199:8000,192.168.204.199:8001,192.168.204.199:8002")\n\nsh.status()  查看\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br")])]),s("p",[n._v("初始化分片")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('sh.enableSharding("数据库名")   //开启此数据库分片\nsh.shardCollection("数据库名.集合名",{"根据此集合中那个字段进行分片":"分片规则是什么"})\n\nsh.enableSharding("taibai")  \nsh.shardCollection("taibai.xyj",{"likename":"hashed"})   hash\nsh.shardCollection("taibai.sg",{"age":1})   范围\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br")])]),s("p",[n._v("测试分片：")]),n._v(" "),s("p",[n._v("注意：必要要在路由节点上执行")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('测试hash\nuse taibai\nfor(var i=1;i<=1000;i++){db.xyj.insert({_id:i+"",likename:"taibai"+i})}  插入1000条数据\n登录7000和8000两个副本查看\n7000  ---》  502\n8000  ---》  498\n\n登录7000的副本7001，执行rs.slaveOk()命令之后，可能看到数据也同步过来了\n\n测试范围\n在做范围测试之前，由于范围默认是写入某个库，直到这个库当中这个集合的数据达到64M之后才会进行分片，然而我们没有这么大的数据量，所有将64M设置为1M\nuse config\ndb.settings.save({_id:"chunksize",value: 1})\n\nuse taibai\nfor(var i=1;i<=20000;i++){db.sg.save({"name":"fwefaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"+i,"age":NumberInt(i%2000)})}\n登录7000和8000两个副本查看\n7000  ---》  7940\n8000  ---》  16782\n总数据：24722\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br")])]),s("p",[n._v("搭建多个路由节点：")]),n._v(" "),s("p",[n._v("步骤和上面完全一样。。。。。")]),n._v(" "),s("h1",{attrs:{id:"事务相关"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事务相关"}},[n._v("#")]),n._v(" 事务相关")]),n._v(" "),s("p",[n._v("MongoDB的事务，可以实现和关系型数据库类似的事务场景")]),n._v(" "),s("p",[n._v("必须使用与MongoDB4.2兼容的驱动")]),n._v(" "),s("p",[n._v("事务默认必须在60s（可调）内完成，否则将被取消")]),n._v(" "),s("p",[n._v("涉及事务的分片不能使用仲裁节点")]),n._v(" "),s("p",[n._v("事务会影响chunk迁移效率。正在迁移的chunk也可能造成事务提交失败，此时重试即可")]),n._v(" "),s("p",[n._v("多文档事务中的读操作必须使用主节点读")]),n._v(" "),s("p",[n._v("readConcern只应该在事务级别设置，不能设置在每次读写操作上")]),n._v(" "),s("h4",{attrs:{id:"原子性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原子性"}},[n._v("#")]),n._v(" 原子性")]),n._v(" "),s("p",[n._v("事务的原子性是指事务必须是一个"),s("strong",[n._v("原子的操作序列单元")]),n._v("。事务中包含的各项操作在一次执行过程中，"),s("strong",[n._v("要么全部执行，要么全部不执行")]),n._v("。")]),n._v(" "),s("p",[n._v("任何一项操作失败都将导致整个事务失败，同时其他已经被执行的操作都将被撤销并回滚。只有所有的操作全部成功，整个事务才算是成功完成。")]),n._v(" "),s("h4",{attrs:{id:"一致性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一致性"}},[n._v("#")]),n._v(" 一致性")]),n._v(" "),s("p",[n._v("事务的一致性是指事务的执行不能破坏数据库数据的完整性和一致性，一个事务在执行前后，数据库都必须处于一致性状态。换句话说，事务的执行结果必须是使数据库从一个一致性状态转变到另一个一致性状态。")]),n._v(" "),s("p",[n._v("举个例子")]),n._v(" "),s("p",[n._v("银行的转账操作就是一个事务。假设A和B原来账户都有100元。此时A转账给B50元，转账结束后，应该是A账户减去50元变成50元，B账户增加50元变成150元。A、B的账户总和还是200元。转账前后，数据库就是从一个一致性状态（A100元，B100元，A、B共200元）转变到另一个一致性状态（A50元，B150元，A、B共200元）。假设转账结束后只扣了A账户，没有增加B账户，这时数据库就处于不一致的状态。")]),n._v(" "),s("h4",{attrs:{id:"隔离性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#隔离性"}},[n._v("#")]),n._v(" 隔离性")]),n._v(" "),s("p",[n._v("事务的隔离性是指在"),s("strong",[n._v("并发")]),n._v("环境中，并发的事务是"),s("strong",[n._v("相互隔离")]),n._v("的，事务之间"),s("strong",[n._v("互不干扰")]),n._v("。")]),n._v(" "),s("p",[n._v("在标准的SQL规范中，定义的4个事务隔离级别，不同隔离级别对事务的处理不同。4个隔离级别分别是：未授权读取、授权读取、可重复读取和串行化。")]),n._v(" "),s("h6",{attrs:{id:"脏读、不可重复读和幻读"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#脏读、不可重复读和幻读"}},[n._v("#")]),n._v(" 脏读、不可重复读和幻读")]),n._v(" "),s("p",[n._v("**脏读：**当前事务(A)中可以读到其他事务(B)未提交的数据（脏数据），这种现象是脏读。举例如下（以账户余额表为例）：")]),n._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/571262/1586941935185-0019097f-9fd1-46be-a613-ea6b7dc19d00.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_31%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),n._v(" "),s("p",[n._v("**不可重复读：**在事务A中先后两次读取同一个数据，两次读取的结果不一样，这种现象称为不可重复读。脏读与不可重复读的区别在于：前者读到的是其他事务未提交的数据，后者读到的是其他事务已提交的数据。举例如下：")]),n._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/571262/1586941915109-cd3450cd-fbbe-4048-873e-11899d323caa.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_31%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),n._v(" "),s("p",[n._v("**幻读：**在事务A中按照某个条件先后两次查询数据库，两次查询结果的条数不同，这种现象称为幻读。不可重复读与幻读的区别可以通俗的理解为：前者是数据变了，后者是数据的行数变了。举例如下：")]),n._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/571262/1586941944648-d81c6262-b0ab-4ec6-ba09-ef523dec378a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10",alt:"img"}})]),n._v(" "),s("p",[n._v("下表展示了不同隔离级别下事务访问数据的差异")]),n._v(" "),s("table",[s("thead",[s("tr",[s("th",[n._v("隔离级别")]),n._v(" "),s("th",[n._v("脏读")]),n._v(" "),s("th",[n._v("可重复读")]),n._v(" "),s("th",[n._v("幻读")])])]),n._v(" "),s("tbody",[s("tr",[s("td",[n._v("读未提交")]),n._v(" "),s("td",[n._v("存在")]),n._v(" "),s("td",[n._v("不可以")]),n._v(" "),s("td",[n._v("存在")])]),n._v(" "),s("tr",[s("td",[n._v("读已提交")]),n._v(" "),s("td",[n._v("不存在")]),n._v(" "),s("td",[n._v("不可以")]),n._v(" "),s("td",[n._v("存在")])]),n._v(" "),s("tr",[s("td",[n._v("可重复读取")]),n._v(" "),s("td",[n._v("不存在")]),n._v(" "),s("td",[n._v("可以")]),n._v(" "),s("td",[n._v("存在")])]),n._v(" "),s("tr",[s("td",[n._v("串行化")]),n._v(" "),s("td",[n._v("不存在")]),n._v(" "),s("td",[n._v("可以")]),n._v(" "),s("td",[n._v("不存在")])])])]),n._v(" "),s("p",[n._v("以上4个级别的隔离性依次增强，分别解决不同的问题。"),s("strong",[n._v("事务隔离级别越高，就越能保证数据的完整性和一致性，但同时对并发性能的影响也越大")]),n._v("。")]),n._v(" "),s("p",[n._v("通常，对于绝大多数的应用来说，可以优先考虑将数据库系统的隔离级别设置为"),s("strong",[n._v("授权读取")]),n._v("，这能够在避免脏读的同时保证较好的并发性能。尽管这种事务隔离级别会导致不可重复读、幻读和第二类丢失更新等并发问题，但较为科学的做法是在可能出现这类问题的个别场合中，由应用程序主动采用悲观锁或乐观锁来进行事务控制。")]),n._v(" "),s("h4",{attrs:{id:"持久性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#持久性"}},[n._v("#")]),n._v(" 持久性")]),n._v(" "),s("p",[n._v("事务的持久性又称为永久性，是指一个事务一旦提交，对数据库中对应数据的状态变更就应该是"),s("strong",[n._v("永久性")]),n._v("的。即使发生系统崩溃或机器宕机等故障，只要数据库能够重新启动，那么一定能够将其"),s("strong",[n._v("恢复")]),n._v("到事务成功结束时的状态。")]),n._v(" "),s("h3",{attrs:{id:"写"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#写"}},[n._v("#")]),n._v(" 写")]),n._v(" "),s("p",[n._v("writeConcern决定一个写操作落到多少个节点上才算成功。writeConcern的取值包括：")]),n._v(" "),s("p",[n._v("0：发起写操作，不关心是否成功")]),n._v(" "),s("p",[n._v("1~集群最大数据节点数：写操作需要被复制到节点执定节点数才算成功")]),n._v(" "),s("p",[n._v("majority: 写操作需要被复制到大多数节点才算成功。")]),n._v(" "),s("p",[n._v("发起写操作的程序将阻塞到写操作到达指定的节点数为止")]),n._v(" "),s("p",[n._v("journal则定义如何才算成功。")]),n._v(" "),s("p",[n._v("true：写操作落到journal文件中才算成功；")]),n._v(" "),s("p",[n._v("false：写操作到达内存即算做成功。")]),n._v(" "),s("p",[n._v("使用：当指定了超过节点数量时，会提示报错，但是数据还是会写入成功")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.test.insert({count:2},{writeConcern:{w:3}})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[s("strong",[n._v("writeConcern实验：")])]),n._v(" "),s("p",[n._v("查看节点设置：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("var conf=rs.conf()\nconf.members\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[n._v("设置延迟节点：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("conf.members[1].slaveDelay=10  设置延迟\nconf.members[1].priority=0     设置不参与选举\n\nrs.reconfig(conf)  使配置生效\nrs.reconfig()命令执行后，会强制当前的主节点下线，然后进行新的主节点选择。主节点下线时，会关闭所有客户端的连接，这个过程会持续10-20s，因此该操作应该在维护时间执行，减少对系统的影响。\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("p",[n._v("设置超时时间：")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.tx.insert({count:10},{writeConcern:{w:3}})\ndb.tx.insert({count:10},{writeConcern:{w:3,wtimeout:3000}})\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("h3",{attrs:{id:"读"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#读"}},[n._v("#")]),n._v(" 读")]),n._v(" "),s("p",[n._v("readPreference决定读哪个节点")]),n._v(" "),s("p",[n._v("primary：只选择主节点（默认）")]),n._v(" "),s("p",[n._v("primaryPreferred：优先选择主节点，如果不可用则选择从节点")]),n._v(" "),s("p",[n._v("secondary： 只选择从节点")]),n._v(" "),s("p",[n._v("secondaryPreferred：优先选择从节点，如果从节点不可用则选择主节点")]),n._v(" "),s("p",[n._v("nearest：选择最近的节点；")]),n._v(" "),s("p",[s("strong",[n._v("readPreference选择从节点读实验：")])]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.test.remove({})\ndb.test.insert({count:100})\n在两个从节点分别执行db.fsyncLock()    禁止同步（写入）\ndb.test.insert({count:300})\ndb.test.find().readPref("secondary").readConcern("majority")\ndb.fsyncUnlock()     解锁\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br")])]),s("p",[n._v("什么是readConcern？")]),n._v(" "),s("p",[n._v("在readPreference选择了指定的节点后，readConcern决定这个节点上的数据那些是可读的，类似关系型数据库的隔离级别。可选值包括：")]),n._v(" "),s("p",[n._v("available：读取所有可用的数据")]),n._v(" "),s("p",[n._v("local：读取所有可用且属于当前分片的数据")]),n._v(" "),s("p",[n._v("majority：读取在大多数节点上提交完成的数据")]),n._v(" "),s("p",[n._v("linearizable：可线性化读取文档")]),n._v(" "),s("p",[n._v("snapshot：读取最近快照中的数据")]),n._v(" "),s("h3",{attrs:{id:"实验"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实验"}},[n._v("#")]),n._v(" 实验：")]),n._v(" "),s("p",[n._v("使用snapshot  可重读，幻读，改实验证明不需要")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.tx.remove({})\ndb.tx.insert({x:1})\nvar session=db.getMongo().startSession();\nsession.startTransaction({readConcern:{level:"snapshot"},writeConcern:{w:"majority"});\nvar coll=session.getDatabase(\'taibai\').getCollection("tx");\ncoll.findOne({x:1})\ndb.tx.updateOne({x:1},{$set:{y:1}})\ndb.tx.find({x:1})\ncoll.findOne({x:1})\nsession.abortTransaction()\nsession.commitTransaction();\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br")])]),s("p",[s("strong",[n._v("实现安全的读写分离")])]),n._v(" "),s("p",[n._v("写使用writeConcern  majority")]),n._v(" "),s("p",[n._v("读使用readConcern  majority")]),n._v(" "),s("h3",{attrs:{id:"mongodb-acid多文档事务支持"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-acid多文档事务支持"}},[n._v("#")]),n._v(" MongoDB  ACID多文档事务支持")]),n._v(" "),s("table",[s("thead",[s("tr",[s("th",[n._v("事务属性")]),n._v(" "),s("th",[n._v("支持程度")])])]),n._v(" "),s("tbody",[s("tr",[s("td",[n._v("A  原子性")]),n._v(" "),s("td",[n._v("单表单文档 ： 1.x就支持   复制集多表多行：4.0复制集   分片集群多表多行4.2")])]),n._v(" "),s("tr",[s("td",[n._v("C 一致性")]),n._v(" "),s("td",[n._v("writeConcern，readConcern（3.2）")])]),n._v(" "),s("tr",[s("td",[n._v("I 隔离性")]),n._v(" "),s("td",[n._v("readConcern （3.2）")])]),n._v(" "),s("tr",[s("td",[n._v("D 持久性")]),n._v(" "),s("td",[n._v("Journal and replication")])])])]),n._v(" "),s("h3",{attrs:{id:"change-stream"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#change-stream"}},[n._v("#")]),n._v(" Change Stream")]),n._v(" "),s("p",[n._v("什么是Change Stream")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("Change Stream 是MongoDB用于实现变更追踪的解决方案，类似于关系数据库的触发器，但原理不完全相同：\n    \n    |              |  Change Stream  |  触发器        |\n    |--------------|-----------------|---------------|\n    |   触发方式    |  异步           |  同步（事务保证） |\n    |   触发位置    |  应用回调事件    |  数据库触发器   |\n    |   触发次数    |  每个订阅事件的客户端  |  1次（触发器） |\n    |   故障恢复    |  从上次断点重新触发  |  事务回滚    |\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br")])]),s("p",[n._v("MongoDB 从3.6版本开始支持了 Change Stream 能力（4.0、4.2 版本在能力上做了很多增强），用于订阅 MongoDB 内部的修改操作，change stream 可用于 MongoDB 之间的增量数据迁移、同步，也可以将 MongoDB 的增量订阅应用到其他的关联系统；比如电商场景里，MongoDB 里存储新的订单信息，业务需要根据新增的订单信息去通知库存管理系统发货。")]),n._v(" "),s("p",[n._v("使用 Change Stream 非常简单，mongo shell 封装了针对整个实例、DB、Collection 级别的订阅操作。")]),n._v(" "),s("p",[n._v("注意：集群环境一定要开启enableMajorityReadConcern: true   配置文件中开启")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.getMongo().watch()    订阅整个实例的修改\ndb.watch()               订阅指定DB的修改\ndb.collection.watch()    订阅指定Collection的修改\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("p",[n._v("新建连接1发起订阅操作")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v("db.test.watch([], {maxAwaitTimeMS: 60000})    // 最多阻塞等待 1分钟\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("p",[n._v("新建连接2写入新数据")]),n._v(" "),s("div",{staticClass:"language-plain line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-plain"}},[s("code",[n._v('db.test.insert({x: 100})\ndb.test.insert({x: 200})\ndb.test.insert({x: 300})\ndb.test.insert({x: 400})\n\n上述 ChangeStream 结果里，_id 字段标识着 oplog 的某个位置，如果想从某个位置继续订阅，在 watch 时，通过 resumeAfter 指定即可。比如每个应用订阅了上述3条修改，但只有第一条已经成功消费了，下次订阅时指定第一条的 resume token 即可再次订阅到接下来的2条。\n\ndb.test.watch([], {maxAwaitTimeMS: 60000,resumeAfter:{ "_data" : "825E8DB54F000000012B022C0100296E5A1004BDB3105CB8B44265BB704E58E8EA8B0446645F696400645E8DB54FF368D1BC67ABE7AE0004" }})\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br")])])])}),[],!1,null,null,null);s.default=t.exports}}]);