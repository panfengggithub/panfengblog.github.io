(window.webpackJsonp=window.webpackJsonp||[]).push([[254],{669:function(s,n,a){"use strict";a.r(n);var t=a(1),e=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"nginx限流熔断"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx限流熔断"}},[s._v("#")]),s._v(" Nginx限流熔断")]),s._v(" "),n("p",[s._v("*作为优秀的负载均衡模块，目前是我们工作中用到最多的。其实，该模块是提供了我们需要的后端限流功能的。通过官方文档介绍，")]),s._v(" "),n("h3",{attrs:{id:"令牌桶算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#令牌桶算法"}},[s._v("#")]),s._v(" 令牌桶算法")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://images2018.cnblogs.com/blog/802666/201805/802666-20180502140242681-53841293.jpg",alt:"令牌桶算法"}})]),s._v(" "),n("p",[s._v("算法思想是：")]),s._v(" "),n("ul",[n("li",[s._v("令牌以固定速率产生，并缓存到令牌桶中；")]),s._v(" "),n("li",[s._v("令牌桶放满时，多余的令牌被丢弃；")]),s._v(" "),n("li",[s._v("请求要消耗等比例的令牌才能被处理；")]),s._v(" "),n("li",[s._v("令牌不够时，请求被缓存。")])]),s._v(" "),n("h3",{attrs:{id:"漏桶算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#漏桶算法"}},[s._v("#")]),s._v(" 漏桶算法")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://images2018.cnblogs.com/blog/802666/201805/802666-20180502140248838-284301317.png",alt:"漏桶算法"}})]),s._v(" "),n("p",[s._v("算法思想是：")]),s._v(" "),n("ul",[n("li",[s._v("水（请求）从上方倒入水桶，从水桶下方流出（被处理）；")]),s._v(" "),n("li",[s._v("来不及流出的水存在水桶中（缓冲），以固定速率流出；")]),s._v(" "),n("li",[s._v("水桶满后水溢出（丢弃）。")]),s._v(" "),n("li",[s._v("这个算法的核心是：缓存请求、匀速处理、多余的请求直接丢弃。\n相比漏桶算法，令牌桶算法不同之处在于它不但有一只“桶”，还有个队列，这个桶是用来存放令牌的，队列才是用来存放请求的。")])]),s._v(" "),n("p",[s._v("从作用上来说，漏桶和令牌桶算法最明显的区别就是是否允许突发流量(burst)的处理，漏桶算法能够强行限制数据的实时传输（处理）速率，对突发流量不做额外处理；而令牌桶算法能够在限制数据的平均传输速率的同时允许某种程度的突发传输。")]),s._v(" "),n("p",[s._v("Nginx按请求速率限速模块使用的是漏桶算法，即能够强行保证请求的实时处理速度不会超过设置的阈值。")]),s._v(" "),n("h3",{attrs:{id:"案例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#案例"}},[s._v("#")]),s._v(" 案例")]),s._v(" "),n("p",[s._v("通过查看nginx官方文档，https://www.nginx.cn/doc/")]),s._v(" "),n("h1",{attrs:{id:"httplimit-zone"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#httplimit-zone"}},[s._v("#")]),s._v(" HttpLimit zone")]),s._v(" "),n("p",[s._v("本模块可以针对条件，进行会话的并发连接数控制。（例如：限制每个IP的并发连接数。）")]),s._v(" "),n("p",[n("strong",[s._v("配置示例")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("http {\n: limit_zone   one  $binary_remote_addr  10m;\n\n: ...\n\n: server {\n\n: ...\n\n: location /download/ {\n: limit_conn   one  1;\n: }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h2",{attrs:{id:"指令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#指令"}},[s._v("#")]),s._v(" 指令")]),s._v(" "),n("ul",[n("li",[s._v("[#limit_zone limit_zone]")]),s._v(" "),n("li",[s._v("[#limit_conn limit_conn]")])]),s._v(" "),n("h2",{attrs:{id:"limit-zone"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#limit-zone"}},[s._v("#")]),s._v(" limit_zone")]),s._v(" "),n("p",[n("strong",[s._v("语法：")]),s._v(" "),n("em",[s._v("limit_zone zone_name $variable the_size")])]),s._v(" "),n("p",[n("strong",[s._v("默认值：")]),s._v(" "),n("em",[s._v("no")])]),s._v(" "),n("p",[n("strong",[s._v("作用域：")]),s._v(" "),n("em",[s._v("http")])]),s._v(" "),n("p",[s._v("本指令定义了一个数据区，里面记录会话状态信息。\n$variable 定义判断会话的变量；the_size 定义记录区的总容量。")]),s._v(" "),n("p",[s._v("例子：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("limit_zone   one  $binary_remote_addr  10m;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("定义一个叫“one”的记录区，总容量为 10M，以变量 $binary_remote_addr 作为会话的判断基准（即一个地址一个会话）。")]),s._v(" "),n("p",[s._v("您可以注意到了，在这里使用的是 $binary_remote_addr 而不是 $remote_addr。")]),s._v(" "),n("p",[s._v("$remote_addr 的长度为 7 至 15 bytes，会话信息的长度为 32 或 64 bytes。 而 $binary_remote_addr 的长度为 4 bytes，会话信息的长度为 32 bytes。")]),s._v(" "),n("p",[s._v("当区的大小为 1M 的时候，大约可以记录 32000 个会话信息（一个会话占用 32 bytes）。")]),s._v(" "),n("h2",{attrs:{id:"limit-conn"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#limit-conn"}},[s._v("#")]),s._v(" limit_conn")]),s._v(" "),n("p",[n("strong",[s._v("语法：")]),s._v(" "),n("em",[s._v("limit_conn zone_name the_size")])]),s._v(" "),n("p",[n("strong",[s._v("默认值：")]),s._v(" "),n("em",[s._v("no")])]),s._v(" "),n("p",[n("strong",[s._v("作用域：")]),s._v(" "),n("em",[s._v("http, server, location")])]),s._v(" "),n("p",[s._v('指定一个会话最大的并发连接数。 当超过指定的最发并发连接数时，服务器将返回 "Service unavailable" (503)。')]),s._v(" "),n("p",[s._v("例子：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("limit_zone   one  $binary_remote_addr  10m;\n\n: server {\n: location /download/ {\n: limit_conn   one  1;\n: }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("定义一个叫“one”的记录区，总容量为 10M，以变量 $binary_remote_addr 作为会话的判断基准（即一个地址一个会话）。 限制 /download/ 目录下，一个会话只能进行一个连接。 简单点，就是限制 /download/ 目录下，一个IP只能发起一个连接，多过一个，一律503。")]),s._v(" "),n("h3",{attrs:{id:"ab-测试安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ab-测试安装"}},[s._v("#")]),s._v(" ab 测试安装")]),s._v(" "),n("div",{staticClass:"language-html line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[s._v("#ab运行需要依赖apr-util包，安装命令为：\nyum install apr-util\n#安装依赖 yum-utils中的yumdownload 工具，如果没有找到 yumdownload 命令可以\nyum install yum-utils\ncd /opt\nmkdir abtmp\ncd abtmp\nyum install yum-utils.noarch\nyumdownloader httpd-tools*\nrpm2cpio httpd-*.rpm | cpio -idmv\n#操作完成后 将会产生一个 usr 目录 ab文件就在这个usr 目录中\n#简单使用说明\n./ab -c 100 -n 10000 http://127.0.0.1/index.html\n#-c 100 即：每次并发100个\n#-n 10000 即： 共发送10000个请求\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);