(window.webpackJsonp=window.webpackJsonp||[]).push([[159],{572:function(s,a,n){"use strict";n.r(a);var e=n(1),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[a("strong",[s._v("概要：")])]),s._v(" "),a("ol",[a("li",[s._v("mongoDB的聚合操作")]),s._v(" "),a("li",[s._v("mongodb 集群：复制")]),s._v(" "),a("li",[s._v("mongodb 集群：分片")])]),s._v(" "),a("h2",{attrs:{id:"一、-mongodb的聚合操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、-mongodb的聚合操作"}},[s._v("#")]),s._v(" 一、 mongoDB的聚合操作")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("知识点：")]),s._v(" "),a("ol",[a("li",[s._v("pipeline 聚合")]),s._v(" "),a("li",[s._v("mapRedurce 聚合")]),s._v(" "),a("li",[s._v("在聚合中使用索引")])]),s._v(" "),a("h3",{attrs:{id:"_1-pipeline-聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-pipeline-聚合"}},[s._v("#")]),s._v(" 1.pipeline 聚合")]),s._v(" "),a("p",[s._v("pipeline相关运算符：")]),s._v(" "),a("ul",[a("li",[s._v("$match ：匹配过滤聚合的数据")]),s._v(" "),a("li",[s._v("$project：返回需要聚合的字段")]),s._v(" "),a("li",[s._v("$group：统计聚合数据")])]),s._v(" "),a("p",[s._v("示例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# $match 与 $project使用\ndb.emp.aggregate(\n{$match:{"dep":{$eq:"客服部"}}},\n{$project:{name:1,dep:1,salary:1}}\n);\n\n# $group 与 $sum 使用\ndb.emp.aggregate(\n {$project:{dep:1,salary:1}},\n {$group:{"_id":"$dep",total:{$sum:"$salary"}}}\n );\n\n#  低于4000 忽略\ndb.emp.aggregate(\n {$match:{salary:{$gt:4000}}},\n {$project:{dep:1,salary:1}},\n {$group:{"_id":"$dep",total:{$sum:"$salary"}}} \n );\n\n# 基于多个字段 进行组合group  部门+职位进行统计\ndb.emp.aggregate(\n {$project:{dep:1,job:1,salary:1}},\n {$group:{"_id":{"dep":"$dep","job":"$job"},total:{$sum:"$salary"}}} \n );\n\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("二次过滤")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.emp.aggregate(\n {$project:{dep:1,job:1,salary:1}},\n {$group:{"_id":{"dep":"$dep","job":"$job"},total:{$sum:"$salary"}}}，\n {$match:{"$total":{$gt:10000}}} \n );\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"_2-mapredurce-聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-mapredurce-聚合"}},[s._v("#")]),s._v(" 2.mapRedurce 聚合")]),s._v(" "),a("p",[s._v("mapRedurce 说明：\n    为什么需要 MapReduce？\n     (1) 海量数据在单机上处理因为硬件资源限制，无法胜任\n     (2) 而一旦将单机版程序扩展到集群来分布式运行，将极大增加程序的复杂度和开发难度\n     (3) 引入 MapReduce 框架后，开发人员可以将绝大部分工作集中在业务逻辑的开发上，而将 分布式计算中的复杂性交由框架来处理")]),s._v(" "),a("p",[s._v("mongodb中mapRedurce的使用流程")]),s._v(" "),a("ol",[a("li",[s._v("创建Map函数，")]),s._v(" "),a("li",[s._v("创建Redurce函数")]),s._v(" "),a("li",[s._v("将map、Redurce 函数添加至集合中，并返回新的结果集")]),s._v(" "),a("li",[s._v("查询新的结果集")])]),s._v(" "),a("p",[s._v("示例操作")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('// 创建map 对象 \nvar map1=function (){\n\temit(this.job,1);\n }\n// 创建reduce 对象 \n var reduce1=function(job,count){\n return Array.sum(count);\n }\n // 执行mapReduce 任务 并将结果放到新的集合 result 当中\ndb.emp.mapReduce(map1,reduce1,{out:"result"})\n// 查询新的集合\ndb.result.find()\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# 使用复合对象作为key\n var map2=function (){\n\temit({"job":this.job,"dep":this.dep},1);\n }\n \n var reduce2=function(key,values){\n\treturn values.length;\n }\n \ndb.emp.mapReduce(map2,reduce2,{out:"result2"}).find()\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("mapRedurce的原理\n在map函数中使用emit函数添加指定的 key 与Value ，相同的key 将会发给Redurce进行聚合操作，所以Redurce函数中第二个参数 就是 所有集的数组。return 的显示就是聚合要显示的值。")]),s._v(" "),a("h3",{attrs:{id:"_3-在聚合中使用索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-在聚合中使用索引"}},[s._v("#")]),s._v(" 3.在聚合中使用索引")]),s._v(" "),a("p",[s._v("通过$Math内 可以包合对$text 的运算\n示例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.project.aggregate(\n\t\t\t{$match:{$text:{$search:"apache"}}},\n\t\t\t{$project:{"name":1,"price":1}},\n\t\t\t{$group:{_id:"$name",price:{$sum:"$price"}}}\n)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("strong",[s._v("关于索引")]),s._v("\n除了全文索引之外，还有单键索引。即整个字段的值作为索引。单键索引用值1和-1表示，分别代表正序和降序索引。")]),s._v(" "),a("p",[s._v("示例：\nde 创建单键索引")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.emp.createIndex({"dep":1})\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看基于索引的执行计划")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.emp.find({"dep":"客服部"}).explain()\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("除了单键索引外还可以创建联合索引如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.emp.createIndex({"dep":1,"job":-1})\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看 复合索引的执行计划")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.emp.find({"dep":"ddd"}).explain()\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看索引在排序当中的使用")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.emp.find().sort({"job":-1,"dep":1}).explain()\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"二、mongodb-的主从复制机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、mongodb-的主从复制机制"}},[s._v("#")]),s._v(" 二、mongodb 的主从复制机制")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("知识点：")]),s._v(" "),a("ol",[a("li",[s._v("复制集群的架构")]),s._v(" "),a("li",[s._v("复制集群搭建")]),s._v(" "),a("li",[s._v("复制集群的选举配置")])]),s._v(" "),a("h3",{attrs:{id:"_1-复制集群的架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-复制集群的架构"}},[s._v("#")]),s._v(" 1.复制集群的架构")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://uploader.shimo.im/f/vE8EWLnh5Hkwazap.png!thumbnail",alt:"图片"}})]),s._v(" "),a("h3",{attrs:{id:"_2-复制集群搭建基础示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-复制集群搭建基础示例"}},[s._v("#")]),s._v(" 2.复制集群搭建基础示例")]),s._v(" "),a("p",[s._v("主节点配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dbpath=/data/mongo/master\nport=27017\nfork=true\nlogpath=master.log\nreplSet=tulingCluster\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("从节点配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dbpath=/data/mongo/slave\nport=27018\nfork=true\nlogpath=slave.log\nreplSet=tulingCluster\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("#子节点配置2")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dbpath=/data/mongo/slave2\nport=27019\nfork=true\nlogpath=slave2.log\nreplSet=tulingCluster\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ul",[a("li",[s._v("[ ] 分别启动三个节点")]),s._v(" "),a("li",[s._v("[ ] 进入其中一个节点")])]),s._v(" "),a("p",[s._v("集群复制配置管理")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#查看复制集群的帮助方法\nrs.help()\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("添加配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('// 声明配置变量\nvar cfg ={"_id":"tulingCluster",\n\t\t\t"members":[\n\t\t\t\t{"_id":0,"host":"127.0.0.1:27017"},\n\t\t\t\t{"_id":1,"host":"127.0.0.1:27018"}\n\t\t\t]\n\t\t }\n// 初始化配置\nrs.initiate(cfg)\n// 查看集群状态\nrs.status()\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("变更节点示例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('// 插入新的复制节点\nrs.add("127.0.0.1:27019")\n// 删除slave 节点\nrs.remove("127.0.0.1:27019")\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[s._v("[ ] 演示复制状态\n"),a("ul",[a("li",[s._v("[ ] 进入主节点客户端")]),s._v(" "),a("li",[s._v("[ ] 插入数据")]),s._v(" "),a("li",[s._v("[ ] 进入从节点查看数据")]),s._v(" "),a("li",[s._v("[ ] 尝试在从节点下插入数据")])])])]),s._v(" "),a("p",[s._v("注：默认节点下从节点不能读取数据。调用 rs.slaveOk() 解决。")]),s._v(" "),a("h3",{attrs:{id:"_3-复制集群选举操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-复制集群选举操作"}},[s._v("#")]),s._v(" 3.复制集群选举操作")]),s._v(" "),a("p",[s._v("为了保证高可用，在集群当中如果主节点挂掉后，会自动 在从节点中选举一个 重新做为主节点。")]),s._v(" "),a("ul",[a("li",[s._v("[ ] 演示节点的切换操作\n"),a("ul",[a("li",[s._v("[ ] kill 主节点")]),s._v(" "),a("li",[s._v("[ ] 进入从节点查看集群状态 。rs.status()")])])])]),s._v(" "),a("p",[a("strong",[s._v("选举的原理：")]),s._v("\n在mongodb 中通过在 集群配置中的 rs.属性值大小来决定选举谁做为主节点，通时也可以设置arbiterOnly 为true 表示 做为裁判节点用于执行选举操作，该配置下的节点 永远不会被选举为主节点和从节点。")]),s._v(" "),a("p",[s._v("示例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('重新配置节点\nvar cfg ={"_id":"tulingCluster",\n\t\t  "protocolVersion" : 1,\n\t\t  "members":[\n\t\t\t\t{"_id":0,"host":"127.0.0.1:27017","priority":10},\n\t\t\t\t{"_id":1,"host":"127.0.0.1:27018","priority":2},\n\t\t\t\t{"_id":2,"host":"127.0.0.1:27019","arbiterOnly":true}\n\t\t\t]\n\t\t }\n// 重新装载配置，并重新生成集群节点。\nrs.reconfig(cfg)\n//重新查看集群状态\nrs.status()\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[a("strong",[s._v("节点说明：")]),s._v("\n PRIMARY 节点： 可以查询和新增数据\n SECONDARY 节点：只能查询 不能新增  基于priority 权重可以被选为主节点\n RBITER 节点： 不能查询数据 和新增数据 ，不能变成主节点")]),s._v(" "),a("h2",{attrs:{id:"三、mongodb-中的分片机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、mongodb-中的分片机制"}},[s._v("#")]),s._v(" 三、mongodb 中的分片机制")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("知识点：")]),s._v(" "),a("ol",[a("li",[s._v("分片的概念")]),s._v(" "),a("li",[s._v("mongodb 中的分片架构")]),s._v(" "),a("li",[s._v("分片示例")])]),s._v(" "),a("h3",{attrs:{id:"_1-为什么需要分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么需要分片"}},[s._v("#")]),s._v(" 1.为什么需要分片？")]),s._v(" "),a("p",[s._v("随着数据的增长，单机实例的瓶颈是很明显的。可以通过复制的机制应对压力，但mongodb中单个集群的 节点数量限制到了12个以内，所以需要通过分片进一步横向扩展。此外分片也可节约磁盘的存储。")]),s._v(" "),a("h3",{attrs:{id:"_1-mongodb-中的分片架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-mongodb-中的分片架构"}},[s._v("#")]),s._v(" 1.mongodb 中的分片架构")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://uploader.shimo.im/f/B1mEW0GFMYwPAS47.png!thumbnail",alt:"图片"}})]),s._v(" "),a("p",[a("strong",[s._v("分片中的节点说明：")])]),s._v(" "),a("ul",[a("li",[s._v("路由节点(mongos)：用于分发用户的请求，起到反向代理的作用。")]),s._v(" "),a("li",[s._v("配置节点(config)：用于存储分片的元数据信息，路由节基于元数据信息 决定把请求发给哪个分片。（3.4版本之后，该节点，必须使用复制集。）")]),s._v(" "),a("li",[s._v("分片节点(shard):用于实际存储的节点，其每个数据块默认为64M，满了之后就会产生新的数据库。")])]),s._v(" "),a("h3",{attrs:{id:"_2-分片示例流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-分片示例流程"}},[s._v("#")]),s._v(" "),a("strong",[s._v("2.分片示例流程：")])]),s._v(" "),a("ol",[a("li",[s._v("配置 并启动config 节点集群")]),s._v(" "),a("li",[s._v("配置集群信息")]),s._v(" "),a("li",[s._v("配置并启动2个shard 节点")]),s._v(" "),a("li",[s._v("配置并启动路由节点")]),s._v(" "),a("li",[s._v("添加shard 节点")]),s._v(" "),a("li",[s._v("添加shard  数据库")]),s._v(" "),a("li",[s._v("添加shard 集合")]),s._v(" "),a("li",[s._v("插入测试数据")]),s._v(" "),a("li",[s._v("检查数据的分布")]),s._v(" "),a("li",[s._v("插入大批量数据查看shard 分布")]),s._v(" "),a("li",[s._v("设置shard 数据块为一M")]),s._v(" "),a("li",[s._v("插入10万条数据")])]),s._v(" "),a("p",[a("strong",[s._v("配置 并启动config 节点集群")])]),s._v(" "),a("h1",{attrs:{id:"节点1-config1-37017-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点1-config1-37017-conf"}},[s._v("#")]),s._v(" 节点1 config1-37017.conf")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dbpath=/data/mongo/config1\nport=37017\nfork=true\nlogpath=logs/config1.log\nreplSet=configCluster\nconfigsvr=true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h1",{attrs:{id:"节点2-config2-37018-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点2-config2-37018-conf"}},[s._v("#")]),s._v(" 节点2 config2-37018.conf")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dbpath=/data/mongo/config2\nport=37018\nfork=true\nlogpath=logs/config2.log\nreplSet=configCluster\nconfigsvr=true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("进入shell 并添加 config 集群配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('var cfg ={"_id":"configCluster",\n\t\t  "protocolVersion" : 1,\n\t\t  "members":[\n\t\t\t\t{"_id":0,"host":"127.0.0.1:37017"},\n\t\t\t\t{"_id":1,"host":"127.0.0.1:37018"}\n\t\t\t]\n\t\t }\n// 重新装载配置，并重新生成集群。\nrs.initiate(cfg)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h1",{attrs:{id:"配置-shard-节点集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-shard-节点集群"}},[s._v("#")]),s._v(" 配置 shard 节点集群==============")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 节点1 shard1-47017.conf\ndbpath=/data/mongo/shard1\nport=47017\nfork=true\nlogpath=logs/shard1.log\nshardsvr=true\n\n# 节点2 shard2-47018.conf\ndbpath=/data/mongo/shard2\nport=47018\nfork=true\nlogpath=logs/shard2.log\nshardsvr=true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("配置 路由节点 mongos ==============")]),s._v(" "),a("h1",{attrs:{id:"节点-route-27017-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点-route-27017-conf"}},[s._v("#")]),s._v(" 节点 route-27017.conf")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("port=27017\nbind_ip=0.0.0.0\nfork=true\nlogpath=logs/route.log\nconfigdb=configCluster/127.0.0.1:37017,127.0.0.1:37018\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("// 添加分片节点")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('sh.status()\nsh.addShard("127.0.0.1:47017");\nsh.addShard("127.0.0.1:47018");\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("为数据库开启分片功能")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('sh.enableSharding("tuling")\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("为指定集合开启分片功能")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(' sh.shardCollection("tuling.emp",{"_id":1})\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("修改分片大小")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(' use config\n db.settings.find()\ndb.settings.save({_id:"chunksize",value:1})\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("尝试插入1万条数据：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(' for(var i=1;i<=100000;i++){\n\t\t\t     db.emp.insert({"_id":i,"name":"copy"+i});\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"四、用户管理与数据集验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、用户管理与数据集验证"}},[s._v("#")]),s._v(" 四、用户管理与数据集验证")]),s._v(" "),a("p",[s._v("// 创建管理员用户")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('use admin;\ndb.createUser({"user":"admin","pwd":"123456","roles":["root"]})\n#验证用户信息\ndb.auth("admin","123456")\n#查看用户信息\ndb.getUsers() \n# 修改密码\ndb.changeUserPassword("admin","123456")\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("以auth 方式启动mongod，需要添加auth=true 参数 ，mongdb 的权限体系才会起作用：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#以auth 方向启动mongod （也可以在mongo.conf 中添加auth=true 参数）\n./bin/mongod -f conf/mongo.conf --auth\n# 验证用户\nuse admin;\ndb.auth("admin","123456")\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("创建只读用户")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.createUser({"user":"dev","pwd":"123456","roles":["read"]})\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("重新登陆 验证用户权限")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('use luban  ;\ndb.auth("dev","123456")\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[s._v("[ ] 演示查看数据")]),s._v(" "),a("li",[s._v("[ ] 演示插入数据")])])])}),[],!1,null,null,null);a.default=t.exports}}]);